<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iran Risk Ã— ABS/SM ì›ê°€ ëŒ€ì‘ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: 'Pretendard','Apple SD Gothic Neo',sans-serif; background:#0f172a; color:#e2e8f0; }
    @keyframes pulse-red { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .alert-blink { animation: pulse-red 1.4s ease-in-out infinite; }
    #wti-price { font-size:3.2rem; font-weight:900; letter-spacing:-0.03em; transition:color 0.4s; }
    input[type=range] { -webkit-appearance:none; height:6px; border-radius:3px; background:#334155; outline:none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:20px; border-radius:50%; background:#f59e0b; cursor:pointer; }
    .metric-card { background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:1rem; padding:1.1rem 1.3rem; transition:border-color 0.3s; }
    .metric-card:hover { border-color:rgba(255,255,255,0.2); }
    .scenario-row { background:rgba(255,255,255,0.03); border-radius:0.75rem; padding:0.7rem 1rem; border-left:4px solid transparent; }
    .badge-ok    { background:#065f46; color:#6ee7b7; border-radius:0.4rem; padding:2px 8px; font-size:0.75rem; font-weight:700; }
    .badge-warn  { background:#78350f; color:#fcd34d; border-radius:0.4rem; padding:2px 8px; font-size:0.75rem; font-weight:700; }
    .badge-danger{ background:#7f1d1d; color:#fca5a5; border-radius:0.4rem; padding:2px 8px; font-size:0.75rem; font-weight:700; }
    #toast { position:fixed; top:1.5rem; right:1.5rem; z-index:9999; display:none; background:#7f1d1d; border:1px solid #ef4444; border-radius:0.75rem; padding:1rem 1.5rem; max-width:320px; }
  </style>
</head>
<body class="p-4 md:p-8">

<div id="toast">
  <div class="text-red-400 font-black text-sm mb-1">âš  ABS ë§ˆì§„ ê²½ë³´</div>
  <div id="toast-msg" class="text-white text-sm"></div>
  <button onclick="document.getElementById('toast').style.display='none'" class="mt-2 text-xs text-red-300 underline">ë‹«ê¸°</button>
</div>

<div class="max-w-7xl mx-auto space-y-5">

  <!-- í—¤ë” -->
  <header class="bg-gradient-to-r from-red-950 to-slate-900 p-6 rounded-2xl border border-red-800/40 shadow-2xl">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-2xl md:text-3xl font-black text-yellow-400 tracking-tight">
          ğŸ”´ IRAN CONFLICT Â· ABS/SM COST DASHBOARD
        </h1>
        <p class="text-slate-400 text-sm mt-1">
          LAM Advanced Procurement  |  WTI CL=F ì‹¤ì‹œê°„  |  êµ¬ê¸€ì‹œíŠ¸ ì‹¤ì¸¡ê°€ ìë™ ë°˜ì˜
        </p>
      </div>
      <div class="text-right text-xs text-slate-500 space-y-0.5">
        <div id="update-time">ì—…ë°ì´íŠ¸ ì¤‘...</div>
        <div id="gs-date" class="text-yellow-600"></div>
        <div id="wti-source"></div>
      </div>
    </div>
    <div class="mt-5 flex flex-wrap items-end gap-6">
      <div>
        <div class="text-slate-400 text-xs font-bold tracking-widest uppercase mb-1">WTI Crude Oil (CL=F)</div>
        <div id="wti-price" class="text-yellow-400">$--.-</div>
        <div id="wti-delta" class="text-xs mt-1"></div>
      </div>
      <div class="flex gap-5 pb-2">
        <div>
          <div class="text-xs text-slate-500">ABS Gap</div>
          <div id="hdr-abs-gap" class="text-2xl font-black text-emerald-400">$---</div>
        </div>
        <div>
          <div class="text-xs text-slate-500">SM Margin</div>
          <div id="hdr-sm-margin" class="text-2xl font-black text-red-400">$---</div>
        </div>
      </div>
      <div id="alert-badge" class="pb-2"><span class="badge-warn">ë¡œë”© ì¤‘</span></div>
    </div>
  </header>

  <!-- ì‹¤ì‹œê°„ ì‚°ì¶œê°’ -->
  <section>
    <h2 class="text-slate-400 text-xs font-bold tracking-widest uppercase mb-3">
      ğŸ“¡ ì‹¤ì‹œê°„ ì‚°ì¶œê°’ (êµ¬ê¸€ì‹œíŠ¸ ì‹¤ì¸¡ + WTI ë¸íƒ€ ë³´ì •)
    </h2>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3">
      <div class="metric-card">
        <div class="text-xs text-slate-500 mb-1">WTI ì‹¤ì‹œê°„</div>
        <div id="c-wti" class="text-lg font-black text-yellow-400">--</div>
        <div class="text-xs text-slate-600">$/bbl</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-slate-500 mb-1">Naphtha</div>
        <div id="c-nap" class="text-lg font-black text-slate-300">--</div>
        <div class="text-xs text-slate-600">$/mt MOPJ</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-slate-500 mb-1">BZ FOB Korea</div>
        <div id="c-bz" class="text-lg font-black text-purple-400">--</div>
        <div id="c-bz-act" class="text-xs text-slate-600">ì‹¤ì¸¡ $---</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-slate-500 mb-1">ET CFR NEA</div>
        <div id="c-et" class="text-lg font-black text-green-400">--</div>
        <div id="c-et-act" class="text-xs text-slate-600">ì‹¤ì¸¡ $---</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-slate-500 mb-1">BD CFR China</div>
        <div id="c-bd" class="text-lg font-black text-orange-400">--</div>
        <div id="c-bd-act" class="text-xs text-slate-600">ì‹¤ì¸¡ $---</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-slate-500 mb-1">AN CFR FEA</div>
        <div id="c-an" class="text-lg font-black text-yellow-400">--</div>
        <div id="c-an-act" class="text-xs text-slate-600">ì‹¤ì¸¡ $---</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-slate-500 mb-1">ABS Market</div>
        <div id="c-abs-mkt" class="text-lg font-black text-cyan-400">--</div>
        <div id="c-abs-mkt-act" class="text-xs text-slate-600">ì‹¤ì¸¡ $---</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-slate-500 mb-1">SM Market</div>
        <div id="c-sm-mkt" class="text-lg font-black text-blue-400">--</div>
        <div id="c-sm-act" class="text-xs text-slate-600">ì‹¤ì¸¡ $---</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-slate-500 mb-1">SM Margin</div>
        <div id="c-sm-margin" class="text-lg font-black">--</div>
        <div class="text-xs text-slate-600">ì‹œì¥ê°€-ì›ê°€</div>
      </div>
      <div class="metric-card">
        <div class="text-xs text-slate-500 mb-1">ABS Gap</div>
        <div id="c-abs-gap" class="text-lg font-black text-emerald-400">--</div>
        <div class="text-xs text-slate-600">ì‹œì¥ê°€-ì›ê°€</div>
      </div>
    </div>
  </section>

  <!-- WTI ì‹œë‚˜ë¦¬ì˜¤ ìŠ¬ë¼ì´ë” -->
  <section class="bg-slate-800/60 border border-slate-700 rounded-2xl p-6">
    <h2 class="text-yellow-400 font-black text-sm tracking-widest uppercase mb-4">
      ğŸ› ì´ë€ ì‚¬íƒœ ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´í„°
    </h2>
    <div class="grid md:grid-cols-2 gap-6">
      <div class="space-y-5">
        <div>
          <div class="flex justify-between text-sm mb-2">
            <span class="text-slate-400 font-semibold">WTI ìœ ê°€</span>
            <span class="text-yellow-400 font-black text-lg" id="slider-wti-val">$67.00 /bbl</span>
          </div>
          <input type="range" id="slider-wti" min="50" max="120" step="0.5" value="67" class="w-full" oninput="onSlider()">
          <div class="flex justify-between text-xs text-slate-600 mt-1">
            <span>$50</span><span>$85 í˜¸ë¥´ë¬´ì¦ˆ ìœ„ê¸°</span><span>$120 ë´‰ì‡„</span>
          </div>
        </div>
        <div>
          <div class="flex justify-between text-sm mb-2">
            <span class="text-slate-400 font-semibold">ì´ë€ ë¦¬ìŠ¤í¬ í”„ë¦¬ë¯¸ì—„</span>
            <span class="text-orange-400 font-black text-lg" id="slider-risk-val">+$0 /t</span>
          </div>
          <input type="range" id="slider-risk" min="0" max="300" step="10" value="0" class="w-full" oninput="onSlider()">
          <div class="flex justify-between text-xs text-slate-600 mt-1">
            <span>$0 í‰ì‹œ</span><span>$150 ë¯¸ì‚¬ì¼ íƒ€ê²©</span><span>$300 í˜¸ë¥´ë¬´ì¦ˆ ë´‰ì‡„</span>
          </div>
        </div>
        <div>
          <div class="text-xs text-slate-500 mb-2 font-semibold uppercase tracking-wider">ë¹ ë¥¸ ì‹œë‚˜ë¦¬ì˜¤</div>
          <div class="flex flex-wrap gap-2">
            <button onclick="setScenario(59.44,0)"   class="bg-emerald-900 hover:bg-emerald-800 text-emerald-200 text-xs font-bold px-3 py-1.5 rounded-lg border border-emerald-700 transition">Base $59</button>
            <button onclick="setScenario(70,50)"     class="bg-amber-900   hover:bg-amber-800   text-amber-200   text-xs font-bold px-3 py-1.5 rounded-lg border border-amber-700   transition">Mild $70</button>
            <button onclick="setScenario(80,100)"    class="bg-orange-900  hover:bg-orange-800  text-orange-200  text-xs font-bold px-3 py-1.5 rounded-lg border border-orange-700  transition">Moderate $80</button>
            <button onclick="setScenario(90,150)"    class="bg-red-900     hover:bg-red-800     text-red-200     text-xs font-bold px-3 py-1.5 rounded-lg border border-red-700     transition">Severe $90</button>
            <button onclick="setScenario(100,200)"   class="bg-red-950     hover:bg-red-900     text-red-300     text-xs font-bold px-3 py-1.5 rounded-lg border border-red-800     transition">Crisis $100</button>
          </div>
        </div>
      </div>

      <!-- ì¦‰ì„ ê³„ì‚° ê²°ê³¼ -->
      <div class="bg-slate-900 rounded-xl p-5 border border-slate-700">
        <div class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-4">ì¦‰ì„ ê³„ì‚° ê²°ê³¼</div>
        <div class="space-y-2.5 text-sm">
          <div class="flex justify-between border-b border-slate-700 pb-2">
            <span class="text-slate-400">BZ FOB Korea (ë³´ì •)</span>
            <span id="sim-bz" class="text-purple-400 font-black">$---</span>
          </div>
          <div class="flex justify-between border-b border-slate-700 pb-2">
            <span class="text-slate-400">ET CFR NEA (ë³´ì •)</span>
            <span id="sim-et" class="text-green-400 font-black">$---</span>
          </div>
          <div class="flex justify-between border-b border-slate-700 pb-2">
            <span class="text-slate-400">BD CFR China (ë³´ì •)</span>
            <span id="sim-bd" class="text-orange-400 font-black">$---</span>
          </div>
          <div class="flex justify-between border-b border-slate-700 pb-2">
            <span class="text-slate-400">AN CFR FEA (ë³´ì •)</span>
            <span id="sim-an" class="text-yellow-400 font-black">$---</span>
          </div>
          <div class="flex justify-between border-b border-slate-700 pb-2">
            <span class="text-slate-400">SM Market (ë³´ì •)</span>
            <span id="sim-sm-mkt" class="text-blue-400 font-black">$---</span>
          </div>
          <div class="flex justify-between border-b border-slate-700 pb-2">
            <span class="text-slate-400">SM Cost</span>
            <span id="sim-sm-cost" class="text-red-400 font-black">$---</span>
          </div>
          <div class="flex justify-between border-b border-slate-700 pb-2">
            <span class="text-slate-400">SM Margin</span>
            <span id="sim-sm-margin" class="font-black">$---</span>
          </div>
          <div class="flex justify-between border-b border-slate-700 pb-2">
            <span class="text-slate-400">ABS Market (ë¦¬ìŠ¤í¬ í¬í•¨)</span>
            <span id="sim-abs-mkt" class="text-orange-400 font-black">$---</span>
          </div>
          <div class="flex justify-between border-b border-slate-700 pb-2">
            <span class="text-slate-400">ABS Cost</span>
            <span id="sim-abs-cost" class="text-red-400 font-black">$---</span>
          </div>
          <div class="flex justify-between pt-1">
            <span class="text-white font-black">ABS GAP (ë§ˆì§„)</span>
            <span id="sim-abs-gap" class="font-black text-2xl">$---</span>
          </div>
        </div>
        <div id="strategy-box" class="mt-4 p-3 rounded-lg bg-slate-800 border border-slate-600 text-xs leading-relaxed text-slate-400">
          ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì‘í•˜ì—¬ êµ¬ë§¤ ì „ëµ ì¸ì‚¬ì´íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
        </div>
      </div>
    </div>
  </section>

  <!-- ì‹œë‚˜ë¦¬ì˜¤ í…Œì´ë¸” -->
  <section class="bg-slate-800/40 border border-slate-700 rounded-2xl p-5">
    <h2 class="text-slate-400 text-xs font-bold tracking-widest uppercase mb-4">ğŸ“Š 5ë‹¨ê³„ ì´ë€ ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤</h2>
    <div class="space-y-2" id="scenario-table"></div>
    <div class="mt-3 text-xs text-slate-600">
      * êµ¬ê¸€ì‹œíŠ¸ ì‹¤ì¸¡ ì›ë£Œê°€ ê¸°ë°˜ / WTI ë³€ë™ë¶„ ë¯¼ê°ë„ ì ìš© / ABS Market = SM + $250 ìŠ¤í”„ë ˆë“œ + ë¦¬ìŠ¤í¬ í”„ë¦¬ë¯¸ì—„
    </div>
  </section>

  <!-- ì°¨íŠ¸ -->
  <section class="bg-white/[0.03] border border-white/10 rounded-2xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-slate-300 font-black text-sm uppercase tracking-widest border-l-4 border-red-600 pl-3">
        ğŸ“ˆ VISUALIZED REPORT
      </h2>
      <button onclick="refreshImg()" class="text-xs text-slate-400 border border-slate-700 rounded-lg px-3 py-1.5 hover:bg-slate-700 transition">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <img id="report-img" src="risk_simulation_report.png"
         class="w-full h-auto rounded-xl border border-slate-700"
         onerror="this.style.opacity='0.2'">
  </section>

  <!-- Calculation Logic -->
  <section class="bg-slate-800/30 border border-slate-700 rounded-2xl p-5">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-slate-400 text-xs font-bold tracking-widest uppercase">âš™ Calculation Logic</h2>
      <div id="reg-meta" class="text-xs text-slate-600"></div>
    </div>

    <!-- ì›ê°€ ê³µì‹ -->
    <div class="grid md:grid-cols-2 gap-4 text-xs text-slate-400 leading-loose mb-5">
      <div class="bg-slate-900/60 rounded-xl p-4 border border-slate-700">
        <div class="text-slate-300 font-bold mb-2">SM Cost ê³µì‹</div>
        <div>BZ FOB Korea <span class="text-purple-400 font-bold">Ã— 0.78</span></div>
        <div>+ ET CFR NEA <span class="text-green-400 font-bold">Ã— 0.28</span></div>
        <div>+ Fixed Cost <span class="text-slate-300 font-bold">$45/t</span></div>
        <div class="mt-2 text-slate-500">SM Margin = SM Market âˆ’ SM Cost</div>
      </div>
      <div class="bg-slate-900/60 rounded-xl p-4 border border-slate-700">
        <div class="text-slate-300 font-bold mb-2">ABS Cost ê³µì‹ (ì‹¤ì¸¡ ë°°í•©ë¹„)</div>
        <div>SM CFR China <span class="text-blue-400 font-bold">Ã— 0.60</span></div>
        <div>+ AN CFR FEA <span class="text-yellow-400 font-bold">Ã— 0.25</span></div>
        <div>+ BD CFR China <span class="text-orange-400 font-bold">Ã— 0.15</span></div>
        <div class="mt-2 text-slate-500">ABS Market = êµ¬ê¸€ì‹œíŠ¸ ì‹¤ì¸¡ê°€ + WTI ë¸íƒ€ ë³´ì •</div>
        <div class="text-slate-500">+ Risk Premium (ì´ë€ ì‹œë‚˜ë¦¬ì˜¤)</div>
      </div>
    </div>

    <!-- ìë™ íšŒê·€ê³„ìˆ˜ (CSVì—ì„œ ì‹¤ì‹œê°„ ë°˜ì˜) -->
    <div>
      <div class="text-slate-300 text-xs font-bold mb-3 flex items-center gap-2">
        ğŸ“ˆ WTI ë¯¼ê°ë„ (ìë™ íšŒê·€ê³„ìˆ˜)
        <span class="text-slate-600 font-normal">â€” WTI $1/bbl ë³€ë™ ì‹œ ì›ë£Œê°€ ë³€í™”ëŸ‰ ($/mt)</span>
        <span id="reg-n-badge" class="bg-slate-700 text-slate-300 px-2 py-0.5 rounded text-xs"></span>
      </div>
      <div class="grid grid-cols-3 md:grid-cols-6 gap-3" id="sens-cards">
        <!-- JS ë Œë”ë§ -->
        <div class="bg-slate-900 rounded-lg p-3 border border-slate-700 text-center">
          <div class="text-xs text-purple-400 font-bold mb-1">BZ</div>
          <div id="sens-bz" class="text-lg font-black text-white">---</div>
          <div id="r2-bz"   class="text-xs text-slate-600 mt-1">RÂ²=---</div>
        </div>
        <div class="bg-slate-900 rounded-lg p-3 border border-slate-700 text-center">
          <div class="text-xs text-green-400 font-bold mb-1">ET</div>
          <div id="sens-et" class="text-lg font-black text-white">---</div>
          <div id="r2-et"   class="text-xs text-slate-600 mt-1">RÂ²=---</div>
        </div>
        <div class="bg-slate-900 rounded-lg p-3 border border-slate-700 text-center">
          <div class="text-xs text-blue-400 font-bold mb-1">SM</div>
          <div id="sens-sm" class="text-lg font-black text-white">---</div>
          <div id="r2-sm"   class="text-xs text-slate-600 mt-1">RÂ²=---</div>
        </div>
        <div class="bg-slate-900 rounded-lg p-3 border border-slate-700 text-center">
          <div class="text-xs text-orange-400 font-bold mb-1">BD</div>
          <div id="sens-bd" class="text-lg font-black text-white">---</div>
          <div id="r2-bd"   class="text-xs text-slate-600 mt-1">RÂ²=---</div>
        </div>
        <div class="bg-slate-900 rounded-lg p-3 border border-slate-700 text-center">
          <div class="text-xs text-yellow-400 font-bold mb-1">AN</div>
          <div id="sens-an" class="text-lg font-black text-white">---</div>
          <div id="r2-an"   class="text-xs text-slate-600 mt-1">RÂ²=---</div>
        </div>
        <div class="bg-slate-900 rounded-lg p-3 border border-slate-700 text-center">
          <div class="text-xs text-cyan-400 font-bold mb-1">ABS Mkt</div>
          <div id="sens-abs_mkt" class="text-lg font-black text-white">---</div>
          <div id="r2-abs_mkt"   class="text-xs text-slate-600 mt-1">RÂ²=---</div>
        </div>
      </div>
      <div class="mt-3 text-xs text-slate-600">
        * êµ¬ê¸€ì‹œíŠ¸ ëˆ„ì  ë°ì´í„°ë¡œ ë§¤ì£¼ ìë™ ì¬ê³„ì‚° | RÂ²&lt;0.3 ì€ ê¸°ë³¸ê°’(default) ì‚¬ìš© | ë°ì´í„° 4ì£¼ ë¯¸ë§Œ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
      </div>
    </div>
  </section>

  <footer class="text-center text-slate-700 text-xs pb-4">
    LAM Advanced Procurement Team 1  |  êµ¬ê¸€ì‹œíŠ¸ ì‹¤ì¸¡ê°€ + Yahoo Finance CL=F  |  30ì´ˆ ìë™ê°±ì‹ 
  </footer>

</div>

<script>
// â”€â”€ ìƒíƒœ ì €ì¥ (êµ¬ê¸€ì‹œíŠ¸ ì‹¤ì¸¡ ê¸°ë°˜)
let G = {
  wti_gs: 67.02, wti_rt: 67.02,
  bz: 772.67, et: 710.0, bd: 1270.0, an: 1060.0,
  nap: 637.0, sm_act: 966.5, abs_mkt_act: 1315.0,
};

// â”€â”€ ë¯¼ê°ë„ (ì´ˆê¸°ê°’ = ê¸°ë³¸ê°’, CSV ë¡œë“œ í›„ ìë™ ê°±ì‹ )
let SENS = { bz:9.65, et:-5.41, bd:15.0, an:3.5, sm:20.07, nap:8.5, abs_mkt:7.58 };

// â”€â”€ ABS ë°°í•©ë¹„ (ì‹¤ì¸¡)
const ABS_RATIO = { sm: 0.60, an: 0.25, bd: 0.15 };

// â”€â”€ ìˆ«ì í¬ë§·
function fmt(v, sign=false) {
  if (v===null||v===undefined||isNaN(v)) return '--';
  return (sign&&v>=0?'+':'') + '$' + Math.round(v).toLocaleString();
}

// â”€â”€ WTI ë¸íƒ€ ê¸°ë°˜ ì›ê°€ ê³„ì‚° (ì‹¤ì¸¡ ë°°í•©ë¹„)
function calcFromG(wti, risk=0) {
  const d   = wti - G.wti_gs;
  const bz  = G.bz        + d * SENS.bz;
  const et  = G.et        + d * SENS.et;
  const bd  = G.bd        + d * SENS.bd;
  const an  = G.an        + d * SENS.an;
  const sm  = G.sm_act    + d * SENS.sm;
  const absM= G.abs_mkt_act + d * SENS.abs_mkt + risk;
  // SM Cost
  const smC = bz * 0.78 + et * 0.28 + 45;
  const smM = sm - smC;
  // ABS Cost = SMÃ—0.60 + ANÃ—0.25 + BDÃ—0.15 (ì‹¤ì¸¡ ë°°í•©ë¹„)
  const absC = sm * ABS_RATIO.sm + an * ABS_RATIO.an + bd * ABS_RATIO.bd;
  return { wti, bz, et, bd, an, sm, smC, smM, absC, absM, absG: absM-absC, risk };
}

// â”€â”€ ê²½ë³´ ë±ƒì§€
function alertBadge(absG, smM) {
  if (absG < 0 || smM < -100) return `<span class="badge-danger alert-blink">ğŸ”´ CRITICAL</span>`;
  if (absG < 150)              return `<span class="badge-warn">ğŸŸ¡ WARNING - Gap ${Math.round(absG)}/t</span>`;
  return `<span class="badge-ok">ğŸŸ¢ NORMAL</span>`;
}

// â”€â”€ êµ¬ë§¤ ì „ëµ
function strategy(r) {
  if (r.absG < 0)   return `<span class="text-red-400 font-bold">ğŸ”´ ì—­ë§ˆì§„ ì „í™˜ â€” ì¦‰ì‹œ í˜‘ìƒ ì¬ì¡°ì •. ê³„ì•½ ì—°ì¥ ê¸ˆì§€. ëŒ€ì²´ ê³µê¸‰ì‚¬ ê¸´ê¸‰ ë°œêµ´.</span>`;
  if (r.absG < 100) return `<span class="text-orange-400 font-bold">ğŸŸ  GAP ìœ„í—˜ â€” ë‹¨ê°€ ì¸í•˜ ìš”ì²­ or íŒë§¤ê°€ ì¸ìƒ. ì¬ê³  ì¶•ì†Œ ê²€í† .</span>`;
  if (r.absG < 200) return `<span class="text-yellow-400">ğŸŸ¡ GAP ì¶•ì†Œ â€” ì ì • ì¬ê³  ìœ ì§€. WTI $80 ëŒíŒŒ ì‹œ ì¦‰ì‹œ ì¬í‰ê°€.</span>`;
  if (r.smM < 0)    return `<span class="text-blue-400">ğŸ”µ SM ì—­ë§ˆì§„ â€” ë©”ì´ì»¤ ê°ì‚° â†’ ìˆ˜ê¸‰ íƒ€ì´íŠ¸ ì˜ˆìƒ. ì„ ì œ ì¬ê³  í™•ë³´ ê²€í† .</span>`;
  return `<span class="text-emerald-400">ğŸŸ¢ ì •ìƒ ë²”ìœ„ â€” í˜„í–‰ êµ¬ë§¤ ì „ëµ ìœ ì§€.</span>`;
}

// â”€â”€ ì‹œë‚˜ë¦¬ì˜¤ í…Œì´ë¸”
const SCENARIOS = [
  {label:'Base',     wti:59.44, risk:0,   color:'#10b981'},
  {label:'Mild',     wti:70,    risk:50,  color:'#f59e0b'},
  {label:'Moderate', wti:80,    risk:100, color:'#f97316'},
  {label:'Severe',   wti:90,    risk:150, color:'#ef4444'},
  {label:'Crisis',   wti:100,   risk:200, color:'#b91c1c'},
];

function renderScenarios() {
  document.getElementById('scenario-table').innerHTML = SCENARIOS.map(s => {
    const r = calcFromG(s.wti, s.risk);
    const gc = r.absG < 0 ? '#ef4444' : r.absG < 150 ? '#f59e0b' : '#10b981';
    const sc = r.smM  < 0 ? '#ef4444' : '#10b981';
    return `<div class="scenario-row" style="border-left-color:${s.color}">
      <div class="flex flex-wrap items-center gap-3 text-sm">
        <span class="font-black w-20" style="color:${s.color}">${s.label}</span>
        <span class="text-slate-400 w-16">WTI <b class="text-white">$${s.wti}</b></span>
        <span class="text-slate-400 w-20">Risk <b class="text-orange-400">+$${s.risk}</b></span>
        <span class="text-slate-400 w-28">BZ <b class="text-purple-300">${fmt(r.bz)}</b></span>
        <span class="text-slate-400 w-28">SM <b class="text-blue-300">${fmt(r.sm)}</b></span>
        <span class="text-slate-400 w-32">ABS Mkt <b class="text-blue-200">${fmt(r.absM)}</b></span>
        <span class="text-slate-400 w-32">ABS Cost <b class="text-red-300">${fmt(r.absC)}</b></span>
        <span class="w-32">ABS Gap <b style="color:${gc}" class="font-black">${fmt(r.absG,true)}</b></span>
        <span class="w-28">SM Margin <b style="color:${sc}">${fmt(r.smM,true)}</b></span>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ ìŠ¬ë¼ì´ë”
function onSlider() {
  const wti  = parseFloat(document.getElementById('slider-wti').value);
  const risk = parseFloat(document.getElementById('slider-risk').value);
  document.getElementById('slider-wti-val').textContent  = `$${wti.toFixed(2)} /bbl`;
  document.getElementById('slider-risk-val').textContent = `+$${risk} /t`;

  const r = calcFromG(wti, risk);
  document.getElementById('sim-bz').textContent      = fmt(r.bz);
  document.getElementById('sim-et').textContent      = fmt(r.et);
  document.getElementById('sim-bd').textContent      = fmt(r.bd);
  document.getElementById('sim-an').textContent      = fmt(r.an);
  document.getElementById('sim-abs-mkt').textContent = fmt(r.absM);
  document.getElementById('sim-sm-mkt').textContent  = fmt(r.sm);
  document.getElementById('sim-sm-cost').textContent = fmt(r.smC);

  const smEl = document.getElementById('sim-sm-margin');
  smEl.textContent = fmt(r.smM, true);
  smEl.className   = 'font-black ' + (r.smM < 0 ? 'text-red-400' : 'text-emerald-400');

  document.getElementById('sim-abs-mkt').textContent  = fmt(r.absM);
  document.getElementById('sim-abs-cost').textContent = fmt(r.absC);

  const gEl = document.getElementById('sim-abs-gap');
  gEl.textContent = fmt(r.absG, true);
  gEl.className   = 'font-black text-2xl ' + (r.absG < 0 ? 'text-red-500 alert-blink' : r.absG < 150 ? 'text-yellow-400' : 'text-emerald-400');

  document.getElementById('strategy-box').innerHTML = strategy(r);
}

function setScenario(wti, risk) {
  document.getElementById('slider-wti').value  = wti;
  document.getElementById('slider-risk').value = risk;
  onSlider();
}

// â”€â”€ CSV ë¡œë“œ
function loadCSV() {
  Papa.parse('simulation_result.csv?t=' + Date.now(), {
    download: true, header: true, skipEmptyLines: true,
    complete: function(res) {
      if (!res.data || !res.data.length) return;
      const d = res.data[0];

      // G ìƒíƒœ ì—…ë°ì´íŠ¸
      G.wti_rt      = parseFloat(d.WTI)          || G.wti_rt;
      G.wti_gs      = parseFloat(d.WTI_GSheet)   || G.wti_gs;
      G.bz          = parseFloat(d.BZ_Actual)    || G.bz;
      G.et          = parseFloat(d.ET_Actual)    || G.et;
      G.bd          = parseFloat(d.BD_Actual)    || G.bd;
      G.an          = parseFloat(d.AN_Actual)    || G.an;
      G.nap         = parseFloat(d.NAP)          || G.nap;
      G.sm_act      = parseFloat(d.SM_Actual)    || G.sm_act;
      G.abs_mkt_act = parseFloat(d.ABS_Mkt_Actual) || G.abs_mkt_act;

      // í—¤ë”
      document.getElementById('wti-price').textContent = `$${G.wti_rt.toFixed(2)}`;
      const delta = G.wti_rt - G.wti_gs;
      document.getElementById('wti-delta').innerHTML =
        `<span class="${delta>=0?'text-red-400':'text-green-400'}">êµ¬ê¸€ì‹œíŠ¸ ëŒ€ë¹„ ${delta>=0?'+':''}${delta.toFixed(2)}</span>`;

      // ì¹´ë“œ
      document.getElementById('c-wti').textContent  = `$${G.wti_rt.toFixed(2)}`;
      document.getElementById('c-nap').textContent  = `$${Math.round(G.nap)}`;

      const rt = calcFromG(G.wti_rt, 0);
      document.getElementById('c-bz').textContent     = fmt(rt.bz);
      document.getElementById('c-bz-act').textContent = `ì‹¤ì¸¡ $${Math.round(G.bz)}`;
      document.getElementById('c-et').textContent     = fmt(rt.et);
      document.getElementById('c-et-act').textContent = `ì‹¤ì¸¡ $${Math.round(G.et)}`;
      document.getElementById('c-bd').textContent         = fmt(rt.bd);
      document.getElementById('c-bd-act').textContent     = `ì‹¤ì¸¡ $${Math.round(G.bd)}`;
      document.getElementById('c-an').textContent         = fmt(rt.an);
      document.getElementById('c-an-act').textContent     = `ì‹¤ì¸¡ $${Math.round(G.an)}`;
      document.getElementById('c-abs-mkt').textContent    = fmt(rt.absM);
      document.getElementById('c-abs-mkt-act').textContent= `ì‹¤ì¸¡ $${Math.round(G.abs_mkt_act)}`;
      document.getElementById('c-sm-mkt').textContent     = fmt(rt.sm);
      document.getElementById('c-sm-act').textContent     = `ì‹¤ì¸¡ $${Math.round(G.sm_act)}`;

      const smEl = document.getElementById('c-sm-margin');
      smEl.textContent = fmt(rt.smM, true);
      smEl.className   = 'text-lg font-black ' + (rt.smM < 0 ? 'text-red-400' : 'text-emerald-400');

      const gEl = document.getElementById('c-abs-gap');
      gEl.textContent = fmt(rt.absG, true);
      gEl.className   = 'text-lg font-black ' + (rt.absG < 0 ? 'text-red-500 alert-blink' : rt.absG < 150 ? 'text-yellow-400' : 'text-emerald-400');

      document.getElementById('hdr-abs-gap').textContent   = fmt(rt.absG, true);
      document.getElementById('hdr-sm-margin').textContent = fmt(rt.smM, true);
      document.getElementById('alert-badge').innerHTML     = alertBadge(rt.absG, rt.smM);

      document.getElementById('update-time').textContent = 'ê°±ì‹ : ' + (d.UpdateTime || '');
      document.getElementById('gs-date').textContent     = 'êµ¬ê¸€ì‹œíŠ¸: ' + (d.GSheet_Date || '');
      document.getElementById('wti-source').textContent  = d.WTI_Source || '';

      // â”€â”€ ìë™ íšŒê·€ê³„ìˆ˜ ì¹´ë“œ ì—…ë°ì´íŠ¸
      function setSensCard(id, sensVal, r2Val) {
        const el   = document.getElementById('sens-' + id);
        const r2el = document.getElementById('r2-'   + id);
        if (!el) return;
        const v = parseFloat(sensVal);
        if (!isNaN(v)) {
          el.textContent = (v >= 0 ? '+' : '') + v.toFixed(2);
          el.className   = 'text-lg font-black ' + (v < 0 ? 'text-green-400' : 'text-yellow-300');
        }
        if (r2el) {
          const r2 = parseFloat(r2Val);
          if (!isNaN(r2)) {
            r2el.textContent = 'RÂ²=' + r2.toFixed(2);
            r2el.className   = 'text-xs mt-1 ' + (r2 >= 0.5 ? 'text-emerald-500' : r2 >= 0.3 ? 'text-yellow-600' : 'text-red-700');
          } else {
            r2el.textContent = 'default';
            r2el.className   = 'text-xs mt-1 text-slate-600';
          }
        }
      }
      // ë¯¼ê°ë„ SENS ê°ì²´ë„ CSVê°’ìœ¼ë¡œ ê°±ì‹  (ìŠ¬ë¼ì´ë” ê³„ì‚°ì— ë°˜ì˜)
      if (d.Sens_BZ)      { SENS.bz      = parseFloat(d.Sens_BZ);      setSensCard('bz',      d.Sens_BZ,      d.R2_BZ);      }
      if (d.Sens_ET)      { SENS.et      = parseFloat(d.Sens_ET);      setSensCard('et',      d.Sens_ET,      d.R2_ET);      }
      if (d.Sens_SM)      { SENS.sm      = parseFloat(d.Sens_SM);      setSensCard('sm',      d.Sens_SM,      d.R2_SM);      }
      if (d.Sens_BD)      { SENS.bd      = parseFloat(d.Sens_BD);      setSensCard('bd',      d.Sens_BD,      d.R2_BD);      }
      if (d.Sens_AN)      { SENS.an      = parseFloat(d.Sens_AN);      setSensCard('an',      d.Sens_AN,      d.R2_AN);      }
      if (d.Sens_NAP)     { SENS.nap     = parseFloat(d.Sens_NAP);     setSensCard('nap',     d.Sens_NAP,     d.R2_NAP);     }
      if (d.Sens_ABS_MKT) { SENS.abs_mkt = parseFloat(d.Sens_ABS_MKT); setSensCard('abs_mkt', d.Sens_ABS_MKT, d.R2_ABS_MKT); }

      // íšŒê·€ ë©”íƒ€ í‘œì‹œ
      if (d.Reg_N) {
        document.getElementById('reg-n-badge').textContent = d.Reg_N + 'ì£¼ ë°ì´í„°';
        document.getElementById('reg-meta').textContent    = 'ìµœì¢… ê°±ì‹ : ' + (d.UpdateTime || '');
      }

      // ìŠ¬ë¼ì´ë” ë™ê¸°í™”
      document.getElementById('slider-wti').value = G.wti_rt.toFixed(2);
      onSlider();
      renderScenarios();

      // í† ìŠ¤íŠ¸
      if (rt.absG < 150) {
        document.getElementById('toast-msg').textContent =
          `ABS Gap ${fmt(rt.absG, true)} â€” ëª©í‘œ($150) ${Math.round(150-rt.absG)} ë¶€ì¡±`;
        document.getElementById('toast').style.display = 'block';
      }
    },
    error: function() {
      document.getElementById('update-time').textContent = 'CSV ë¡œë“œ ì‹¤íŒ¨ - Actions ì‹¤í–‰ ëŒ€ê¸°';
    }
  });
}

function refreshImg() {
  document.getElementById('report-img').src = 'risk_simulation_report.png?t=' + Date.now();
}

// â”€â”€ ì´ˆê¸°í™”
renderScenarios();
onSlider();
loadCSV();
setInterval(loadCSV,   30000);
setInterval(refreshImg, 300000);
</script>
</body>
</html>
