<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LAM ì„ìœ í™”í•™ ì›ê°€ ëŒ€ì‹œë³´ë“œ v6.4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    body { font-family: 'Pretendard','Apple SD Gothic Neo',sans-serif; background:#ddeef9; color:#1e293b; }
    @keyframes pulse-red { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .alert-blink { animation: pulse-red 1.4s ease-in-out infinite; }
    input[type=range] { -webkit-appearance:none; height:6px; border-radius:3px; background:#cbd5e1; outline:none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:20px; border-radius:50%; background:#f59e0b; cursor:pointer; }
    input[type=range].green-thumb::-webkit-slider-thumb { background:#10b981; }
    input[type=range].red-thumb::-webkit-slider-thumb   { background:#ef4444; }
    input[type=range].blue-thumb::-webkit-slider-thumb  { background:#3b82f6; }
    .metric-card { background:#eaf5fd; border:1px solid #bdd9ef; border-radius:1rem; padding:1rem 1.2rem; transition:border-color 0.3s; }
    .metric-card:hover { border-color:#94a3b8; }
    .scenario-row { background:#e2f0fb; border-radius:0.75rem; padding:0.65rem 1rem; border-left:4px solid transparent; }
    .badge-ok    { background:#d1fae5; color:#065f46; border-radius:.4rem; padding:2px 8px; font-size:.75rem; font-weight:700; }
    .badge-warn  { background:#fef3c7; color:#92400e; border-radius:.4rem; padding:2px 8px; font-size:.75rem; font-weight:700; }
    .badge-danger{ background:#fee2e2; color:#991b1b; border-radius:.4rem; padding:2px 8px; font-size:.75rem; font-weight:700; }
    .cracker-positive { background:linear-gradient(135deg,#ecfdf5,#d1fae5); border:1px solid #059669; }
    .cracker-negative { background:linear-gradient(135deg,#fff1f2,#fee2e2); border:1px solid #dc2626; }
    .cracker-warn     { background:linear-gradient(135deg,#fffbeb,#fef3c7); border:1px solid #d97706; }
    .tab-btn { padding:.5rem 1.2rem; border-radius:.5rem; font-size:.8rem; font-weight:700; cursor:pointer; transition:all .2s; border:1px solid #cbd5e1; color:#475569; }
    .tab-btn.active { background:#2563eb; color:white; border-color:#1d4ed8; }

  </style>
</head>
<body class="p-4 md:p-6">



<div class="max-w-7xl mx-auto space-y-4">

  <!-- â•â• í—¤ë” â•â• -->
  <header class="bg-gradient-to-r from-blue-800 to-slate-700 p-5 rounded-2xl border border-blue-300 shadow-2xl">
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-black text-yellow-300 tracking-tight">
          ğŸ”µ IRAN RISK Â· ABS/SM + í¬ë˜ì»¤ë§ˆì§„ ëŒ€ì‹œë³´ë“œ
          <span class="text-sm text-blue-300 ml-2">v6.4</span>
        </h1>
        <p class="text-slate-300 text-xs mt-1">
          LAM Advanced Procurement  |  WTI CL=F ì‹¤ì‹œê°„  |  êµ¬ê¸€ì‹œíŠ¸ ì‹¤ì¸¡ì•µì»¤
          <span class="text-orange-400 ml-2 font-bold">â˜… í¬ë˜ì»¤ë§ˆì§„â†’BDíƒ€ì´íŠ¸ ìë™ë°˜ì˜ | ìˆ˜ê¸‰ì‹ í˜¸ 4ì¢… ë³‘ê¸°</span>
        </p>
      </div>
      <div class="text-right text-xs text-slate-300 space-y-0.5 shrink-0">
        <div id="update-time">ë¡œë”© ì¤‘...</div>
        <div id="gs-date" class="text-yellow-600"></div>
        <div id="wti-source"></div>
      </div>
    </div>

    <!-- í—¤ë” KPI -->
    <div class="mt-4 grid grid-cols-3 md:grid-cols-6 gap-3">
      <div class="text-center">
        <div class="text-xs text-slate-300 mb-1">WTI</div>
        <div id="hdr-wti" class="text-2xl font-black text-yellow-400">$--</div>
      </div>
      <div class="text-center">
        <div class="text-xs text-slate-300 mb-1">í¬ë˜ì»¤ë§ˆì§„</div>
        <div id="hdr-cracker" class="text-2xl font-black">$--</div>
        <div class="text-xs text-slate-300">ETÃ—0.30+...</div>
      </div>
      <div class="text-center">
        <div class="text-xs text-orange-500 mb-1 font-bold">BD íƒ€ì´íŠ¸í”„ë¦¬ë¯¸ì—„</div>
        <div id="hdr-bd-tight" class="text-2xl font-black text-orange-400">+$--</div>
      </div>
      <div class="text-center">
        <div class="text-xs text-slate-300 mb-1">SM Margin ì‹¤ì¸¡</div>
        <div id="hdr-sm-margin" class="text-2xl font-black">$--</div>
      </div>
      <div class="text-center">
        <div class="text-xs text-slate-300 mb-1">ABS Gap ì‹¤ì¸¡</div>
        <div id="hdr-abs-gap" class="text-2xl font-black text-emerald-400">$--</div>
      </div>
      <div class="text-center">
        <div id="alert-badge"><span class="badge-warn">ë¡œë”©ì¤‘</span></div>
        <div id="hdr-abs-gap-theory" class="text-lg font-black text-yellow-400 mt-1">ì´ë¡  $--</div>
      </div>
    </div>
  </header>

  <!-- â•â• v6.4 ë¡œì§ ë°°ë„ˆ â•â• -->
  <div class="bg-sky-100/70 border border-orange-200 rounded-xl p-3 text-xs leading-relaxed">
    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <span class="text-orange-700 font-black">â˜… v6.4 í¬ë˜ì»¤ë§ˆì§„â†’BD íƒ€ì´íŠ¸ ë¡œì§:</span>
        <div class="text-slate-700 mt-1">
          í¬ë˜ì»¤ë§ˆì§„ = ETÃ—0.30 + PRÃ—0.15 + BDÃ—0.045 + BZÃ—0.06 - NAP - $50<br>
          BDíƒ€ì´íŠ¸í”„ë¦¬ë¯¸ì—„ = min(max(0, -(ë§ˆì§„ë³€í™”)) Ã— 0.5, 150)<br>
          <span class="text-orange-700">ET ì•½ì„¸ â†’ í¬ë˜ì»¤ ì ì â†’ ê°€ë™ë¥ â†“ â†’ BD ê³µê¸‰â†“ â†’ BD íƒ€ì´íŠ¸</span>
        </div>
      </div>
      <div>
        <span class="text-blue-700 font-black">â˜… ìˆ˜ê¸‰ì‹ í˜¸ 4ì¢…:</span>
        <div class="text-slate-700 mt-1">
          â‘  SM Margin ì‹¤ì¸¡ (SM - ì‹¤ì¸¡ì›ê°€) â€” í˜„ì¬ SM í‘ì ì<br>
          â‘¡ SM Margin ì´ë¡  (SM - ì´ë¡ ì›ê°€) â€” ë©”ì´ì»¤ ê°ì‚° íŠ¸ë¦¬ê±°<br>
          â‘¢ ABS Gap ì‹¤ì¸¡ (ABS Mkt - ì‹¤ì¸¡Cost) â€” êµ¬ë§¤ì í•µì‹¬<br>
          â‘£ ABS Gap ì´ë¡  (ABS Mkt - ì´ë¡ Cost) â€” ì´ë¡  ê¸°ì¤€ ë§ˆì§„
        </div>
      </div>
    </div>
  </div>

  <!-- â•â• íƒ­ â•â• -->
  <div class="flex gap-2 flex-wrap">
    <button class="tab-btn active" onclick="showTab('tab-main',this)">ğŸ“Š ë©”ì¸ ëŒ€ì‹œë³´ë“œ</button>
    <button class="tab-btn" onclick="showTab('tab-wti',this)">ğŸš WTI ì‹œë®¬ë ˆì´í„°</button>
    <button class="tab-btn" onclick="showTab('tab-cracker',this)">âš— í¬ë˜ì»¤ë§ˆì§„ ì‹œë®¬ë ˆì´í„°</button>
    <button class="tab-btn" onclick="showTab('tab-scenario',this)">ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤ í…Œì´ë¸”</button>
    <button class="tab-btn" onclick="showTab('tab-chart',this)">ğŸ“ˆ ì°¨íŠ¸</button>
    <button class="tab-btn" onclick="showTab('tab-sens',this)">âš™ ë¯¼ê°ë„</button>
    <button class="tab-btn" onclick="showTab('tab-forecast',this)">ğŸ“… ì‚¬ì „ì›ê°€ ì˜ˆì¸¡</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       íƒ­1: ë©”ì¸ ëŒ€ì‹œë³´ë“œ
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-main">
    <!-- ì›ë£Œ ì¹´ë“œ -->
    <div class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-10 gap-2 mb-3">
      <div class="metric-card"><div class="text-xs text-slate-700 mb-1">WTI</div><div id="c-wti" class="text-lg font-black text-amber-700">--</div><div class="text-xs text-slate-700">$/bbl</div></div>
      <div class="metric-card"><div class="text-xs text-slate-700 mb-1">NAP</div><div id="c-nap" class="text-lg font-black text-slate-700">--</div><div class="text-xs text-slate-700">$/mt</div></div>
      <div class="metric-card"><div class="text-xs text-slate-700 mb-1">BZ</div><div id="c-bz" class="text-lg font-black text-purple-700">--</div><div id="c-bz-act" class="text-xs text-slate-700">ì‹¤ì¸¡ $---</div></div>
      <div class="metric-card border border-green-200"><div class="text-xs text-green-700 mb-1 font-bold">ET â˜…</div><div id="c-et" class="text-lg font-black text-green-700">--</div><div id="c-et-act" class="text-xs text-slate-700">ì‹¤ì¸¡ $---</div></div>
      <div class="metric-card border border-orange-300"><div class="text-xs text-orange-700 mb-1 font-bold">BD â˜…íƒ€ì´íŠ¸</div><div id="c-bd" class="text-lg font-black text-orange-700">--</div><div id="c-bd-tight" class="text-xs text-orange-600">+$0 í”„ë¦¬ë¯¸ì—„</div></div>
      <div class="metric-card"><div class="text-xs text-slate-700 mb-1">AN</div><div id="c-an" class="text-lg font-black text-violet-700">--</div><div id="c-an-act" class="text-xs text-slate-700">ì‹¤ì¸¡ $---</div></div>
      <div class="metric-card"><div class="text-xs text-cyan-700 mb-1">PR</div><div id="c-pr" class="text-lg font-black text-cyan-700">--</div><div id="c-pr-act" class="text-xs text-slate-700">ì‹¤ì¸¡ $---</div></div>
      <div class="metric-card"><div class="text-xs text-slate-700 mb-1">SM Market</div><div id="c-sm-mkt" class="text-lg font-black text-blue-700">--</div><div id="c-sm-act" class="text-xs text-slate-700">ì‹¤ì¸¡ $---</div></div>
      <div class="metric-card"><div class="text-xs text-slate-700 mb-1">ABS Market</div><div id="c-abs-mkt" class="text-lg font-black text-blue-700">--</div><div id="c-abs-mkt-act" class="text-xs text-slate-700">ì‹¤ì¸¡ $---</div></div>
      <div class="metric-card"><div class="text-xs text-slate-700 mb-1">BZ Korea-ARA</div><div id="c-bz-spread" class="text-lg font-black text-fuchsia-700">--</div><div class="text-xs text-slate-700">ìŠ¤í”„ë ˆë“œ</div></div>
    </div>

    <!-- í¬ë˜ì»¤ ë§ˆì§„ íŒ¨ë„ -->
    <div id="cracker-panel" class="rounded-xl p-4 mb-3 cracker-negative">
      <div class="flex flex-col md:flex-row md:items-center gap-4">
        <div class="text-center md:text-left">
          <div class="text-xs text-slate-700 font-bold uppercase tracking-widest mb-1">âš— ë‚˜í”„íƒ€ í¬ë˜ì»¤ ë§ˆì§„</div>
          <div id="cracker-margin-val" class="text-4xl font-black">$--</div>
          <div class="text-xs text-slate-700 mt-1">ETÃ—0.30 + PRÃ—0.15 + BDÃ—0.045 + BZÃ—0.06 - NAP - $50</div>
        </div>
        <div class="flex-1 grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
          <div class="bg-sky-100/80 rounded-lg p-2 text-center">
            <div class="text-slate-700">ET ê¸°ì—¬</div>
            <div id="cr-et-contrib" class="font-black text-green-700">$--</div>
          </div>
          <div class="bg-sky-100/80 rounded-lg p-2 text-center">
            <div class="text-slate-700">PR ê¸°ì—¬</div>
            <div id="cr-pr-contrib" class="font-black text-cyan-700">$--</div>
          </div>
          <div class="bg-sky-100/80 rounded-lg p-2 text-center">
            <div class="text-slate-700">BD+BZ ê¸°ì—¬</div>
            <div id="cr-bd-contrib" class="font-black text-orange-700">$--</div>
          </div>
          <div class="bg-sky-100/80 rounded-lg p-2 text-center">
            <div class="text-slate-700">NAP ë¹„ìš©</div>
            <div id="cr-nap-cost" class="font-black text-red-700">$--</div>
          </div>
        </div>
        <div class="text-center bg-sky-50/90 rounded-xl px-5 py-3">
          <div class="text-xs text-orange-700 font-bold mb-1">BD íƒ€ì´íŠ¸ í”„ë¦¬ë¯¸ì—„</div>
          <div id="cr-bd-tight-big" class="text-3xl font-black text-orange-700">+$--</div>
          <div class="text-xs text-slate-700 mt-1">í¬ë˜ì»¤ë§ˆì§„ ì•…í™” ë°˜ì˜</div>
          <div class="text-xs text-slate-600 mt-1">ê¸°ì¤€(4ì£¼í‰ê· ): <span id="cr-base-margin" class="font-bold text-slate-700">$--</span></div>
        </div>
      </div>
      <div id="cracker-insight" class="mt-3 text-xs text-slate-700 border-t border-white/10 pt-3"></div>
    </div>

    <!-- ìˆ˜ê¸‰ì‹ í˜¸ 4ì¢… -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
      <div class="metric-card border border-green-200">
        <div class="text-xs text-green-700 font-bold mb-1">â‘  SM Margin ì‹¤ì¸¡</div>
        <div id="sig-sm-act" class="text-2xl font-black">--</div>
        <div class="text-xs text-slate-700 mt-1">SM - ì‹¤ì¸¡ì›ê°€</div>
        <div id="sig-sm-act-sub" class="text-xs text-slate-700 mt-0.5"></div>
      </div>
      <div class="metric-card border border-yellow-900/50">
        <div class="text-xs text-amber-700 font-bold mb-1">â‘¡ SM Margin ì´ë¡ </div>
        <div id="sig-sm-th" class="text-2xl font-black">--</div>
        <div class="text-xs text-slate-700 mt-1">SM - ì´ë¡ ì›ê°€ (BZÃ—0.80)</div>
        <div id="sig-sm-th-sub" class="text-xs text-slate-700 mt-0.5">ë©”ì´ì»¤ ê°ì‚° íŠ¸ë¦¬ê±°</div>
      </div>
      <div class="metric-card border border-emerald-800/80">
        <div class="text-xs text-emerald-700 font-bold mb-1">â‘¢ ABS Gap ì‹¤ì¸¡</div>
        <div id="sig-abs-act" class="text-2xl font-black">--</div>
        <div class="text-xs text-slate-700 mt-1">ABS Mkt - ì‹¤ì¸¡Cost</div>
        <div id="sig-abs-act-sub" class="text-xs text-slate-700 mt-0.5">êµ¬ë§¤ì í•µì‹¬ ì§€í‘œ</div>
      </div>
      <div class="metric-card border border-blue-900/50">
        <div class="text-xs text-blue-700 font-bold mb-1">â‘£ ABS Gap ì´ë¡ </div>
        <div id="sig-abs-th" class="text-2xl font-black">--</div>
        <div class="text-xs text-slate-700 mt-1">ABS Mkt - ì´ë¡ Cost</div>
        <div id="sig-abs-th-sub" class="text-xs text-slate-700 mt-0.5">ì´ë¡  ê¸°ì¤€ ë§ˆì§„</div>
      </div>
    </div>

    <!-- BZ ìŠ¤í”„ë ˆë“œ -->
    <div class="bg-sky-50/90 border border-purple-800/40 rounded-xl p-4">
      <div class="text-purple-700 text-xs font-bold uppercase tracking-widest mb-3">ğŸŒ BZ ê¸€ë¡œë²Œ ìŠ¤í”„ë ˆë“œ</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        <div class="bg-slate-50 rounded-xl p-3 border border-purple-200">
          <div class="text-xs text-purple-700 font-bold mb-2">Korea vs ARA</div>
          <div class="flex justify-between mb-1"><span class="text-slate-700">BZ FOB Korea</span><span id="sp-bz-k" class="text-purple-700 font-black">$---</span></div>
          <div class="flex justify-between mb-1"><span class="text-slate-700">BZ CIF ARA</span><span id="sp-bz-ara" class="text-indigo-700 font-black">$---</span></div>
          <div class="flex justify-between pt-2 border-t border-slate-200"><span class="font-bold">Spread</span><span id="sp-bz-spread-ara" class="font-black text-fuchsia-700">$---</span></div>
        </div>
        <div class="bg-slate-50 rounded-xl p-3 border border-amber-200">
          <div class="text-xs text-amber-300 font-bold mb-2">Korea vs USG</div>
          <div class="flex justify-between mb-1"><span class="text-slate-700">BZ FOB Korea</span><span id="sp-bz-k2" class="text-purple-700 font-black">$---</span></div>
          <div class="flex justify-between mb-1"><span class="text-slate-700">BZ USG ($/mt)</span><span id="sp-bz-usg" class="text-amber-400 font-black">$---</span></div>
          <div class="flex justify-between pt-2 border-t border-slate-200"><span class="font-bold">Spread</span><span id="sp-bz-spread-usg" class="font-black text-amber-400">$---</span></div>
        </div>
        <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
          <div class="text-xs text-slate-700 font-bold mb-2">ìŠ¤í”„ë ˆë“œ í•´ì„</div>
          <div id="bz-insight" class="text-xs text-slate-700 leading-relaxed">ë¡œë“œ ì¤‘...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       íƒ­2: WTI ì‹œë®¬ë ˆì´í„°
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-wti" class="hidden">
    <div class="bg-sky-50/90 border border-slate-200 rounded-2xl p-5">
      <h2 class="text-slate-700 text-xs font-bold uppercase tracking-widest mb-4">ğŸš ì¸í„°ë™í‹°ë¸Œ WTI ì‹œë®¬ë ˆì´í„° v6.4</h2>

      <!-- ë¦¬ìŠ¤í¬ WTI ë“±ê°€ ë°°ë„ˆ -->
      <div id="risk-equiv-bar" class="mb-4 p-3 rounded-lg bg-yellow-950/40 border border-yellow-200 text-xs text-amber-700 hidden">
        <span class="font-black">ë¦¬ìŠ¤í¬ WTI ë“±ê°€:</span>
        <span id="risk-equiv-val" class="text-slate-800 font-black mx-2">+$0/bbl</span>
        â†’ BZ +<span id="risk-bz">$0</span> | ET +<span id="risk-et">$0</span> | BD +<span id="risk-bd">$0</span> | AN +<span id="risk-an">$0</span>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <!-- ìŠ¬ë¼ì´ë” -->
        <div class="space-y-5">
          <div>
            <div class="flex justify-between items-center mb-2">
              <label class="text-sm text-slate-700 font-bold">WTI ìœ ê°€</label>
              <span id="wti-slider-val" class="text-amber-700 font-black text-lg">$67.00/bbl</span>
            </div>
            <input type="range" id="slider-wti" min="40" max="120" step="0.5" value="67" class="w-full" oninput="onWtiSlider()">
            <div class="flex justify-between text-xs text-slate-700 mt-1"><span>$40</span><span>$60</span><span>$80</span><span>$100</span><span>$120</span></div>
          </div>
          <div>
            <div class="flex justify-between items-center mb-2">
              <label class="text-sm text-slate-700 font-bold">ì´ë€ ë¦¬ìŠ¤í¬ í”„ë¦¬ë¯¸ì—„</label>
              <span id="risk-slider-val" class="text-red-700 font-black text-lg">+$0/t</span>
            </div>
            <input type="range" id="slider-risk" min="0" max="300" step="10" value="0" class="w-full red-thumb" oninput="onWtiSlider()">
            <div class="flex justify-between text-xs text-slate-700 mt-1"><span>Base</span><span>+$75</span><span>+$150</span><span>+$225</span><span>+$300</span></div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button onclick="setWtiScenario(59.44,0)"  class="text-xs bg-emerald-900/60 text-emerald-700 border border-emerald-700 rounded-lg px-3 py-1.5 hover:bg-emerald-800 transition">Base $59</button>
            <button onclick="setWtiScenario(70,50)"    class="text-xs bg-amber-900/60   text-amber-400   border border-amber-700   rounded-lg px-3 py-1.5 hover:bg-amber-800   transition">Mild $70</button>
            <button onclick="setWtiScenario(80,100)"   class="text-xs bg-orange-900/60  text-orange-700  border border-orange-700  rounded-lg px-3 py-1.5 hover:bg-orange-800  transition">Moderate $80</button>
            <button onclick="setWtiScenario(90,150)"   class="text-xs bg-red-900/60     text-red-700     border border-red-700     rounded-lg px-3 py-1.5 hover:bg-red-800     transition">Severe $90</button>
            <button onclick="setWtiScenario(100,200)"  class="text-xs bg-red-950/80     text-red-700     border border-red-900     rounded-lg px-3 py-1.5 hover:bg-red-900     transition">Crisis $100</button>
          </div>
        </div>

        <!-- ê²°ê³¼ -->
        <div class="space-y-1.5 text-sm">
          <div class="grid grid-cols-3 gap-1.5 mb-2">
            <div class="flex justify-between border-b border-slate-200 pb-1"><span class="text-slate-700 text-xs">BZ</span><span id="wsim-bz" class="text-purple-700 font-black text-sm">$---</span></div>
            <div class="flex justify-between border-b border-slate-200 pb-1"><span class="text-slate-700 text-xs">ET</span><span id="wsim-et" class="text-green-700 font-black text-sm">$---</span></div>
            <div class="flex justify-between border-b border-slate-200 pb-1"><span class="text-orange-700 text-xs font-bold">BDâ˜…</span><span id="wsim-bd" class="text-orange-700 font-black text-sm">$---</span></div>
            <div class="flex justify-between border-b border-slate-200 pb-1"><span class="text-slate-700 text-xs">AN</span><span id="wsim-an" class="text-violet-700 font-black text-sm">$---</span></div>
            <div class="flex justify-between border-b border-slate-200 pb-1"><span class="text-cyan-700 text-xs">PR</span><span id="wsim-pr" class="text-cyan-700 font-black text-sm">$---</span></div>
            <div class="flex justify-between border-b border-slate-200 pb-1"><span class="text-slate-700 text-xs">SM</span><span id="wsim-sm" class="text-blue-700 font-black text-sm">$---</span></div>
          </div>
          <div class="bg-orange-50 border border-orange-300 rounded-lg px-3 py-2">
            <div class="flex justify-between"><span class="text-orange-700 text-xs font-bold">í¬ë˜ì»¤ë§ˆì§„</span><span id="wsim-cracker" class="font-black">$---</span></div>
            <div class="flex justify-between"><span class="text-orange-700 text-xs">BD íƒ€ì´íŠ¸í”„ë¦¬ë¯¸ì—„</span><span id="wsim-bd-tight" class="font-black text-orange-700">+$---</span></div>
          </div>
          <div class="flex justify-between border-b border-slate-200 pb-1"><span class="text-slate-700 text-xs">SM Cost ì‹¤ì¸¡</span><span id="wsim-sm-cost" class="text-red-700 font-black text-sm">$---</span></div>
          <div class="flex justify-between border-b border-slate-200 pb-1"><span class="text-amber-800 text-xs">SM Cost ì´ë¡ </span><span id="wsim-sm-cost-th" class="text-amber-700 font-black text-sm">$---</span></div>
          <div class="grid grid-cols-2 gap-2">
            <div class="bg-sky-50 rounded-lg p-2 text-center">
              <div class="text-xs text-slate-700">SM Margin ì‹¤ì¸¡ â‘ </div>
              <div id="wsim-sm-margin" class="font-black text-lg">$---</div>
            </div>
            <div class="bg-sky-50 rounded-lg p-2 text-center">
              <div class="text-xs text-slate-700">SM Margin ì´ë¡  â‘¡</div>
              <div id="wsim-sm-margin-th" class="font-black text-lg">$---</div>
            </div>
          </div>
          <div class="flex justify-between border-b border-slate-200 pb-1"><span class="text-slate-700 text-xs">ABS Market</span><span id="wsim-abs-mkt" class="text-blue-700 font-black text-sm">$---</span></div>
          <div class="flex justify-between border-b border-slate-200 pb-1"><span class="text-slate-700 text-xs">ABS Cost</span><span id="wsim-abs-cost" class="text-red-700 font-black text-sm">$---</span></div>
          <div class="grid grid-cols-2 gap-2">
            <div class="bg-sky-50 rounded-lg p-2 text-center">
              <div class="text-xs text-slate-700">ABS Gap ì‹¤ì¸¡ â‘¢</div>
              <div id="wsim-abs-gap" class="font-black text-2xl">$---</div>
            </div>
            <div class="bg-sky-50 rounded-lg p-2 text-center">
              <div class="text-xs text-slate-700">ABS Gap ì´ë¡  â‘£</div>
              <div id="wsim-abs-gap-th" class="font-black text-xl text-amber-700">$---</div>
            </div>
          </div>
          <div id="wti-strategy" class="p-3 rounded-lg bg-sky-50 border border-slate-300 text-xs mt-1"></div>
        </div>
      </div>
    </div>

    <!-- â•â• WTI ì‹œë®¬ë ˆì´í„° ì°¨íŠ¸ íŒ¨ë„ â•â• -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div>
          <h3 class="text-slate-700 font-black text-sm">ğŸ“Š WTI ì‹œë®¬ë ˆì´ì…˜ ì°¨íŠ¸</h3>
          <p class="text-xs text-slate-600 mt-0.5">ìŠ¬ë¼ì´ë” ì¡°ì‘ ì‹œ ì‹¤ì‹œê°„ ë°˜ì˜</p>
        </div>
        <!-- ì°¨íŠ¸ íƒ€ì… ì „í™˜ -->
        <div class="flex gap-2 flex-wrap items-center">
          <span class="text-xs text-slate-700 font-bold">ì°¨íŠ¸:</span>
          <button onclick="setWtiChartMode('radar')"  id="wct-radar"  class="wct-btn text-xs px-2 py-1 rounded border font-bold transition bg-slate-700 text-white border-slate-600">ë¯¼ê°ë„</button>
          <button onclick="setWtiChartMode('bar')"    id="wct-bar"    class="wct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300">ë³€ë™í­</button>
          <button onclick="setWtiChartMode('donut')"  id="wct-donut"  class="wct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300">ì›ê°€ë¹„ì¤‘</button>
          <button onclick="setWtiChartMode('gauge')"  id="wct-gauge"  class="wct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300">ê°­ê²Œì´ì§€</button>
          <span class="text-xs text-slate-600 mx-1">|</span>
          <!-- í’ˆëª© í† ê¸€ (ë ˆì´ë”/ë³€ë™í­ ëª¨ë“œìš©) -->
          <span class="text-xs text-slate-700 font-bold">í’ˆëª©:</span>
          <button onclick="toggleWtiItem('NAP')" id="wi-NAP" class="wi-btn text-xs px-2 py-1 rounded border font-bold transition bg-slate-100 text-slate-700 border-slate-300">NAP</button>
          <button onclick="toggleWtiItem('BZ')"  id="wi-BZ"  class="wi-btn text-xs px-2 py-1 rounded border font-bold transition bg-purple-100 text-purple-700 border-purple-300">BZ</button>
          <button onclick="toggleWtiItem('ET')"  id="wi-ET"  class="wi-btn text-xs px-2 py-1 rounded border font-bold transition bg-emerald-100 text-emerald-700 border-emerald-300">ET</button>
          <button onclick="toggleWtiItem('BD')"  id="wi-BD"  class="wi-btn text-xs px-2 py-1 rounded border font-bold transition bg-orange-100 text-orange-700 border-orange-300">BD</button>
          <button onclick="toggleWtiItem('AN')"  id="wi-AN"  class="wi-btn text-xs px-2 py-1 rounded border font-bold transition bg-violet-100 text-violet-700 border-violet-300">AN</button>
          <button onclick="toggleWtiItem('SM')"  id="wi-SM"  class="wi-btn text-xs px-2 py-1 rounded border font-bold transition bg-blue-100 text-blue-700 border-blue-300">SM</button>
        </div>
      </div>

      <!-- ì°¨íŠ¸ ìº”ë²„ìŠ¤ -->
      <div class="relative" style="height:320px">
        <canvas id="wti-sim-chart"></canvas>
      </div>

      <!-- ê°­ê²Œì´ì§€ ëª¨ë“œ: ë³„ë„ ë Œë” -->
      <div id="wti-gauge-panel" class="hidden mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- ABS Gap ê²Œì´ì§€ -->
        <div class="bg-white rounded-xl border border-slate-200 p-4 text-center">
          <div class="text-xs text-slate-700 font-bold mb-2">ABS Gap ì‹¤ì¸¡ ì¡´</div>
          <div id="gauge-abs-zone" class="text-3xl font-black mb-1">--</div>
          <div id="gauge-abs-bar" class="w-full h-4 rounded-full bg-slate-200 overflow-hidden mt-2">
            <div id="gauge-abs-fill" class="h-full rounded-full transition-all duration-500" style="width:0%"></div>
          </div>
          <div class="flex justify-between text-xs text-slate-600 mt-1"><span>ì—­ë§ˆì§„</span><span>ê´€ë§</span><span>ë§¤ìˆ˜</span></div>
          <div id="gauge-abs-val" class="text-lg font-black mt-2">$---</div>
        </div>
        <!-- SM Margin ê²Œì´ì§€ -->
        <div class="bg-white rounded-xl border border-slate-200 p-4 text-center">
          <div class="text-xs text-slate-700 font-bold mb-2">SM Margin ì‹¤ì¸¡</div>
          <div id="gauge-sm-zone" class="text-3xl font-black mb-1">--</div>
          <div id="gauge-sm-bar" class="w-full h-4 rounded-full bg-slate-200 overflow-hidden mt-2">
            <div id="gauge-sm-fill" class="h-full rounded-full transition-all duration-500" style="width:0%"></div>
          </div>
          <div class="flex justify-between text-xs text-slate-600 mt-1"><span>ì ì</span><span>ê· í˜•</span><span>í‘ì</span></div>
          <div id="gauge-sm-val" class="text-lg font-black mt-2">$---</div>
        </div>
        <!-- í¬ë˜ì»¤ë§ˆì§„ ê²Œì´ì§€ -->
        <div class="bg-white rounded-xl border border-slate-200 p-4 text-center">
          <div class="text-xs text-slate-700 font-bold mb-2">í¬ë˜ì»¤ë§ˆì§„ ì¡´</div>
          <div id="gauge-cr-zone" class="text-3xl font-black mb-1">--</div>
          <div id="gauge-cr-bar" class="w-full h-4 rounded-full bg-slate-200 overflow-hidden mt-2">
            <div id="gauge-cr-fill" class="h-full rounded-full transition-all duration-500" style="width:0%"></div>
          </div>
          <div class="flex justify-between text-xs text-slate-600 mt-1"><span>ì ì</span><span>BEP</span><span>í‘ì</span></div>
          <div id="gauge-cr-val" class="text-lg font-black mt-2">$---</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       íƒ­3: í¬ë˜ì»¤ ë§ˆì§„ ì‹œë®¬ë ˆì´í„° â˜… v6.4 ì‹ ê·œ
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-cracker" class="hidden">
    <div class="bg-sky-50/90 border border-orange-200 rounded-2xl p-5">
      <div class="flex items-center justify-between mb-1">
        <h2 class="text-orange-700 text-xs font-bold uppercase tracking-widest">âš— ë‚˜í”„íƒ€ í¬ë˜ì»¤ ë§ˆì§„ ì‹œë®¬ë ˆì´í„° v6.4</h2>
        <button onclick="resetCrackerSliders()" class="text-xs bg-blue-700 hover:bg-blue-800 text-white font-bold px-3 py-1.5 rounded-lg transition flex items-center gap-1">
          ğŸ”„ í˜„ì¬ê°€ë¡œ ì´ˆê¸°í™”
        </button>
      </div>
      <p class="text-slate-700 text-xs mb-4">
        í¬ë˜ì»¤ë§ˆì§„ = ETÃ—0.30 + PRÃ—0.15 + BDÃ—0.045 + BZÃ—0.06 - NAP - $50
        | í¬ë˜ì»¤ë§ˆì§„ ì•…í™” â†’ BD íƒ€ì´íŠ¸ í”„ë¦¬ë¯¸ì—„ ìë™ ê³„ì‚° â†’ ABS Cost ë°˜ì˜
      </p>

      <div class="grid md:grid-cols-2 gap-6">
        <!-- í¬ë˜ì»¤ ìŠ¬ë¼ì´ë” -->
        <div class="space-y-4">
          <!-- ET ìŠ¬ë¼ì´ë” -->
          <div class="bg-green-50 border border-green-200 rounded-xl p-4">
            <div class="flex justify-between items-center mb-2">
              <label class="text-sm text-green-700 font-black">ET (ì—í‹¸ë Œ) CFR NEA</label>
              <span id="cr-et-val" class="text-green-700 font-black text-lg">$710/mt</span>
            </div>
            <input type="range" id="cr-slider-et" min="300" max="1200" step="10" value="710" class="w-full green-thumb" oninput="onCrackerSlider()">
            <div class="flex justify-between text-xs text-slate-700 mt-1"><span>$300</span><span>$600</span><span>$900</span><span>$1200</span></div>
            <div class="text-xs text-green-700 mt-1">í˜„ì¬ ì‹¤ì¸¡: <span id="cr-et-actual" class="text-green-500">$710</span></div>
          </div>

          <!-- NAP ìŠ¬ë¼ì´ë” -->
          <div class="bg-sky-50 border border-slate-300 rounded-xl p-4">
            <div class="flex justify-between items-center mb-2">
              <label class="text-sm text-slate-700 font-black">NAP (ë‚˜í”„íƒ€) C+F Japan</label>
              <span id="cr-nap-val" class="text-slate-700 font-black text-lg">$637/mt</span>
            </div>
            <input type="range" id="cr-slider-nap" min="400" max="1000" step="10" value="637" class="w-full" oninput="onCrackerSlider()">
            <div class="flex justify-between text-xs text-slate-700 mt-1"><span>$400</span><span>$600</span><span>$800</span><span>$1000</span></div>
            <div class="text-xs text-slate-700 mt-1">í˜„ì¬ ì‹¤ì¸¡: <span id="cr-nap-actual" class="text-slate-700">$637</span></div>
          </div>

          <!-- PR ìŠ¬ë¼ì´ë” -->
          <div class="bg-cyan-50 border border-cyan-200 rounded-xl p-4">
            <div class="flex justify-between items-center mb-2">
              <label class="text-sm text-cyan-700 font-bold">PR (í”„ë¡œí•„ë Œ) CFR China</label>
              <span id="cr-pr-val" class="text-cyan-700 font-black text-lg">$870/mt</span>
            </div>
            <input type="range" id="cr-slider-pr" min="400" max="1200" step="10" value="870" class="w-full blue-thumb" oninput="onCrackerSlider()">
            <div class="flex justify-between text-xs text-slate-700 mt-1"><span>$400</span><span>$700</span><span>$1000</span><span>$1200</span></div>
          </div>

          <!-- BZ ìŠ¬ë¼ì´ë” (í¬ë˜ì»¤ìš©) -->
          <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
            <div class="flex justify-between items-center mb-2">
              <label class="text-sm text-purple-700 font-bold">BZ (ë²¤ì  ) FOB Korea</label>
              <span id="cr-bz-val" class="text-purple-700 font-black text-lg">$772/mt</span>
            </div>
            <input type="range" id="cr-slider-bz" min="400" max="1500" step="10" value="772" class="w-full" oninput="onCrackerSlider()">
            <div class="flex justify-between text-xs text-slate-700 mt-1"><span>$400</span><span>$800</span><span>$1200</span><span>$1500</span></div>
          </div>

          <!-- BD ìŠ¬ë¼ì´ë” -->
          <div class="bg-orange-50 border border-orange-300 rounded-xl p-4">
            <div class="flex justify-between items-center mb-2">
              <label class="text-sm text-orange-700 font-bold">BD (ë¶€íƒ€ë””ì—”) CFR China</label>
              <span id="cr-bd-val" class="text-orange-700 font-black text-lg">$1270/mt</span>
            </div>
            <input type="range" id="cr-slider-bd" min="600" max="2500" step="10" value="1270" class="w-full red-thumb" oninput="onCrackerSlider()">
            <div class="flex justify-between text-xs text-slate-700 mt-1"><span>$600</span><span>$1300</span><span>$2000</span><span>$2500</span></div>
            <div class="text-xs text-orange-700 mt-1">í¬ë˜ì»¤ë§ˆì§„ ì•…í™” ì‹œ ìë™ íƒ€ì´íŠ¸í”„ë¦¬ë¯¸ì—„ ë°˜ì˜</div>
          </div>

          <button onclick="resetCrackerSliders()" class="text-xs bg-slate-700 text-slate-700 border border-slate-300 rounded-lg px-4 py-2 hover:bg-slate-600 transition w-full">â†º ì‹¤ì¸¡ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
        </div>

        <!-- í¬ë˜ì»¤ ê²°ê³¼ íŒ¨ë„ -->
        <div class="space-y-3">
          <!-- í¬ë˜ì»¤ ë§ˆì§„ ëŒ€í˜• í‘œì‹œ -->
          <div id="cr-result-panel" class="rounded-2xl p-5 border text-center">
            <div class="text-xs text-slate-700 uppercase tracking-widest mb-2">ë‚˜í”„íƒ€ í¬ë˜ì»¤ ë§ˆì§„</div>
            <div id="cr-margin-big" class="text-5xl font-black mb-1">$--</div>
            <div id="cr-margin-label" class="text-sm font-bold">ê³„ì‚° ì¤‘...</div>
          </div>

          <!-- ìˆ˜ìœ¨ë³„ ê¸°ì—¬ ë¶„í•´ -->
          <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
            <div class="text-xs text-slate-700 font-bold mb-3 uppercase tracking-widest">ìˆ˜ìœ¨ë³„ ìˆ˜ìµ ë¶„í•´</div>
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <span class="text-xs text-green-700 w-24">ET Ã—0.30</span>
                <div class="flex-1 bg-sky-50 rounded-full h-4 overflow-hidden">
                  <div id="cr-bar-et" class="h-full bg-green-500 transition-all duration-300" style="width:0%"></div>
                </div>
                <span id="cr-val-et" class="text-xs text-green-700 w-16 text-right font-black">$--</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-cyan-700 w-24">PR Ã—0.15</span>
                <div class="flex-1 bg-sky-50 rounded-full h-4 overflow-hidden">
                  <div id="cr-bar-pr" class="h-full bg-cyan-500 transition-all duration-300" style="width:0%"></div>
                </div>
                <span id="cr-val-pr" class="text-xs text-cyan-700 w-16 text-right font-black">$--</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-orange-700 w-24">BD Ã—0.045</span>
                <div class="flex-1 bg-sky-50 rounded-full h-4 overflow-hidden">
                  <div id="cr-bar-bd" class="h-full bg-orange-500 transition-all duration-300" style="width:0%"></div>
                </div>
                <span id="cr-val-bd" class="text-xs text-orange-700 w-16 text-right font-black">$--</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-purple-700 w-24">BZ Ã—0.06</span>
                <div class="flex-1 bg-sky-50 rounded-full h-4 overflow-hidden">
                  <div id="cr-bar-bz" class="h-full bg-purple-500 transition-all duration-300" style="width:0%"></div>
                </div>
                <span id="cr-val-bz" class="text-xs text-purple-700 w-16 text-right font-black">$--</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-red-700 w-24">NAP (ë¹„ìš©)</span>
                <div class="flex-1 bg-sky-50 rounded-full h-4 overflow-hidden">
                  <div id="cr-bar-nap" class="h-full bg-red-500 transition-all duration-300" style="width:0%"></div>
                </div>
                <span id="cr-val-nap" class="text-xs text-red-700 w-16 text-right font-black">$--</span>
              </div>
              <div class="border-t border-slate-200 pt-2 flex justify-between">
                <span class="text-xs text-slate-800 font-bold">í•©ê³„ (í¬ë˜ì»¤ë§ˆì§„)</span>
                <span id="cr-val-total" class="text-sm font-black">$--</span>
              </div>
            </div>
          </div>

          <!-- BD íƒ€ì´íŠ¸ í”„ë¦¬ë¯¸ì—„ & ABS ì˜í–¥ -->
          <div class="bg-orange-50 border border-orange-300 rounded-xl p-4">
            <div class="text-xs text-orange-700 font-bold uppercase tracking-widest mb-3">BD íƒ€ì´íŠ¸ â†’ ABS Cost ì˜í–¥</div>
            <div class="grid grid-cols-2 gap-3 text-xs">
              <div class="bg-sky-100/80 rounded-lg p-2 text-center">
                <div class="text-slate-700">í¬ë˜ì»¤ë§ˆì§„ ë³€í™”</div>
                <div id="cr-margin-delta" class="font-black text-lg">$--</div>
              </div>
              <div class="bg-sky-100/80 rounded-lg p-2 text-center">
                <div class="text-orange-700 font-bold">BD íƒ€ì´íŠ¸í”„ë¦¬ë¯¸ì—„</div>
                <div id="cr-bd-prem" class="font-black text-lg text-orange-700">+$--</div>
              </div>
              <div class="bg-sky-100/80 rounded-lg p-2 text-center">
                <div class="text-slate-700">BD (ê¸°ì¤€)</div>
                <div id="cr-bd-base" class="font-black text-lg">$--</div>
              </div>
              <div class="bg-sky-100/80 rounded-lg p-2 text-center">
                <div class="text-orange-700 font-bold">BD (íƒ€ì´íŠ¸í›„)</div>
                <div id="cr-bd-final" class="font-black text-lg text-orange-700">$--</div>
              </div>
            </div>
            <!-- ABS Cost/Gap ì˜í–¥ -->
            <div class="mt-3 border-t border-orange-300 pt-3 grid grid-cols-3 gap-2 text-xs text-center">
              <div>
                <div class="text-slate-700">ABS Cost</div>
                <div id="cr-abs-cost" class="font-black text-red-700">$--</div>
              </div>
              <div>
                <div class="text-emerald-700 font-bold">ABS Gap ì‹¤ì¸¡</div>
                <div id="cr-abs-gap" class="font-black text-xl">$--</div>
              </div>
              <div>
                <div class="text-amber-700">ABS Gap ì´ë¡ </div>
                <div id="cr-abs-gap-th" class="font-black text-amber-700">$--</div>
              </div>
            </div>
          </div>

          <!-- ì „ëµ ì¸ì‚¬ì´íŠ¸ -->
          <div id="cracker-strategy" class="p-3 rounded-lg bg-sky-50 border border-slate-300 text-xs leading-relaxed"></div>

          <!-- ê°ì‚° ì„ê³„ ë¶„ì„ -->
          <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
            <div class="text-xs text-slate-700 font-bold mb-3 uppercase">í¬ë˜ì»¤ ê°ì‚° ì„ê³„ ë¶„ì„</div>
            <div class="space-y-1.5 text-xs">
              <div class="flex justify-between">
                <span class="text-slate-700">í˜„ì¬ í¬ë˜ì»¤ë§ˆì§„</span>
                <span id="cr-thresh-current" class="font-black">$--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-700">ê°ì‚° íŠ¸ë¦¬ê±° (ë§ˆì§„=0)</span>
                <span class="text-red-700 font-bold">$0/t</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-700">ì†ìµë¶„ê¸° ET ê°€ê²© (í˜„ì¬ NAP ê¸°ì¤€)</span>
                <span id="cr-break-et" class="font-black text-amber-700">$--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-700">í˜„ì¬ ET ëŒ€ë¹„ ì¶”ê°€ í•˜ë½ ì—¬ìœ </span>
                <span id="cr-et-room" class="font-black">$--</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• 9ì£¼ í¬ë˜ì»¤ë§ˆì§„ ëˆ„ì  ê¸°ì—¬ë„ ì°¨íŠ¸ â•â• -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div>
          <h3 class="text-slate-700 font-black text-sm">ğŸ“Š í¬ë˜ì»¤ë§ˆì§„ ì£¼ê°„ ê¸°ì—¬ë„ ì¶”ì´ (9ì£¼)</h3>
          <p class="text-xs text-slate-600 mt-0.5">ETÂ·PRÂ·BDÂ·BZ ìˆ˜ìµ ê¸°ì—¬ vs NAP ë¹„ìš© â€” ë§‰ëŒ€ ë†’ì´ê°€ ë§ˆì§„ êµ¬ì¡°ë¥¼ ë‚˜íƒ€ëƒ„</p>
        </div>
        <div class="flex gap-3 text-xs flex-wrap">
          <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded" style="background:#10b981"></span>ET ê¸°ì—¬</span>
          <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded" style="background:#3b82f6"></span>PR ê¸°ì—¬</span>
          <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded" style="background:#f97316"></span>BD ê¸°ì—¬</span>
          <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded" style="background:#a855f7"></span>BZ ê¸°ì—¬</span>
          <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded" style="background:#ef4444"></span>NAP ë¹„ìš©</span>
          <span class="flex items-center gap-1"><span class="inline-block w-4 border-t-2 border-dashed border-slate-600"></span>ìˆœë§ˆì§„</span>
        </div>
      </div>
      <div class="relative" style="height:300px">
        <canvas id="cracker-history-chart"></canvas>
      </div>
      <div class="mt-3 grid grid-cols-3 md:grid-cols-9 gap-2 text-xs" id="cracker-history-summary"></div>
    </div>
  </div>
  </div>
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-scenario" class="hidden">
    <div class="bg-sky-50/90 border border-slate-200 rounded-2xl p-5">
      <h2 class="text-slate-700 text-xs font-bold uppercase tracking-widest mb-4">ğŸ“‹ 5ë‹¨ê³„ ì´ë€ ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤ v6.4</h2>
      <div id="scenario-table" class="space-y-2"></div>
      <div class="mt-3 text-xs text-slate-700">â˜… BD = WTI íšŒê·€ + í¬ë˜ì»¤ë§ˆì§„ì•…í™” íƒ€ì´íŠ¸í”„ë¦¬ë¯¸ì—„ | ìˆ˜ê¸‰ì‹ í˜¸ 4ì¢… ë³‘ê¸°</div>
    </div>

    <!-- â•â• ì‹œë‚˜ë¦¬ì˜¤ íˆíŠ¸ë§µ í…Œì´ë¸” â•â• -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div>
          <h3 class="text-slate-700 font-black text-sm">ğŸŒ¡ ì‹œë‚˜ë¦¬ì˜¤ íˆíŠ¸ë§µ â€” ê°’ì— ë”°ë¥¸ ìƒ‰ìƒ ë“±ê¸‰</h3>
          <p class="text-xs text-slate-600 mt-0.5">ì…€ ìƒ‰ìƒ: ğŸŸ¢ ì¢‹ìŒ Â· ğŸŸ¡ ì£¼ì˜ Â· ğŸ”´ ìœ„í—˜</p>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-xs border-collapse" id="scenario-heatmap"></table>
      </div>
    </div>

    <!-- â•â• ì‹œë‚˜ë¦¬ì˜¤ ì°¨íŠ¸ íŒ¨ë„ â•â• -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div>
          <h3 class="text-slate-700 font-black text-sm">ğŸ“ˆ ì‹œë‚˜ë¦¬ì˜¤ë³„ ì°¨íŠ¸</h3>
          <p class="text-xs text-slate-600 mt-0.5">WTI êµ¬ê°„ë³„ ì£¼ìš” ì§€í‘œ ì‹œê°í™”</p>
        </div>
        <div class="flex gap-2 flex-wrap items-center">
          <!-- ì°¨íŠ¸ íƒ€ì… -->
          <span class="text-xs text-slate-700 font-bold">ì°¨íŠ¸:</span>
          <button onclick="setScChartMode('gap')"    id="sct-gap"    class="sct-btn text-xs px-2 py-1 rounded border font-bold transition bg-slate-700 text-white border-slate-600">ABS Gapì¡´</button>
          <button onclick="setScChartMode('cost')"   id="sct-cost"   class="sct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300">ì›ê°€êµ¬ì¡°</button>
          <button onclick="setScChartMode('margin')" id="sct-margin" class="sct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300">ë§ˆì§„ë¹„êµ</button>
          <button onclick="setScChartMode('cracker')"id="sct-cracker"class="sct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300">í¬ë˜ì»¤</button>
          <span class="text-xs text-slate-600 mx-1">|</span>
          <!-- í’ˆëª© í† ê¸€ -->
          <span class="text-xs text-slate-700 font-bold">í’ˆëª©:</span>
          <button onclick="toggleScItem('absGap')"  id="si-absGap"  class="si-btn text-xs px-2 py-1 rounded border font-bold transition bg-emerald-100 text-emerald-700 border-emerald-300">ABS Gap</button>
          <button onclick="toggleScItem('smMargin')"id="si-smMargin"class="si-btn text-xs px-2 py-1 rounded border font-bold transition bg-blue-100 text-blue-700 border-blue-300">SM Margin</button>
          <button onclick="toggleScItem('cracker')" id="si-cracker" class="si-btn text-xs px-2 py-1 rounded border font-bold transition bg-orange-100 text-orange-700 border-orange-300">í¬ë˜ì»¤ë§ˆì§„</button>
          <button onclick="toggleScItem('bdTight')" id="si-bdTight" class="si-btn text-xs px-2 py-1 rounded border font-bold transition bg-red-100 text-red-700 border-red-300">BDíƒ€ì´íŠ¸</button>
        </div>
      </div>
      <div class="relative" style="height:320px">
        <canvas id="scenario-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       íƒ­5: ì°¨íŠ¸
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-chart" class="hidden">
    <div class="bg-sky-100/30 border border-sky-200/40 rounded-2xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-slate-700 font-black text-sm uppercase tracking-widest border-l-4 border-blue-600 pl-3">ğŸ“ˆ REPORT (9íŒ¨ë„ v6.4)</h2>
        <button onclick="refreshImg()" class="text-xs text-slate-700 border border-slate-200 rounded-lg px-3 py-1.5 hover:bg-slate-700 transition">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <img id="report-img" src="risk_simulation_report.png" class="w-full h-auto rounded-xl border border-slate-200" onerror="this.style.opacity='0.2'">
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       íƒ­6: ë¯¼ê°ë„
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-sens" class="hidden">
    <div class="bg-sky-50/60 border border-slate-200 rounded-2xl p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-slate-700 text-xs font-bold uppercase tracking-widest">âš™ WTI ë¯¼ê°ë„ & í¬ë˜ì»¤ íŒŒë¼ë¯¸í„°</h2>
        <div id="reg-meta" class="text-xs text-slate-700"></div>
      </div>
      <div class="grid md:grid-cols-2 gap-4 mb-5 text-xs text-slate-700 leading-loose">
        <div class="bg-slate-50 rounded-xl p-4 border border-orange-200">
          <div class="text-orange-700 font-bold mb-2">â˜… v6.4 í¬ë˜ì»¤ë§ˆì§„â†’BD ê³µì‹</div>
          <div>í¬ë˜ì»¤ë§ˆì§„ = ETÃ—0.30 + PRÃ—0.15 + BDÃ—0.045 + BZÃ—0.06 - NAP - $50</div>
          <div class="text-orange-700">BDíƒ€ì´íŠ¸ = min(max(0,-(ë§ˆì§„-ê¸°ì¤€ë§ˆì§„))Ã—0.5, 150)</div>
          <div class="text-slate-700 mt-1">ê¸°ì¤€ë§ˆì§„ = CRACKER_HISTORY ìµœê·¼ 4ì£¼ í‰ê·  (êµ¬ì¡°ì  ìˆ˜ê¸‰ ìˆ˜ì¤€ ë°˜ì˜)</div>
        </div>
        <div class="bg-slate-50 rounded-xl p-4 border border-purple-200">
          <div class="text-purple-700 font-bold mb-2">ì›ê°€ ê³µì‹</div>
          <div class="text-red-700">SM Cost ì‹¤ì¸¡: BZÃ—0.67 + ETÃ—0.25 + NAPÃ—0.05 + 150</div>
          <div class="text-amber-700">SM Cost ì´ë¡ : BZÃ—0.80 + ETÃ—0.30 + 150</div>
          <div class="text-red-700 mt-1">ABS Cost: SMÃ—0.60 + ANÃ—0.25 + BDÃ—0.15</div>
          <div class="text-slate-700">BDì— íƒ€ì´íŠ¸í”„ë¦¬ë¯¸ì—„ í¬í•¨</div>
        </div>
      </div>
      <div class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-2">
        <div class="bg-slate-50 rounded-lg p-2 border border-slate-300 text-center"><div class="text-xs text-slate-700 font-bold mb-1">NAP</div><div id="sens-nap" class="text-lg font-black text-slate-800">--</div><div id="r2-nap" class="text-xs text-slate-700">RÂ²=--</div></div>
        <div class="bg-slate-50 rounded-lg p-2 border border-slate-200 text-center"><div class="text-xs text-purple-700 font-bold mb-1">BZ</div><div id="sens-bz" class="text-lg font-black text-slate-800">--</div><div id="r2-bz" class="text-xs text-slate-700">RÂ²=--</div></div>
        <div class="bg-slate-50 rounded-lg p-2 border border-slate-200 text-center"><div class="text-xs text-green-700 font-bold mb-1">ET</div><div id="sens-et" class="text-lg font-black text-slate-800">--</div><div id="r2-et" class="text-xs text-slate-700">RÂ²=--</div></div>
        <div class="bg-slate-50 rounded-lg p-2 border border-slate-200 text-center"><div class="text-xs text-blue-700 font-bold mb-1">SM</div><div id="sens-sm" class="text-lg font-black text-slate-800">--</div><div id="r2-sm" class="text-xs text-slate-700">RÂ²=--</div></div>
        <div class="bg-slate-50 rounded-lg p-2 border border-orange-300 text-center"><div class="text-xs text-orange-700 font-bold mb-1">BD(WTI)</div><div id="sens-bd" class="text-lg font-black text-slate-800">--</div><div id="r2-bd" class="text-xs text-slate-700">RÂ²=--</div></div>
        <div class="bg-slate-50 rounded-lg p-2 border border-slate-200 text-center"><div class="text-xs text-violet-700 font-bold mb-1">AN</div><div id="sens-an" class="text-lg font-black text-slate-800">--</div><div id="r2-an" class="text-xs text-slate-700">RÂ²=--</div></div>
      </div>
      <div class="grid grid-cols-3 md:grid-cols-5 gap-2">
        <div class="bg-slate-50 rounded-lg p-2 border border-slate-200 text-center"><div class="text-xs text-cyan-700 font-bold mb-1">PR</div><div id="sens-pr" class="text-lg font-black text-slate-800">--</div><div id="r2-pr" class="text-xs text-slate-700">RÂ²=--</div></div>
        <div class="bg-slate-50 rounded-lg p-2 border border-red-200 text-center"><div class="text-xs text-red-700 font-bold mb-1">ABS Gap</div><div id="sens-abs_gap" class="text-lg font-black text-slate-800">--</div><div id="r2-abs_gap" class="text-xs text-slate-700">RÂ²=--</div></div>
        <div class="bg-slate-50 rounded-lg p-2 border border-slate-200 text-center"><div class="text-xs text-cyan-700 font-bold mb-1">ABS Mkt</div><div id="sens-abs_mkt" class="text-lg font-black text-slate-800">--</div><div id="r2-abs_mkt" class="text-xs text-slate-700">RÂ²=--</div></div>
        <div class="bg-slate-50 rounded-lg p-2 border border-slate-200 text-center"><div class="text-xs text-pink-400 font-bold mb-1">SM Cost</div><div id="sens-sm_cost" class="text-lg font-black text-slate-800">--</div><div id="r2-sm_cost" class="text-xs text-slate-700">RÂ²=--</div></div>
        <div class="bg-slate-50 rounded-lg p-2 border border-slate-200 text-center"><div class="text-xs text-slate-700 font-bold mb-1">SM Margin</div><div class="text-lg font-black text-green-700">â‰ˆ0</div><div class="text-xs text-slate-700">WTIë¬´ìƒê´€</div></div>
      </div>
    </div>

    <!-- â•â• 1. WTI êµ¬ê°„ë³„ ë¯¼ê°ë„ íˆíŠ¸ë§µ â•â• -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <h3 class="text-slate-700 font-black text-sm mb-1">ğŸŒ¡ WTI êµ¬ê°„ë³„ ì›ë£Œ ë¯¼ê°ë„ íˆíŠ¸ë§µ</h3>
      <p class="text-xs text-slate-600 mb-3">WTI $1 ìƒìŠ¹ ì‹œ ì›ë£Œë³„ ê°€ê²© ë³€í™”ëŸ‰ â€” ìƒ‰ìƒ ë†ë„ê°€ ì§™ì„ìˆ˜ë¡ ë¯¼ê°ë„ ë†’ìŒ</p>
      <div class="overflow-x-auto">
        <table class="w-full text-xs border-collapse" id="sens-heatmap-table"></table>
      </div>
    </div>

    <!-- â•â• 2. ABS ì›ê°€ WTI ë¦¬ìŠ¤í¬ ê¸°ì—¬ ë¶„í•´ â•â• -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <h3 class="text-slate-700 font-black text-sm mb-1">ğŸ’¥ WTI $1 ìƒìŠ¹ ì‹œ ABS ì›ê°€ ê¸°ì—¬ ë¶„í•´</h3>
      <p class="text-xs text-slate-600 mb-3">SMÂ·ANÂ·BDê°€ ABS ì›ê°€ì— ì–¼ë§ˆë‚˜ ì „ê°€ë˜ëŠ”ì§€ â€” ë¦¬ìŠ¤í¬ ì£¼ë²” íŒŒì•…</p>
      <div class="relative" style="height:240px"><canvas id="sens-contrib-chart"></canvas></div>
    </div>

    <!-- â•â• 3. RÂ² ëª¨ë¸ ì‹ ë¢°ë„ ê²Œì´ì§€ â•â• -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <h3 class="text-slate-700 font-black text-sm mb-1">ğŸ¯ íšŒê·€ëª¨ë¸ RÂ² ì‹ ë¢°ë„ ê²Œì´ì§€</h3>
      <p class="text-xs text-slate-600 mb-3">RÂ²ê°€ ë†’ì„ìˆ˜ë¡ WTIë¡œ ì›ë£Œê°€ê²© ì˜ˆì¸¡ ì‹ ë¢°ì„± ë†’ìŒ â€” ë‚®ì€ í’ˆëª©ì€ ë³„ë„ ìš”ì¸ ì¡´ì¬</p>
      <div id="sens-r2-gauges" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
    </div>

    <!-- â•â• 4. ë¯¼ê°ë„ Before/After ì›ê°€ ì‹œë®¬ â•â• -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <h3 class="text-slate-700 font-black text-sm mb-1">âš– ë¯¼ê°ë„ ë³€ê²½ Before / After ì›ê°€ ë¹„êµ</h3>
      <p class="text-xs text-slate-600 mb-3">ìŠ¬ë¼ì´ë” ì¡°ì‘ ì‹œ ê¸°ë³¸ê°’ ëŒ€ë¹„ í˜„ì¬ ì„¤ì •ìœ¼ë¡œ ABS ì›ê°€ê°€ ì–¼ë§ˆë‚˜ ë‹¬ë¼ì§€ëŠ”ì§€ ì‹¤ì‹œê°„ ë¹„êµ</p>
      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <div class="bg-white rounded-xl border border-slate-200 p-4 text-center">
          <div class="text-xs text-slate-700 font-bold mb-1">ê¸°ë³¸ê°’ ABS ì›ê°€</div>
          <div id="ba-before" class="text-2xl font-black text-slate-700">$---</div>
          <div class="text-xs text-slate-600 mt-1">ì›ë˜ SENS ê¸°ì¤€</div>
        </div>
        <div class="bg-white rounded-xl border border-slate-200 p-4 text-center">
          <div class="text-xs text-slate-700 font-bold mb-1">í˜„ì¬ ì„¤ì • ABS ì›ê°€</div>
          <div id="ba-after" class="text-2xl font-black text-blue-700">$---</div>
          <div class="text-xs text-slate-600 mt-1">ë³€ê²½ëœ SENS ê¸°ì¤€</div>
        </div>
        <div class="bg-white rounded-xl border border-slate-200 p-4 text-center">
          <div class="text-xs text-slate-700 font-bold mb-1">ì›ê°€ ì°¨ì´ (After âˆ’ Before)</div>
          <div id="ba-diff" class="text-2xl font-black">$---</div>
          <div id="ba-diff-pct" class="text-xs text-slate-600 mt-1">---</div>
        </div>
      </div>
      <div class="relative" style="height:220px"><canvas id="sens-ba-chart"></canvas></div>
    </div>

    <!-- â‘  WTI êµ¬ê°„ë³„ ì›ë£Œ ë¯¼ê°ë„ íˆíŠ¸ë§µ -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h3 class="text-slate-700 font-black text-sm">ğŸŒ¡ WTI êµ¬ê°„ë³„ ì›ë£Œ ë¯¼ê°ë„ íˆíŠ¸ë§µ</h3>
          <p class="text-xs text-slate-600 mt-0.5">WTI $1 ìƒìŠ¹ ì‹œ ê° ì›ë£Œ ê°€ê²© ë³€í™”ëŸ‰ â€” ìƒ‰ìƒ ë†ë„ = ë¯¼ê°ë„ ê°•ë„</p>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-xs border-collapse" id="sens-heatmap"></table>
      </div>
    </div>

    <!-- â‘¡ ABS ì›ê°€ WTI ë¦¬ìŠ¤í¬ ê¸°ì—¬ ë¶„í•´ -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div>
          <h3 class="text-slate-700 font-black text-sm">ğŸ’° WTI $1 ìƒìŠ¹ ì‹œ ABS ì›ê°€ ê¸°ì—¬ ë¶„í•´</h3>
          <p class="text-xs text-slate-600 mt-0.5">SMÂ·ANÂ·BD ê°ê°ì´ ABS ì›ê°€ ìƒìŠ¹ì— ì–¼ë§ˆë‚˜ ê¸°ì—¬í•˜ëŠ”ê°€</p>
        </div>
      </div>
      <div class="relative" style="height:240px">
        <canvas id="sens-contrib-chart"></canvas>
      </div>
    </div>

    <!-- â‘¢ RÂ² ëª¨ë¸ ì‹ ë¢°ë„ ê²Œì´ì§€ -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <div class="mb-3">
        <h3 class="text-slate-700 font-black text-sm">ğŸ“ íšŒê·€ëª¨ë¸ ì‹ ë¢°ë„ (RÂ²)</h3>
        <p class="text-xs text-slate-600 mt-0.5">RÂ²=1.0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ WTIë¡œ í•´ë‹¹ ì›ë£Œê°€ê²© ì„¤ëª…ë ¥ì´ ë†’ìŒ â€” ë‚®ì„ìˆ˜ë¡ ì˜ˆì¸¡ ë¶ˆí™•ì‹¤ì„± í¼</p>
      </div>
      <div id="sens-r2-gauges" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
    </div>

    <!-- â‘£ ë¯¼ê°ë„ Before/After ì›ê°€ ì‹œë®¬ -->
    <div class="bg-sky-50 border border-blue-200 rounded-2xl p-5 mt-4 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div>
          <h3 class="text-slate-700 font-black text-sm">âš¡ ë¯¼ê°ë„ ë³€ê²½ Before/After ì›ê°€ ë¹„êµ</h3>
          <p class="text-xs text-slate-600 mt-0.5">í˜„ì¬ ë¯¼ê°ë„ ì„¤ì • vs ê¸°ë³¸ê°’(OLS) ê¸°ì¤€ â€” WTI êµ¬ê°„ë³„ ABS ì›ê°€ ì°¨ì´</p>
        </div>
        <div class="text-xs text-slate-700 bg-white border border-slate-200 rounded-lg px-3 py-2">
          WTI ê¸°ì¤€: <span id="sens-ba-wti" class="font-black text-amber-700">$67</span>
          <input type="range" id="sens-ba-slider" min="50" max="100" step="1" value="67" class="w-32 ml-2" oninput="renderSensBeforeAfter()">
        </div>
      </div>
      <div class="relative" style="height:260px">
        <canvas id="sens-ba-chart"></canvas>
      </div>
    </div>
  </div>
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-forecast" class="hidden">
    <div class="bg-sky-50/90 border border-indigo-200 rounded-2xl p-5 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h2 class="text-indigo-700 text-sm font-black uppercase tracking-widest">ğŸ“… SM Â· AN Â· BD ì‚¬ì „ì›ê°€ ì˜ˆì¸¡ (3~5ì›” 13ì£¼)</h2>
          <p class="text-slate-700 text-xs mt-1">
            ì˜ˆì¸¡ = í˜„ì¬ê°€ + WTIê²½ë¡œÃ—ë¯¼ê°ë„ + ê³„ì ˆì„±Î” &nbsp;|&nbsp;
            ê³„ì ˆì„±: 2024~2026 ì‹¤ê°€ê²© WTIì”ì°¨ ì£¼ì°¨ë³„ í‰ê·  &nbsp;|&nbsp;
            ì‹ ë¢°êµ¬ê°„: ì”ì°¨ÏƒÃ—âˆšnÃ—1.96 &nbsp;|&nbsp;
            <span class="text-orange-700">BDëŠ” í¬ë˜ì»¤ë§ˆì§„ ì‹œë‚˜ë¦¬ì˜¤ ë³‘ê¸°</span>
          </p>
        </div>
        <div class="flex gap-2 shrink-0 flex-wrap">
          <button onclick="setFcScenario('flat')"   id="fc-btn-flat"   class="fc-btn text-xs border rounded-lg px-3 py-1.5 transition bg-emerald-900/60 text-emerald-700 border-emerald-700">Flat <span id="fc-flat-wti-label">$--</span></button>
          <button onclick="setFcScenario('up')"     id="fc-btn-up"     class="fc-btn text-xs border rounded-lg px-3 py-1.5 transition bg-sky-50 text-slate-700 border-slate-300">Up +$1/w</button>
          <button onclick="setFcScenario('down')"   id="fc-btn-down"   class="fc-btn text-xs border rounded-lg px-3 py-1.5 transition bg-sky-50 text-slate-700 border-slate-300">Down -$1/w</button>
          <button onclick="setFcScenario('custom')" id="fc-btn-custom" class="fc-btn text-xs border rounded-lg px-3 py-1.5 transition bg-sky-50 text-slate-700 border-slate-300">Custom</button>
        </div>
      </div>

      <!-- WTI ê²½ë¡œ ìŠ¬ë¼ì´ë” (Custom ëª¨ë“œ) -->
      <div id="fc-custom-panel" class="hidden bg-slate-50 border border-slate-200 rounded-xl p-4">
        <div class="text-xs text-slate-700 font-bold mb-3">Custom WTI ê²½ë¡œ (13ì£¼)</div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div>
            <div class="flex justify-between text-xs mb-1"><span class="text-slate-700">W+1~4 (3ì›”)</span><span id="fc-wti-mar" class="text-amber-700 font-bold">$67</span></div>
            <input type="range" id="fc-slider-mar" min="50" max="100" step="0.5" value="67" class="w-full" oninput="onFcCustom()">
          </div>
          <div>
            <div class="flex justify-between text-xs mb-1"><span class="text-slate-700">W+5~8 (4ì›”)</span><span id="fc-wti-apr" class="text-amber-700 font-bold">$67</span></div>
            <input type="range" id="fc-slider-apr" min="50" max="100" step="0.5" value="67" class="w-full" oninput="onFcCustom()">
          </div>
          <div>
            <div class="flex justify-between text-xs mb-1"><span class="text-slate-700">W+9~13 (5ì›”)</span><span id="fc-wti-may" class="text-amber-700 font-bold">$67</span></div>
            <input type="range" id="fc-slider-may" min="50" max="100" step="0.5" value="67" class="w-full" oninput="onFcCustom()">
          </div>
          <div class="flex items-center">
            <div class="text-xs text-slate-700">WTI ê²½ë¡œë³„ 3~5ì›” êµ¬ê°„ ë…ë¦½ ì„¤ì •</div>
          </div>
        </div>
      </div>

      <!-- ë²”ë¡€ -->
      <div class="flex gap-4 text-xs text-slate-700 flex-wrap">
        <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded bg-blue-500 opacity-80"></span>ì˜ˆì¸¡ ì¤‘ì‹¬ê°’</span>
        <span class="flex items-center gap-1"><span class="inline-block w-3 h-2 rounded bg-blue-500 opacity-20"></span>95% ì‹ ë¢°êµ¬ê°„</span>
        <span class="flex items-center gap-1"><span class="inline-block w-4 border-t-2 border-dashed border-yellow-400"></span>ê³„ì ˆì„± ê¸°ì—¬</span>
        <span class="flex items-center gap-1"><span class="inline-block w-4 border-t-2 border-slate-400"></span>í˜„ì¬ê°€ ê¸°ì¤€ì„ </span>
      </div>

      <!-- 3í’ˆëª© ì˜ˆì¸¡ í…Œì´ë¸” -->
      <div class="space-y-4">

        <!-- SM -->
        <div class="bg-slate-50 border border-blue-200 rounded-xl overflow-hidden">
          <div class="bg-blue-50 px-4 py-2 flex justify-between items-center">
            <span class="text-blue-700 font-black text-sm">SM (Styrene Monomer) FOB China</span>
            <span class="text-xs text-slate-700">í˜„ì¬ <span id="fc-cur-sm" class="text-blue-700 font-bold">$978</span> | Ïƒ=Â±$52.6/ì£¼</span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-xs">
              <thead>
                <tr class="border-b border-slate-200">
                  <th class="px-3 py-2 text-left text-slate-700 w-16">ì£¼ì°¨</th>
                  <th class="px-3 py-2 text-left text-slate-700">ë‚ ì§œ</th>
                  <th class="px-3 py-2 text-right text-slate-700">WTI</th>
                  <th class="px-3 py-2 text-right text-amber-700">ê³„ì ˆÎ”</th>
                  <th class="px-3 py-2 text-right text-blue-700 font-bold">ì˜ˆì¸¡</th>
                  <th class="px-3 py-2 text-right text-slate-700">í•˜í•œ(95%)</th>
                  <th class="px-3 py-2 text-right text-slate-700">ìƒí•œ(95%)</th>
                  <th class="px-3 py-2 text-right text-slate-700">ì „ì£¼ëŒ€ë¹„</th>
                  <th class="px-3 py-2 text-left text-slate-700 w-24">ì‹œê·¸ë„</th>
                </tr>
              </thead>
              <tbody id="fc-table-sm"></tbody>
            </table>
          </div>
        </div>

        <!-- AN -->
        <div class="bg-slate-50 border border-yellow-200 rounded-xl overflow-hidden">
          <div class="bg-yellow-50 px-4 py-2 flex justify-between items-center">
            <span class="text-violet-700 font-black text-sm">AN (Acrylonitrile) CFR FE Asia</span>
            <span class="text-xs text-slate-700">í˜„ì¬ <span id="fc-cur-an" class="text-violet-700 font-bold">$1060</span> | Ïƒ=Â±$52.6/ì£¼</span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-xs">
              <thead>
                <tr class="border-b border-slate-200">
                  <th class="px-3 py-2 text-left text-slate-700 w-16">ì£¼ì°¨</th>
                  <th class="px-3 py-2 text-left text-slate-700">ë‚ ì§œ</th>
                  <th class="px-3 py-2 text-right text-slate-700">WTI</th>
                  <th class="px-3 py-2 text-right text-amber-700">ê³„ì ˆÎ”</th>
                  <th class="px-3 py-2 text-right text-amber-700 font-bold">ì˜ˆì¸¡</th>
                  <th class="px-3 py-2 text-right text-slate-700">í•˜í•œ(95%)</th>
                  <th class="px-3 py-2 text-right text-slate-700">ìƒí•œ(95%)</th>
                  <th class="px-3 py-2 text-right text-slate-700">ì „ì£¼ëŒ€ë¹„</th>
                  <th class="px-3 py-2 text-left text-slate-700 w-24">ì‹œê·¸ë„</th>
                </tr>
              </thead>
              <tbody id="fc-table-an"></tbody>
            </table>
          </div>
        </div>

        <!-- BD -->
        <div class="bg-slate-50 border border-orange-200 rounded-xl overflow-hidden">
          <div class="bg-orange-950/60 px-4 py-2 flex justify-between items-center">
            <span class="text-orange-700 font-black text-sm">BD (Butadiene) CFR China</span>
            <span class="text-xs text-slate-700">í˜„ì¬ <span id="fc-cur-bd" class="text-orange-700 font-bold">$1270</span> | Ïƒ=Â±$149/ì£¼ <span class="text-orange-600">â˜…í¬ë˜ì»¤ì—°ë™</span></span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-xs">
              <thead>
                <tr class="border-b border-slate-200">
                  <th class="px-3 py-2 text-left text-slate-700 w-16">ì£¼ì°¨</th>
                  <th class="px-3 py-2 text-left text-slate-700">ë‚ ì§œ</th>
                  <th class="px-3 py-2 text-right text-slate-700">WTI</th>
                  <th class="px-3 py-2 text-right text-amber-700">ê³„ì ˆÎ”</th>
                  <th class="px-3 py-2 text-right text-orange-700 font-bold">ì˜ˆì¸¡(WTI)</th>
                  <th class="px-3 py-2 text-right text-red-700">í¬ë˜ì»¤íƒ€ì´íŠ¸</th>
                  <th class="px-3 py-2 text-right text-orange-700 font-bold">BDìµœì¢…</th>
                  <th class="px-3 py-2 text-right text-slate-700">í•˜í•œ(95%)</th>
                  <th class="px-3 py-2 text-right text-slate-700">ìƒí•œ(95%)</th>
                </tr>
              </thead>
              <tbody id="fc-table-bd"></tbody>
            </table>
          </div>
          <div class="px-4 py-2 bg-orange-50/60 text-xs text-orange-700">
            â˜… BD ì‹ ë¢°êµ¬ê°„ ë„“ìŒ(Ïƒ=Â±$149) â€” WTIë³´ë‹¤ í¬ë˜ì»¤ ê°€ë™ë¥ Â·ê³µê¸‰ ì´ë²¤íŠ¸ ì˜í–¥ì´ ì§€ë°°ì . ê³„ì ˆì„±+í¬ë˜ì»¤íƒ€ì´íŠ¸ ë°©í–¥ì„± ì°¸ê³ ìš©.
          </div>
        </div>
      </div>


      <!-- í’ˆëª©ë³„ ì˜ˆì¸¡ ê·¸ë˜í”„ -->
      <div class="bg-sky-50 rounded-2xl border border-slate-200 p-5 shadow-sm">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <h3 class="text-slate-700 font-black text-sm">ğŸ“ˆ í’ˆëª©ë³„ ì˜ˆì¸¡ ì¶”ì´ ê·¸ë˜í”„</h3>
          <div class="flex gap-2 flex-wrap items-center">
            <!-- í‘œì‹œ í’ˆëª© í† ê¸€ -->
            <span class="text-xs text-slate-700 font-bold">í’ˆëª©:</span>
            <button onclick="toggleFcLine('SM')"  id="fc-toggle-sm"  class="fc-toggle text-xs px-2 py-1 rounded border font-bold transition bg-blue-100 text-blue-700 border-blue-300">SM</button>
            <button onclick="toggleFcLine('AN')"  id="fc-toggle-an"  class="fc-toggle text-xs px-2 py-1 rounded border font-bold transition bg-violet-100 text-violet-700 border-violet-300">AN</button>
            <button onclick="toggleFcLine('BD')"  id="fc-toggle-bd"  class="fc-toggle text-xs px-2 py-1 rounded border font-bold transition bg-orange-100 text-orange-700 border-orange-300">BD</button>
            <span class="text-xs text-slate-600 mx-1">|</span>
            <!-- ë¼ì¸ ìŠ¤íƒ€ì¼ -->
            <span class="text-xs text-slate-700 font-bold">ë¼ì¸:</span>
            <button onclick="setChartType('line')"   id="ct-line"   class="ct-btn text-xs px-2 py-1 rounded border font-bold transition bg-slate-700 text-white border-slate-600">ì„ í˜•</button>
            <button onclick="setChartType('bar')"    id="ct-bar"    class="ct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300">ë§‰ëŒ€</button>
            <button onclick="setChartType('smooth')" id="ct-smooth" class="ct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300">ê³¡ì„ </button>
            <span class="text-xs text-slate-600 mx-1">|</span>
            <!-- CI í‘œì‹œ -->
            <label class="flex items-center gap-1 text-xs text-slate-600 cursor-pointer">
              <input type="checkbox" id="fc-show-ci" onchange="renderFcChart()" checked class="accent-blue-600"> ì‹ ë¢°êµ¬ê°„
            </label>
            <label class="flex items-center gap-1 text-xs text-slate-600 cursor-pointer" title="ê³„ì ˆì„±: 2024~2026ë…„ ì‹¤ê°€ê²©ì—ì„œ WTI íšŒê·€ ì¶”ì •ê°’ì„ ëº€ ì”ì°¨ì˜ ì£¼ì°¨ë³„ í‰ê· . WTIë¡œ ì„¤ëª… ì•ˆ ë˜ëŠ” ê³„ì ˆì  ìˆ˜ê¸‰ íŒ¨í„´(ë´„ì²  ìˆ˜ìš” ì¦ê°€, í•˜ì ˆê¸° ê³µê¸‰ ê³¼ì‰ ë“±)ì„ ë°˜ì˜í•œ ë³´ì •ê°’.">
              <input type="checkbox" id="fc-show-seasonal" onchange="renderFcChart()" checked class="accent-yellow-500"> ê³„ì ˆì„± â“˜
            </label>
            <label class="flex items-center gap-1 text-xs text-slate-600 cursor-pointer">
              <input type="checkbox" id="fc-show-price" onchange="renderFcChart()" checked class="accent-emerald-600"> ê°€ê²©í‘œì‹œ
            </label>
            <label class="flex items-center gap-1 text-xs text-slate-600 cursor-pointer">
              <input type="checkbox" id="fc-show-flat" onchange="renderFcChart()" checked class="accent-gray-500"> Flat ê¸°ì¤€ì„ 
            </label>
          </div>
        </div>
        <div class="relative" style="height:320px">
          <canvas id="fc-chart"></canvas>
        </div>
        <div class="flex flex-wrap gap-4 mt-3 text-xs text-slate-700 justify-center">
          <span>â— ì‹¤ì„ : ì˜ˆì¸¡ ì¤‘ì‹¬ê°’</span>
          <span>â–“ ìŒì˜: 95% ì‹ ë¢°êµ¬ê°„</span>
          <span>â—‡ ì ì„ : ê³„ì ˆì„± ê¸°ì—¬ë¶„ (í˜„ì¬ê°€ ê¸°ì¤€)</span>
          <span>â”€ â”€ íšŒìƒ‰ì ì„ : Flat ê¸°ì¤€ì„  (í˜„ì¬ WTI ê³ ì •)</span>
          <span>â”‚ ì„¸ë¡œì„ : ì›” êµ¬ë¶„</span>
        </div>
        <!-- ê³„ì ˆì„± ìƒì„¸ ì„¤ëª… -->
        <div class="mt-3 bg-yellow-50 border border-yellow-200 rounded-xl p-3 text-xs text-slate-700 leading-relaxed">
          <span class="font-black text-yellow-700">ê³„ì ˆì„±(Seasonality):</span>
          2024~2026ë…„ ì‹¤ê°€ê²©ì—ì„œ WTI íšŒê·€ ì¶”ì •ê°’ì„ ëº€ <b>ì”ì°¨(Residual)ì˜ ì£¼ì°¨ë³„ í‰ê· </b>.
          WTI ìœ ê°€ ë³€ë™ë§Œìœ¼ë¡œ ì„¤ëª…ë˜ì§€ ì•ŠëŠ” <b>ë°˜ë³µì  ê³„ì ˆ íŒ¨í„´</b>ì„ í¬ì°© â€”
          ì˜ˆ) ë´„ì² (3~4ì›”) ì•„ì‹œì•„ ìˆ˜ìš” ì¦ê°€ë¡œ SMÂ·AN ê°•ì„¸, ì—¬ë¦„(7~8ì›”) ì •ê¸°ë³´ìˆ˜ ì§‘ì¤‘ìœ¼ë¡œ BD ì¼ì‹œ íƒ€ì´íŠ¸, ì—°ë§ ì¬ê³  ì¶•ì†Œë¡œ ì „ë°˜ì  ì•½ì„¸.
          ì ì„ ì´ ì˜ˆì¸¡ ì¤‘ì‹¬ì„  <b>ìœ„</b>ë©´ í•´ë‹¹ ì£¼ì°¨ì— ê³„ì ˆì  <b>ìƒìŠ¹ ì••ë ¥</b>, <b>ì•„ë˜</b>ë©´ <b>í•˜ë½ ì••ë ¥</b>ì´ ì—­ì‚¬ì ìœ¼ë¡œ ì¡´ì¬í–ˆìŒì„ ì˜ë¯¸.
        </div>
      </div>

      <!-- ì¸ì‚¬ì´íŠ¸ ìš”ì•½ -->
      <div id="fc-insight-box" class="bg-indigo-50 border border-indigo-200 rounded-xl p-4 text-xs leading-relaxed space-y-1"></div>

    </div>
  </div>

  <footer class="text-center text-slate-700 text-xs pb-4">
    LAM Advanced Procurement  |  v6.4  |  í¬ë˜ì»¤ë§ˆì§„â†’BDíƒ€ì´íŠ¸(Ã—0.5, max150)  |  ìˆ˜ê¸‰ì‹ í˜¸ 4ì¢…  |  30ì´ˆ ìë™ê°±ì‹ 
  </footer>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// íƒ­ í•¨ìˆ˜ â€” ë§¨ ì• ì„ ì–¸ (HTML onclick ì¸ë¼ì¸ ì°¸ì¡°)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// datalabels í”ŒëŸ¬ê·¸ì¸ ì „ì—­ ë“±ë¡
if (window.ChartDataLabels) Chart.register(ChartDataLabels);
function showTab(id, btn) {
  ['tab-main','tab-wti','tab-cracker','tab-scenario','tab-chart','tab-sens','tab-forecast']
    .forEach(t => document.getElementById(t).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (id === 'tab-scenario') renderScenarios();
  if (id === 'tab-forecast') renderForecast();
  if (id === 'tab-cracker') setTimeout(renderCrackerHistoryChart, 150);
  if (id === 'tab-wti') setTimeout(() => { setWtiChartMode('radar'); onWtiSlider(); }, 150);
  if (id === 'tab-sens') renderSensCharts();
  if (id === 'tab-sens') setTimeout(renderSensCharts, 150);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì•µì»¤ ìƒíƒœ & íŒŒë¼ë¯¸í„°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let G = {
  wti_gs:67.02, wti_rt:67.02,
  bz:772, et:710, bd:1270, an:1315, nap:637,
  sm_act:966, abs_mkt_act:1060, pr_act:870,
  bz_ara_act:720, bz_usg_mt_act:680,
  sm_margin_act:-1,
  cracker_act: 0,  // ì‹¤ì¸¡ í¬ë˜ì»¤ë§ˆì§„ (CSV ë¡œë“œ í›„ ê°±ì‹ )
};

let SENS = {
  bz:16.81, et:6.13, bd:20.48, an:7.87, sm:14.75,
  nap:6.52, pr:4.18, bz_ara:15.20, bz_usg:0.85,
  sm_cost:14.50, sm_margin:-0.08,
  abs_cost:13.89, abs_mkt:8.12, abs_gap:-5.76,
};

let NAP_EQUIV = 6.52;
const BZ_USG_TO_MT = 26.42;
const SM_COST   = {bz:0.67, et:0.25, nap:0.05, fixed:150};
const SM_THEORY = {bz:0.80, et:0.30, fixed:150};
const ABS_R     = {sm:0.60, an:0.25, bd:0.15};
// í¬ë˜ì»¤ ìˆ˜ìœ¨ (ì•„ì‹œì•„ NAP í¬ë˜ì»¤ ê¸°ì¤€: PR 0.13â†’0.15 ë°˜ì˜)
const CR_Y = {et:0.30, pr:0.15, bd:0.045, bz:0.06};
const BD_TIGHT_SCALE = 0.5;
const BD_TIGHT_MAX   = 150;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìœ í‹¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt  = (v, sign=false) => isNaN(v)||v===null ? '--' : (sign&&v>=0?'+':'')+'$'+Math.round(v).toLocaleString();
const fmtF = (v, d=1) => isNaN(v) ? '--' : v.toFixed(d);

function crackerColor(m) {
  if (m >= 50)  return 'cracker-positive';
  if (m >= 0)   return 'cracker-warn';
  return 'cracker-negative';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í•µì‹¬ ê³„ì‚° í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcCrackerMargin(et, pr, bd, bz, nap) {
  const OPEX = 50; return et*CR_Y.et + pr*CR_Y.pr + bd*CR_Y.bd + bz*CR_Y.bz - nap - OPEX;
}

function calcBdTight(crackerSim) {
  // ê¸°ì¤€ë§ˆì§„: CRACKER_HISTORY ìµœê·¼ 4ì£¼ í‰ê·  (êµ¬ì¡°ì  ìˆ˜ì¤€ ê¸°ì¤€)
  // í˜„ì¬ ë§ˆì§„ì´ ìµœê·¼ 4ì£¼ í‰ê· ë³´ë‹¤ ë” ì•…í™”ëì„ ë•Œë§Œ íƒ€ì´íŠ¸ í”„ë¦¬ë¯¸ì—„ ë°œë™
  const recent4 = CRACKER_HISTORY.slice(-4).map(d => d.margin);
  const baseMgn = recent4.reduce((a, b) => a + b, 0) / recent4.length;
  const delta   = crackerSim - baseMgn;  // ìŒìˆ˜ = ê¸°ì¤€ ëŒ€ë¹„ ì•…í™”
  return Math.min(Math.max(0, -delta) * BD_TIGHT_SCALE, BD_TIGHT_MAX);
}

function calcAll(wti, risk=0, etOverride=null) {
  const dWti     = wti - G.wti_gs;
  const riskEquiv = risk / NAP_EQUIV;
  const dTotal   = dWti + riskEquiv;

  const bz  = G.bz    + dTotal * SENS.bz;
  const et  = etOverride !== null ? etOverride : G.et + dTotal * SENS.et;
  const etWti = G.et  + dTotal * SENS.et;  // WTI íšŒê·€ë§Œ
  const nap = G.nap   + dTotal * SENS.nap;
  const sm  = G.sm_act + dTotal * SENS.sm;
  const an  = G.an    + dTotal * SENS.an;
  const pr  = G.pr_act + dTotal * SENS.pr;
  const bzAra   = G.bz_ara_act    + dTotal * SENS.bz_ara;
  const bzUsgMt = G.bz_usg_mt_act + dTotal * SENS.bz_usg * BZ_USG_TO_MT;

  // í¬ë˜ì»¤ ë§ˆì§„ (ì‹œë®¬ ET ì‚¬ìš©)
  const bdBase    = G.bd + dTotal * SENS.bd;
  const crackerSim = calcCrackerMargin(et, pr, bdBase, bz, nap);
  const bdTight   = calcBdTight(crackerSim);
  const bd        = bdBase + bdTight;

  // SM Cost
  const smCost    = bz*SM_COST.bz + et*SM_COST.et + nap*SM_COST.nap + SM_COST.fixed;
  const smCostTh  = bz*SM_THEORY.bz + et*SM_THEORY.et + SM_THEORY.fixed;
  const smMargin  = G.sm_margin_act + dWti * SENS.sm_margin;
  const smMarginTh = sm - smCostTh;

  // ABS
  const absCost   = sm*ABS_R.sm + an*ABS_R.an + bd*ABS_R.bd;
  const absCostTh = smCostTh*ABS_R.sm + an*ABS_R.an + bd*ABS_R.bd;
  const absMkt    = G.abs_mkt_act + dWti * SENS.abs_mkt + risk;
  const absGap    = absMkt - absCost;
  const absGapTh  = absMkt - absCostTh;

  return {
    wti, dWti, riskEquiv, dTotal, risk,
    bz, et, etWti, nap, sm, an, pr, bd, bdBase, bdTight,
    bzAra, bzUsgMt,
    bzSpreadAra: bz - bzAra, bzSpreadUsg: bz - bzUsgMt,
    crackerSim, crackerDelta: crackerSim - G.cracker_act,
    smCost, smCostTh, smMargin, smMarginTh,
    absCost, absCostTh, absMkt, absGap, absGapTh,
  };
}

// í¬ë˜ì»¤ ì „ìš© ê³„ì‚° (WTI ì—†ì´ ì›ë£Œ ì§ì ‘ ì…ë ¥)
function calcCrackerDirect(et, pr, bd, bz, nap, smAct, anAct, absMktAct) {
  const crackerSim  = calcCrackerMargin(et, pr, bd, bz, nap);
  const bdTight     = calcBdTight(crackerSim);
  const bdFinal     = G.bd + bdTight;  // ì•µì»¤ BD + íƒ€ì´íŠ¸ (WTI ë¬´ë³€í™” ê¸°ì¤€)
  const smCostTh    = bz*SM_THEORY.bz + et*SM_THEORY.et + SM_THEORY.fixed;
  const absCost     = smAct*ABS_R.sm + anAct*ABS_R.an + bdFinal*ABS_R.bd;
  const absCostTh   = smCostTh*ABS_R.sm + anAct*ABS_R.an + bdFinal*ABS_R.bd;
  const absGap      = absMktAct - absCost;
  const absGapTh    = absMktAct - absCostTh;
  return { crackerSim, bdTight, bdFinal, absCost, absCostTh, absGap, absGapTh,
           crackerDelta: crackerSim - G.cracker_act };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WTI ì‹œë®¬ë ˆì´í„°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onWtiSlider() {
  const wti  = parseFloat(document.getElementById('slider-wti').value);
  const risk = parseFloat(document.getElementById('slider-risk').value);
  document.getElementById('wti-slider-val').textContent  = `$${wti.toFixed(2)}/bbl`;
  document.getElementById('risk-slider-val').textContent = `+$${risk}/t`;

  const r = calcAll(wti, risk);

  // ë¦¬ìŠ¤í¬ ë°°ë„ˆ
  const rb = document.getElementById('risk-equiv-bar');
  if (risk > 0) {
    rb.classList.remove('hidden');
    document.getElementById('risk-equiv-val').textContent = `+$${r.riskEquiv.toFixed(1)}/bbl`;
    document.getElementById('risk-bz').textContent = `$${Math.round(r.riskEquiv*SENS.bz)}`;
    document.getElementById('risk-et').textContent = `$${Math.round(r.riskEquiv*SENS.et)}`;
    document.getElementById('risk-bd').textContent = `$${Math.round(r.riskEquiv*SENS.bd)}`;
    document.getElementById('risk-an').textContent = `$${Math.round(r.riskEquiv*SENS.an)}`;
  } else { rb.classList.add('hidden'); }

  document.getElementById('wsim-bz').textContent  = fmt(r.bz);
  document.getElementById('wsim-et').textContent  = fmt(r.et);
  document.getElementById('wsim-bd').textContent  = fmt(r.bd);
  document.getElementById('wsim-an').textContent  = fmt(r.an);
  document.getElementById('wsim-pr').textContent  = fmt(r.pr);
  document.getElementById('wsim-sm').textContent  = fmt(r.sm);

  const crEl = document.getElementById('wsim-cracker');
  crEl.textContent = fmt(r.crackerSim, true);
  crEl.className   = 'font-black ' + (r.crackerSim >= 0 ? 'text-emerald-700' : 'text-red-700');
  document.getElementById('wsim-bd-tight').textContent = `+$${Math.round(r.bdTight)}`;

  document.getElementById('wsim-sm-cost').textContent    = fmt(r.smCost);
  document.getElementById('wsim-sm-cost-th').textContent = fmt(r.smCostTh);

  const smMEl = document.getElementById('wsim-sm-margin');
  smMEl.textContent = fmt(r.smMargin, true);
  smMEl.className   = 'font-black text-lg ' + (r.smMargin >= 0 ? 'text-emerald-700' : 'text-red-700');

  const smMThEl = document.getElementById('wsim-sm-margin-th');
  smMThEl.textContent = fmt(r.smMarginTh, true);
  smMThEl.className   = 'font-black text-lg ' + (r.smMarginTh >= 0 ? 'text-blue-700' : 'text-purple-700');

  document.getElementById('wsim-abs-mkt').textContent  = fmt(r.absMkt);
  document.getElementById('wsim-abs-cost').textContent = fmt(r.absCost);

  const gEl = document.getElementById('wsim-abs-gap');
  gEl.textContent = fmt(r.absGap, true);
  gEl.className   = 'font-black text-2xl ' + (r.absGap < 0 ? 'text-red-500 alert-blink' : r.absGap < 150 ? 'text-amber-700' : 'text-emerald-700');

  document.getElementById('wsim-abs-gap-th').textContent = fmt(r.absGapTh, true);
  document.getElementById('wti-strategy').innerHTML      = buildStrategy(r);
  renderWtiChart();
}

function setWtiScenario(wti, risk) {
  document.getElementById('slider-wti').value  = wti;
  document.getElementById('slider-risk').value = risk;
  onWtiSlider();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WTI ì‹œë®¬ ì°¨íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let wtiSimChart = null;
let wtiChartMode = 'radar';  // radar | bar | donut | gauge

// í’ˆëª© í‘œì‹œ ì—¬ë¶€
const WTI_ITEMS = {
  NAP: { on:true,  color:'rgba(100,116,139,', label:'NAP',  key:'nap'  },
  BZ:  { on:true,  color:'rgba(168,85,247,',  label:'BZ',   key:'bz'   },
  ET:  { on:true,  color:'rgba(16,185,129,',  label:'ET',   key:'et'   },
  BD:  { on:true,  color:'rgba(249,115,22,',  label:'BD',   key:'bd'   },
  AN:  { on:true,  color:'rgba(217,119,6,',   label:'AN',   key:'an'   },
  SM:  { on:true,  color:'rgba(59,130,246,',  label:'SM',   key:'sm'   },
};

const WTI_BTN_ON  = { NAP:'bg-slate-100 text-slate-700 border-slate-300', BZ:'bg-purple-100 text-purple-700 border-purple-300', ET:'bg-emerald-100 text-emerald-700 border-emerald-300', BD:'bg-orange-100 text-orange-700 border-orange-300', AN:'bg-violet-100 text-violet-700 border-violet-300', SM:'bg-blue-100 text-blue-700 border-blue-300' };
const WTI_BTN_OFF = 'bg-slate-50 text-slate-400 border-slate-200';

function toggleWtiItem(key) {
  WTI_ITEMS[key].on = !WTI_ITEMS[key].on;
  const btn = document.getElementById('wi-'+key);
  if (btn) btn.className = `wi-btn text-xs px-2 py-1 rounded border font-bold transition ${WTI_ITEMS[key].on ? WTI_BTN_ON[key] : WTI_BTN_OFF}`;
  renderWtiChart();
}

function setWtiChartMode(mode) {
  wtiChartMode = mode;
  document.querySelectorAll('.wct-btn').forEach(b => b.className = 'wct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300');
  const active = document.getElementById('wct-'+mode);
  if (active) active.className = 'wct-btn text-xs px-2 py-1 rounded border font-bold transition bg-slate-700 text-white border-slate-600';
  // ê²Œì´ì§€ íŒ¨ë„ í† ê¸€
  const gp = document.getElementById('wti-gauge-panel');
  const canvas = document.getElementById('wti-sim-chart');
  if (mode === 'gauge') {
    if (gp) gp.classList.remove('hidden');
    if (canvas) canvas.parentElement.classList.add('hidden');
  } else {
    if (gp) gp.classList.add('hidden');
    if (canvas) canvas.parentElement.classList.remove('hidden');
  }
  renderWtiChart();
}

function renderWtiChart() {
  if (wtiChartMode === 'gauge') { renderWtiGauge(); return; }

  const canvas = document.getElementById('wti-sim-chart');
  if (!canvas) return;
  const newCanvas = canvas.cloneNode(true);
  canvas.parentNode.replaceChild(newCanvas, canvas);

  const wti  = parseFloat(document.getElementById('slider-wti').value);
  const risk = parseFloat(document.getElementById('slider-risk').value);
  const r    = calcAll(wti, risk);
  const base = calcAll(G.wti_rt, 0);  // í˜„ì¬ê°€ ê¸°ì¤€

  // í™œì„± í’ˆëª©ë§Œ
  const active = Object.entries(WTI_ITEMS).filter(([,v]) => v.on);

  if (wtiChartMode === 'radar') {
    // ë ˆì´ë”: WTI $1 ë³€ë™ ì‹œ í’ˆëª©ë³„ ë¯¼ê°ë„(SENS) â€” ë‹¨ìœ„ í†µì¼ë¡œ ë¹„êµ ì˜ë¯¸ ìˆìŒ
    const sensMap = { NAP: SENS.nap, BZ: SENS.bz, ET: SENS.et, BD: SENS.bd, AN: SENS.an, SM: SENS.sm };
    const labels  = active.map(([k]) => k);
    const sensV   = active.map(([k]) => Math.round(sensMap[k] * 10) / 10);  // ì†Œìˆ˜1ìë¦¬

    wtiSimChart = new Chart(newCanvas, {
      type: 'radar',
      data: {
        labels,
        datasets: [{
          label: 'WTI $1 ìƒìŠ¹ ì‹œ ê°€ê²© ë³€í™” ($/mt)',
          data: sensV,
          borderColor: 'rgba(239,68,68,0.9)',
          backgroundColor: 'rgba(239,68,68,0.15)',
          pointBackgroundColor: active.map(([,v]) => v.color + '1)'),
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          borderWidth: 2.5,
          pointRadius: 6,
          datalabels: {
            display: true,
            color: '#1e293b',
            font: { size: 10, weight: 'bold' },
            formatter: v => '+$' + v,
          }
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { font:{size:11}, color:'#334155' } },
          datalabels: { display: true },
          tooltip: { callbacks: { label: ctx => ` WTI +$1 â†’ ${ctx.chart.data.labels[ctx.dataIndex]} +$${ctx.parsed.r}` } }
        },
        scales: {
          r: {
            beginAtZero: true,
            ticks: { color:'#64748b', font:{size:10}, callback: v => '+$'+v },
            grid:  { color:'rgba(148,163,184,0.3)' },
            pointLabels: { color:'#334155', font:{size:13, weight:'bold'} }
          }
        }
      }
    });

  } else if (wtiChartMode === 'bar') {
    // ìˆ˜í‰ ë°”: í˜„ì¬ê°€ ëŒ€ë¹„ ë³€ë™í­
    const labels  = active.map(([,v]) => v.label);
    const deltas  = active.map(([,v]) => Math.round((r[v.key]||0) - (base[v.key]||0)));
    const colors  = deltas.map(d => d >= 0 ? 'rgba(239,68,68,0.8)' : 'rgba(59,130,246,0.8)');

    wtiSimChart = new Chart(newCanvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'WTI ë³€ë™ ì‹œ ê°€ê²© ë³€í™” ($/mt)',
          data: deltas,
          backgroundColor: colors,
          borderRadius: 6,
          datalabels: {
            display: true,
            anchor: d => deltas[d.dataIndex] >= 0 ? 'end' : 'start',
            align:  d => deltas[d.dataIndex] >= 0 ? 'right' : 'left',
            color: '#1e293b',
            font: { size:11, weight:'bold' },
            formatter: v => (v>=0?'+':'')+'$'+v,
          }
        }]
      },
      options: {
        indexAxis: 'y',
        responsive:true, maintainAspectRatio:false,
        plugins: {
          legend:{ display:false },
          datalabels:{ display:true },
          tooltip:{ callbacks:{ label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.x>=0?'+':''}$${ctx.parsed.x}` } }
        },
        scales: {
          x: { ticks:{ color:'#334155', callback: v=>(v>=0?'+':'')+'$'+v }, grid:{ color:'rgba(148,163,184,0.2)' } },
          y: { ticks:{ color:'#334155', font:{size:12, weight:'bold'} } }
        }
      }
    });

  } else if (wtiChartMode === 'donut') {
    // ë„ë„›: ABS ì›ê°€ ë¹„ì¤‘
    const smC  = r.sm  * ABS_R.sm;
    const anC  = r.an  * ABS_R.an;
    const bdC  = r.bd  * ABS_R.bd;
    const fixC = 150;
    const total = smC + anC + bdC + fixC;

    wtiSimChart = new Chart(newCanvas, {
      type: 'doughnut',
      data: {
        labels: ['SM ì›ê°€', 'AN ì›ê°€', 'BD ì›ê°€', 'ê³ ì •ë¹„'],
        datasets: [{
          data: [Math.round(smC), Math.round(anC), Math.round(bdC), fixC],
          backgroundColor: ['rgba(59,130,246,0.8)','rgba(124,58,237,0.8)','rgba(249,115,22,0.8)','rgba(100,116,139,0.6)'],
          borderColor: ['#2563eb','#7c3aed','#ea580c','#64748b'],
          borderWidth: 2,
          hoverOffset: 8,
          datalabels: {
            display: true,
            color: '#fff',
            font: { size:11, weight:'bold' },
            formatter: (v, ctx) => {
              const pct = ((v/total)*100).toFixed(1);
              return ctx.chart.data.labels[ctx.dataIndex] + '\n$'+v+'\n('+pct+'%)';
            }
          }
        }]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins: {
          legend:{ display:true, position:'right', labels:{ font:{size:11}, color:'#334155' } },
          tooltip:{ callbacks:{ label: ctx => ` ${ctx.label}: $${ctx.parsed} (${((ctx.parsed/total)*100).toFixed(1)}%)` } },
          datalabels:{ display:true },
        }
      }
    });
  }
}

function renderWtiGauge() {
  const wti  = parseFloat(document.getElementById('slider-wti').value);
  const risk = parseFloat(document.getElementById('slider-risk').value);
  const r    = calcAll(wti, risk);

  // ABS Gap ê²Œì´ì§€ ($0~$300 ê¸°ì¤€)
  const absGapPct = Math.min(100, Math.max(0, ((r.absGap + 100) / 400) * 100));
  const absColor  = r.absGap < 0 ? '#ef4444' : r.absGap < 150 ? '#f59e0b' : '#10b981';
  const absZone   = r.absGap < 0 ? 'ğŸ”´' : r.absGap < 150 ? 'ğŸŸ¡' : 'ğŸŸ¢';
  document.getElementById('gauge-abs-zone').textContent = absZone;
  document.getElementById('gauge-abs-val').textContent  = (r.absGap>=0?'+':'')+'$'+Math.round(r.absGap);
  document.getElementById('gauge-abs-val').style.color  = absColor;
  const absFill = document.getElementById('gauge-abs-fill');
  absFill.style.width = absGapPct+'%';
  absFill.style.background = absColor;

  // SM Margin ê²Œì´ì§€
  const smPct   = Math.min(100, Math.max(0, ((r.smMargin + 200) / 600) * 100));
  const smColor = r.smMargin < -100 ? '#ef4444' : r.smMargin < 0 ? '#f59e0b' : '#10b981';
  const smZone  = r.smMargin < -100 ? 'ğŸ”´' : r.smMargin < 0 ? 'ğŸŸ¡' : 'ğŸŸ¢';
  document.getElementById('gauge-sm-zone').textContent = smZone;
  document.getElementById('gauge-sm-val').textContent  = (r.smMargin>=0?'+':'')+'$'+Math.round(r.smMargin);
  document.getElementById('gauge-sm-val').style.color  = smColor;
  const smFill = document.getElementById('gauge-sm-fill');
  smFill.style.width = smPct+'%';
  smFill.style.background = smColor;

  // í¬ë˜ì»¤ë§ˆì§„ ê²Œì´ì§€
  const crPct   = Math.min(100, Math.max(0, ((r.crackerSim + 300) / 600) * 100));
  const crColor = r.crackerSim < 0 ? '#ef4444' : r.crackerSim < 50 ? '#f59e0b' : '#10b981';
  const crZone  = r.crackerSim < 0 ? 'ğŸ”´' : r.crackerSim < 50 ? 'ğŸŸ¡' : 'ğŸŸ¢';
  document.getElementById('gauge-cr-zone').textContent = crZone;
  document.getElementById('gauge-cr-val').textContent  = (r.crackerSim>=0?'+':'')+'$'+Math.round(r.crackerSim);
  document.getElementById('gauge-cr-val').style.color  = crColor;
  const crFill = document.getElementById('gauge-cr-fill');
  crFill.style.width = crPct+'%';
  crFill.style.background = crColor;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í¬ë˜ì»¤ ì‹œë®¬ë ˆì´í„°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onCrackerSlider() {
  const et  = parseFloat(document.getElementById('cr-slider-et').value);
  const nap = parseFloat(document.getElementById('cr-slider-nap').value);
  const pr  = parseFloat(document.getElementById('cr-slider-pr').value);
  const bz  = parseFloat(document.getElementById('cr-slider-bz').value);
  const bd  = parseFloat(document.getElementById('cr-slider-bd').value);

  document.getElementById('cr-et-val').textContent  = `$${et}/mt`;
  document.getElementById('cr-nap-val').textContent  = `$${nap}/mt`;
  document.getElementById('cr-pr-val').textContent   = `$${pr}/mt`;
  document.getElementById('cr-bz-val').textContent   = `$${bz}/mt`;
  document.getElementById('cr-bd-val').textContent   = `$${bd}/mt`;

  const etC  = et  * CR_Y.et;
  const prC  = pr  * CR_Y.pr;
  const bdC  = bd  * CR_Y.bd;
  const bzC  = bz  * CR_Y.bz;
  const margin = etC + prC + bdC + bzC - nap;

  // ìˆ˜ìœ¨ ë°” ì°¨íŠ¸ (ìµœëŒ€ê°’ ê¸°ì¤€ 100%)
  const maxC = Math.max(etC, prC, bdC+bzC, nap);
  function setPct(id, val) {
    const el = document.getElementById(id);
    if (el) el.style.width = Math.max(2, (val/maxC)*100).toFixed(1)+'%';
  }
  setPct('cr-bar-et',  etC);
  setPct('cr-bar-pr',  prC);
  setPct('cr-bar-bd',  bdC);
  setPct('cr-bar-bz',  bzC);
  setPct('cr-bar-nap', nap);
  document.getElementById('cr-val-et').textContent  = `$${Math.round(etC)}`;
  document.getElementById('cr-val-pr').textContent  = `$${Math.round(prC)}`;
  document.getElementById('cr-val-bd').textContent  = `$${Math.round(bdC)}`;
  document.getElementById('cr-val-bz').textContent  = `$${Math.round(bzC)}`;
  document.getElementById('cr-val-nap').textContent = `-$${Math.round(nap)}`;
  const totalEl = document.getElementById('cr-val-total');
  totalEl.textContent = fmt(margin, true);
  totalEl.className   = 'text-sm font-black ' + (margin >= 0 ? 'text-emerald-700' : 'text-red-700');

  // ë§ˆì§„ ëŒ€í˜• í‘œì‹œ
  const bigEl = document.getElementById('cr-margin-big');
  bigEl.textContent = fmt(margin, true);
  bigEl.style.color = margin >= 0 ? '#10b981' : '#ef4444';
  const labelEl = document.getElementById('cr-margin-label');
  if (margin > 50) { labelEl.textContent='âœ… ì •ìƒ ê°€ë™ ë²”ìœ„'; labelEl.style.color='#10b981'; }
  else if (margin >= 0) { labelEl.textContent='âš  ì†ìµë¶„ê¸° ê·¼ì ‘'; labelEl.style.color='#f59e0b'; }
  else { labelEl.textContent='ğŸ”´ í¬ë˜ì»¤ ì ì â€” ê°€ë™ë¥  í•˜ë½ ì••ë ¥'; labelEl.style.color='#ef4444'; }

  // íŒ¨ë„ ìƒ‰ìƒ
  const panel = document.getElementById('cr-result-panel');
  panel.className = 'rounded-2xl p-5 border text-center ' + crackerColor(margin);

  // BD íƒ€ì´íŠ¸ ê³„ì‚°
  const crRes = calcCrackerDirect(et, pr, bd, bz, nap, G.sm_act, G.an, G.abs_mkt_act);
  const delta = crRes.crackerDelta;

  document.getElementById('cr-margin-delta').textContent = fmt(delta, true);
  document.getElementById('cr-margin-delta').className   = 'font-black text-lg ' + (delta >= 0 ? 'text-emerald-700' : 'text-red-700');
  document.getElementById('cr-bd-prem').textContent      = `+$${Math.round(crRes.bdTight)}`;
  document.getElementById('cr-bd-base').textContent      = `$${Math.round(G.bd)}`;
  document.getElementById('cr-bd-final').textContent     = `$${Math.round(crRes.bdFinal)}`;

  const acEl = document.getElementById('cr-abs-cost');
  acEl.textContent = fmt(crRes.absCost);
  const agEl = document.getElementById('cr-abs-gap');
  agEl.textContent = fmt(crRes.absGap, true);
  agEl.className   = 'font-black text-xl ' + (crRes.absGap < 0 ? 'text-red-700 alert-blink' : crRes.absGap < 150 ? 'text-amber-700' : 'text-emerald-700');
  document.getElementById('cr-abs-gap-th').textContent = fmt(crRes.absGapTh, true);

  // ê°ì‚° ì„ê³„
  document.getElementById('cr-thresh-current').textContent = fmt(margin, true);
  // ì†ìµë¶„ê¸° ET: margin=0 â†’ et = (nap - pr*0.13 - bd*0.045 - bz*0.06) / 0.30
  const breakEt = (nap + 50 - pr*CR_Y.pr - bd*CR_Y.bd - bz*CR_Y.bz) / CR_Y.et;
  document.getElementById('cr-break-et').textContent = `$${Math.round(breakEt)}/mt`;
  const room = et - breakEt;
  const roomEl = document.getElementById('cr-et-room');
  roomEl.textContent = fmt(room, true);
  roomEl.className   = 'font-black ' + (room > 100 ? 'text-emerald-700' : room > 0 ? 'text-amber-700' : 'text-red-700 alert-blink');

  // ì „ëµ
  document.getElementById('cracker-strategy').innerHTML = buildCrackerStrategy(margin, crRes.bdTight, crRes.absGap, room);
}

function resetCrackerSliders() {
  document.getElementById('cr-slider-et').value  = Math.round(G.et);
  document.getElementById('cr-slider-nap').value = Math.round(G.nap);
  document.getElementById('cr-slider-pr').value  = Math.round(G.pr_act);
  document.getElementById('cr-slider-bz').value  = Math.round(G.bz);
  document.getElementById('cr-slider-bd').value  = Math.round(G.bd);
  onCrackerSlider();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì „ëµ ì¸ì‚¬ì´íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildStrategy(r) {
  if (r.absGap < 0)          return `<span class="text-red-700 font-bold">ğŸ”´ ì—­ë§ˆì§„ â€” ì¦‰ì‹œ ê³„ì•½ ì¬ì¡°ì •. ì—°ì¥ ê¸ˆì§€.</span>`;
  if (r.bdTight > 80)        return `<span class="text-red-700 font-bold">ğŸ”´ BD ì‹¬ê° íƒ€ì´íŠ¸(+$${Math.round(r.bdTight)}) â€” í¬ë˜ì»¤ ê°€ë™ë¥  í•˜ë½. ABS Cost ê¸‰ë“± ì••ë ¥.</span>`;
  if (r.smMarginTh < -100)   return `<span class="text-orange-700 font-bold">ğŸŸ  SM ì´ë¡ ë§ˆì§„ ì ì($${Math.round(r.smMarginTh)}) â€” SM ë©”ì´ì»¤ ê°ì‚° ì„ë°•. ê³µê¸‰ ì¶•ì†Œ ëŒ€ë¹„.</span>`;
  if (r.absGap < 150)        return `<span class="text-amber-700">ğŸŸ¡ Gap ì¶•ì†Œ â€” ì¬ê³  ìµœì†Œí™”. WTI $80 ëŒíŒŒ ì‹œ ì¦‰ì‹œ ì¬í‰ê°€.</span>`;
  return `<span class="text-emerald-700">ğŸŸ¢ ì •ìƒ â€” í˜„í–‰ êµ¬ë§¤ ì „ëµ ìœ ì§€.</span>`;
}

function buildCrackerStrategy(margin, bdTight, absGap, etRoom) {
  if (margin < -100)
    return `<span class="text-red-700 font-bold">ğŸ”´ í¬ë˜ì»¤ ì‹¬ê° ì ì(${fmt(margin,true)}) â€” ê°€ë™ë¥  í•˜ë½ ì„ë°•. BD ê³µê¸‰ ê¸‰ê° ëŒ€ë¹„. ì„ ë§¤ì… ê²€í† .</span>`;
  if (margin < 0)
    return `<span class="text-orange-700 font-bold">ğŸŸ  í¬ë˜ì»¤ ì ì ì§„ì… â€” BD íƒ€ì´íŠ¸ í”„ë¦¬ë¯¸ì—„ +$${Math.round(bdTight)} ë°˜ì˜ë¨. ABS Gap ì••ë°•.</span>`;
  if (etRoom < 50)
    return `<span class="text-amber-700">ğŸŸ¡ ET ì¶”ê°€ í•˜ë½ ì—¬ìœ  $${Math.round(etRoom)} ë¯¸ë§Œ â€” ì†ìµë¶„ê¸° ê·¼ì ‘. BD ìˆ˜ê¸‰ ëª¨ë‹ˆí„°ë§ ê°•í™”.</span>`;
  return `<span class="text-emerald-700">ğŸŸ¢ í¬ë˜ì»¤ ì •ìƒ â€” BD ê³µê¸‰ ì•ˆì •. í˜„í–‰ ì¡°ë‹¬ ì „ëµ ìœ ì§€.</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì‹œë‚˜ë¦¬ì˜¤ í…Œì´ë¸”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SCENARIOS = [
  {label:'Base $59',     wti:59.44, risk:0,   color:'#10b981'},
  {label:'Mild $70',     wti:70,    risk:50,  color:'#f59e0b'},
  {label:'Moderate $80', wti:80,    risk:100, color:'#f97316'},
  {label:'Severe $90',   wti:90,    risk:150, color:'#ef4444'},
  {label:'Crisis $100',  wti:100,   risk:200, color:'#b91c1c'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¯¼ê°ë„ íƒ­ 4ê°œ ì°¨íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ê¸°ë³¸ SENS ê°’ (Before ë¹„êµ ê¸°ì¤€)
const SENS_DEFAULT = { bz:16.81, et:6.13, bd:20.48, an:7.87, sm:14.75, nap:6.52, pr:4.18 };

// â‘  WTI êµ¬ê°„ë³„ ë¯¼ê°ë„ íˆíŠ¸ë§µ
function renderSensHeatmap() {
  const el = document.getElementById('sens-heatmap-table');
  if (!el) return;
  const items = [
    { key:'nap', label:'NAP', color:'#64748b' },
    { key:'bz',  label:'BZ',  color:'#a855f7' },
    { key:'et',  label:'ET',  color:'#10b981' },
    { key:'bd',  label:'BD',  color:'#f97316' },
    { key:'an',  label:'AN',  color:'#7c3aed' },
    { key:'sm',  label:'SM',  color:'#3b82f6' },
    { key:'pr',  label:'PR',  color:'#06b6d4' },
  ];
  // WTI $1 ìƒìŠ¹ ê¸°ì¤€ì´ë¼ êµ¬ê°„ë³„ ê°’ì€ SENS ìì²´ê°€ ì„ í˜• â€” êµ¬ê°„ë³„ WTI ì ˆëŒ€ê°€ê²©ì—ì„œ ì›ë£Œê°€ ê³„ì‚°
  const wtiRange = [50, 60, 67, 70, 80, 90, 100];
  const maxSens = Math.max(...items.map(i => SENS[i.key] || 0));

  const header = `<thead><tr>
    <th class="px-3 py-2 bg-slate-700 text-white border border-slate-600 text-center">ì›ë£Œ</th>
    ${wtiRange.map(w => `<th class="px-3 py-2 bg-slate-700 text-white border border-slate-600 text-center">WTI $${w}</th>`).join('')}
    <th class="px-3 py-2 bg-slate-700 text-white border border-slate-600 text-center">ë¯¼ê°ë„(SENS)</th>
  </tr></thead>`;

  const body = `<tbody>${items.map(item => {
    const s = SENS[item.key] || 0;
    const intensity = s / maxSens;  // 0~1
    const r = Math.round(255 - intensity * 180);
    const g = Math.round(255 - intensity * 100);
    const b = 255;
    return `<tr>
      <td class="px-3 py-2 font-black text-center border border-slate-200" style="color:${item.color};background:#f8fafc">${item.label}</td>
      ${wtiRange.map(w => {
        const baseWti = G.wti_rt;
        const basePrice = (G[item.key] || G[item.key+'_act'] || 700) + (w - baseWti) * s;
        const alpha = 0.15 + intensity * 0.65;
        return `<td class="px-3 py-2 text-center font-bold border border-slate-200" style="background:rgba(${Math.round(239*intensity)},${Math.round(68*intensity+180*(1-intensity))},${Math.round(68*intensity+246*(1-intensity))},${alpha});color:#1e293b">$${Math.round(basePrice)}</td>`;
      }).join('')}
      <td class="px-3 py-2 text-center font-black border border-slate-200" style="background:rgba(239,68,68,${0.1+intensity*0.5});color:${intensity>0.5?'#7f1d1d':'#1e293b'}">+$${s.toFixed(2)}</td>
    </tr>`;
  }).join('')}</tbody>`;

  el.innerHTML = header + body;
}

// â‘¡ ABS ì›ê°€ ê¸°ì—¬ ë¶„í•´ ì°¨íŠ¸
let sensContribChart = null;
function renderSensContribChart() {
  const canvas = document.getElementById('sens-contrib-chart');
  if (!canvas) return;
  const newCanvas = canvas.cloneNode(true);
  canvas.parentNode.replaceChild(newCanvas, canvas);

  // WTI $1 ìƒìŠ¹ â†’ SMì›ê°€ ê¸°ì—¬: SENS.sm * ABS_R.sm
  // AN: SENS.an * ABS_R.an,  BD: SENS.bd * ABS_R.bd
  const smContrib = parseFloat((SENS.sm * ABS_R.sm).toFixed(2));
  const anContrib = parseFloat((SENS.an * ABS_R.an).toFixed(2));
  const bdContrib = parseFloat((SENS.bd * ABS_R.bd).toFixed(2));
  const total     = smContrib + anContrib + bdContrib;

  sensContribChart = new Chart(newCanvas, {
    type: 'bar',
    data: {
      labels: ['SM ê¸°ì—¬\n(SENSÃ—0.60)', 'AN ê¸°ì—¬\n(SENSÃ—0.25)', 'BD ê¸°ì—¬\n(SENSÃ—0.15)', 'í•©ê³„ ABSì›ê°€ ë³€í™”'],
      datasets: [{
        label: 'WTI $1 ìƒìŠ¹ â†’ ABS ì›ê°€ ì „ê°€ ($/mt)',
        data: [smContrib, anContrib, bdContrib, total],
        backgroundColor: ['rgba(59,130,246,0.8)','rgba(124,58,237,0.8)','rgba(249,115,22,0.8)','rgba(16,185,129,0.8)'],
        borderColor: ['#2563eb','#7c3aed','#ea580c','#059669'],
        borderWidth: 2, borderRadius: 6,
        datalabels: {
          display: true, anchor:'end', align:'top',
          color: '#1e293b', font:{ size:11, weight:'bold' },
          formatter: v => '+$'+v.toFixed(2),
        }
      }]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: {
        legend:{ display:false },
        datalabels:{ display:true },
        tooltip:{ callbacks:{ label: ctx => ` WTI +$1 â†’ ABSì›ê°€ +$${ctx.parsed.y.toFixed(2)}` } }
      },
      scales: {
        x:{ ticks:{ color:'#334155', font:{size:10} }, grid:{ color:'rgba(148,163,184,0.15)' } },
        y:{ ticks:{ color:'#334155', callback: v => '+$'+v }, grid:{ color:'rgba(148,163,184,0.2)' },
            title:{ display:true, text:'ABS ì›ê°€ ë³€í™” ($/mt per $1 WTI)', color:'#64748b', font:{size:10} } }
      }
    }
  });
}

// â‘¢ RÂ² ê²Œì´ì§€ ë Œë”ë§
function renderR2Gauges() {
  const el = document.getElementById('sens-r2-gauges');
  if (!el) return;
  const items = [
    { label:'BZ',  key:'bz',      color:'#a855f7' },
    { label:'ET',  key:'et',      color:'#10b981' },
    { label:'BD',  key:'bd',      color:'#f97316' },
    { label:'AN',  key:'an',      color:'#7c3aed' },
    { label:'SM',  key:'sm',      color:'#3b82f6' },
    { label:'NAP', key:'nap',     color:'#64748b' },
    { label:'ABS Mkt', key:'abs_mkt', color:'#06b6d4' },
    { label:'SM Cost', key:'sm_cost', color:'#ec4899' },
  ];

  el.innerHTML = items.map(item => {
    const r2El = document.getElementById('r2-'+item.key);
    const r2Text = r2El ? r2El.textContent : 'RÂ²=--';
    const r2Val  = parseFloat(r2Text.replace('RÂ²=','')) || 0;
    const pct    = Math.round(r2Val * 100);
    const barColor = r2Val >= 0.7 ? '#10b981' : r2Val >= 0.4 ? '#f59e0b' : '#ef4444';
    const grade    = r2Val >= 0.7 ? 'ë†’ìŒ âœ…' : r2Val >= 0.4 ? 'ë³´í†µ âš ' : 'ë‚®ìŒ ğŸ”´';
    const gradeColor = r2Val >= 0.7 ? '#065f46' : r2Val >= 0.4 ? '#713f12' : '#7f1d1d';
    return `<div class="bg-white rounded-xl border border-slate-200 p-3">
      <div class="flex justify-between items-center mb-2">
        <span class="font-black text-sm" style="color:${item.color}">${item.label}</span>
        <span class="text-xs font-bold" style="color:${gradeColor}">${grade}</span>
      </div>
      <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden mb-1">
        <div class="h-full rounded-full transition-all duration-700" style="width:${pct}%;background:${barColor}"></div>
      </div>
      <div class="flex justify-between text-xs text-slate-600">
        <span>RÂ²</span>
        <span class="font-black" style="color:${barColor}">${r2Val > 0 ? r2Val.toFixed(2) : '--'}</span>
      </div>
    </div>`;
  }).join('');
}

// â‘£ Before/After ì›ê°€ ì‹œë®¬ ì°¨íŠ¸
let sensBaChart = null;
function renderSensBeforeAfter() {
  const wti = G.wti_rt;

  // Before: ê¸°ë³¸ SENS ê¸°ì¤€ ì›ë£Œê°€
  const calcPrice = (sensObj, key) => {
    const base = G[key] || G[key+'_act'] || 700;
    return base; // í˜„ì¬ WTI ê¸°ì¤€ì´ë¼ dWti=0
  };
  const smBefore = G.sm_act;
  const anBefore = G.an;
  const bdBefore = G.bd;
  const absBefore= smBefore*ABS_R.sm + anBefore*ABS_R.an + bdBefore*ABS_R.bd;

  // After: í˜„ì¬ SENS (ë³€ê²½ëœ ê²½ìš°) ê¸°ì¤€ â€” WTI $10 ìƒìŠ¹ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ë¹„êµ
  const dWti = 10;
  const smAfterB = smBefore + dWti * SENS_DEFAULT.sm;
  const anAfterB = anBefore + dWti * SENS_DEFAULT.an;
  const bdAfterB = bdBefore + dWti * SENS_DEFAULT.bd;
  const absAfterDefault = smAfterB*ABS_R.sm + anAfterB*ABS_R.an + bdAfterB*ABS_R.bd;

  const smAfterC = smBefore + dWti * SENS.sm;
  const anAfterC = anBefore + dWti * SENS.an;
  const bdAfterC = bdBefore + dWti * SENS.bd;
  const absAfterCurrent = smAfterC*ABS_R.sm + anAfterC*ABS_R.an + bdAfterC*ABS_R.bd;

  const diff = absAfterCurrent - absAfterDefault;
  const pct  = ((diff / absAfterDefault) * 100).toFixed(1);

  // ì¹´ë“œ ì—…ë°ì´íŠ¸
  document.getElementById('ba-before').textContent = '$' + Math.round(absAfterDefault);
  document.getElementById('ba-after').textContent  = '$' + Math.round(absAfterCurrent);
  const diffEl = document.getElementById('ba-diff');
  diffEl.textContent = (diff >= 0 ? '+' : '') + '$' + Math.round(diff);
  diffEl.className   = 'text-2xl font-black ' + (diff >= 0 ? 'text-red-600' : 'text-emerald-600');
  document.getElementById('ba-diff-pct').textContent = (diff >= 0 ? '+' : '') + pct + '%  (WTI +$10 ì‹œë‚˜ë¦¬ì˜¤ ê¸°ì¤€)';

  // ì°¨íŠ¸
  const canvas = document.getElementById('sens-ba-chart');
  if (!canvas) return;
  const newCanvas = canvas.cloneNode(true);
  canvas.parentNode.replaceChild(newCanvas, canvas);

  const labels   = ['í˜„ì¬ê°€\n(ê¸°ì¤€)', 'WTI +$10\nê¸°ë³¸ SENS', 'WTI +$10\ní˜„ì¬ SENS'];
  const absVals  = [Math.round(absBefore), Math.round(absAfterDefault), Math.round(absAfterCurrent)];

  sensBaChart = new Chart(newCanvas, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'SM ì›ê°€',
          data: [
            Math.round(smBefore * ABS_R.sm),
            Math.round(smAfterB * ABS_R.sm),
            Math.round(smAfterC * ABS_R.sm),
          ],
          backgroundColor: 'rgba(59,130,246,0.8)', borderColor:'#2563eb', borderWidth:2, borderRadius:4,
          datalabels:{ display:false }
        },
        {
          label: 'AN ì›ê°€',
          data: [
            Math.round(anBefore * ABS_R.an),
            Math.round(anAfterB * ABS_R.an),
            Math.round(anAfterC * ABS_R.an),
          ],
          backgroundColor: 'rgba(124,58,237,0.8)', borderColor:'#7c3aed', borderWidth:2, borderRadius:4,
          datalabels:{ display:false }
        },
        {
          label: 'BD ì›ê°€',
          data: [
            Math.round(bdBefore * ABS_R.bd),
            Math.round(bdAfterB * ABS_R.bd),
            Math.round(bdAfterC * ABS_R.bd),
          ],
          backgroundColor: 'rgba(249,115,22,0.8)', borderColor:'#ea580c', borderWidth:2, borderRadius:4,
          datalabels:{
            display: true, anchor:'end', align:'top',
            color: '#1e293b', font:{ size:10, weight:'bold' },
            formatter: (v, ctx) => {
              const total = ctx.chart.data.datasets.reduce((s,ds) => s + (ds.data[ctx.dataIndex]||0), 0);
              return '$'+total;
            }
          }
        },
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: {
        legend:{ display:true, position:'top', labels:{ font:{size:11}, color:'#334155' } },
        datalabels:{ display:false },
        tooltip:{ mode:'index', intersect:false, callbacks:{ label: ctx => ` ${ctx.dataset.label}: $${ctx.parsed.y}` } }
      },
      scales: {
        x:{ stacked:true, ticks:{color:'#334155',font:{size:10}}, grid:{color:'rgba(148,163,184,0.15)'} },
        y:{ stacked:true, ticks:{color:'#334155',callback:v=>'$'+v}, grid:{color:'rgba(148,163,184,0.2)'} }
      }
    }
  });
}

function renderSensCharts() {
  setTimeout(() => {
    renderSensHeatmap();
    renderSensContribChart();
    renderR2Gauges();
    renderSensBeforeAfter();
  }, 150);
}


let scChart = null;
let scChartMode = 'gap';

const SC_ITEMS = {
  absGap:   { on:true,  label:'ABS Gap ì‹¤ì¸¡',  color:'rgba(16,185,129,',  key:'absGap'   },
  smMargin: { on:true,  label:'SM Margin ì‹¤ì¸¡', color:'rgba(59,130,246,',  key:'smMargin' },
  cracker:  { on:true,  label:'í¬ë˜ì»¤ë§ˆì§„',      color:'rgba(249,115,22,',  key:'crackerSim'},
  bdTight:  { on:false, label:'BD íƒ€ì´íŠ¸ í”„ë¦¬ë¯¸ì—„',color:'rgba(239,68,68,', key:'bdTight'  },
};

const SC_BTN_ON  = { absGap:'bg-emerald-100 text-emerald-700 border-emerald-300', smMargin:'bg-blue-100 text-blue-700 border-blue-300', cracker:'bg-orange-100 text-orange-700 border-orange-300', bdTight:'bg-red-100 text-red-700 border-red-300' };
const SC_BTN_OFF = 'bg-slate-50 text-slate-400 border-slate-200';

function toggleScItem(key) {
  SC_ITEMS[key].on = !SC_ITEMS[key].on;
  const btn = document.getElementById('si-'+key);
  if (btn) btn.className = `si-btn text-xs px-2 py-1 rounded border font-bold transition ${SC_ITEMS[key].on ? SC_BTN_ON[key] : SC_BTN_OFF}`;
  renderScenarioChart();
}

function setScChartMode(mode) {
  scChartMode = mode;
  document.querySelectorAll('.sct-btn').forEach(b => b.className = 'sct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300');
  const active = document.getElementById('sct-'+mode);
  if (active) active.className = 'sct-btn text-xs px-2 py-1 rounded border font-bold transition bg-slate-700 text-white border-slate-600';
  renderScenarioChart();
}

// íˆíŠ¸ë§µ ì…€ ìƒ‰ìƒ
function heatColor(v, type) {
  if (type === 'absGap')   return v >= 150 ? '#bbf7d0' : v >= 0 ? '#fef9c3' : '#fecaca';
  if (type === 'smMargin') return v >= 0   ? '#bbf7d0' : v >= -100 ? '#fef9c3' : '#fecaca';
  if (type === 'cracker')  return v >= 50  ? '#bbf7d0' : v >= 0 ? '#fef9c3' : '#fecaca';
  if (type === 'bdTight')  return v <= 0   ? '#bbf7d0' : v <= 80 ? '#fef9c3' : '#fecaca';
  if (type === 'absCost')  return v <= 1200 ? '#bbf7d0' : v <= 1400 ? '#fef9c3' : '#fecaca';
  return '#f1f5f9';
}
function heatText(v, type) {
  if (type === 'absGap')   return v >= 150 ? '#065f46' : v >= 0 ? '#713f12' : '#7f1d1d';
  if (type === 'smMargin') return v >= 0   ? '#065f46' : v >= -100 ? '#713f12' : '#7f1d1d';
  if (type === 'cracker')  return v >= 50  ? '#065f46' : v >= 0 ? '#713f12' : '#7f1d1d';
  if (type === 'bdTight')  return v <= 0   ? '#065f46' : v <= 80 ? '#713f12' : '#7f1d1d';
  if (type === 'absCost')  return v <= 1200 ? '#065f46' : v <= 1400 ? '#713f12' : '#7f1d1d';
  return '#334155';
}

function renderScenarioHeatmap() {
  const el = document.getElementById('scenario-heatmap');
  if (!el) return;
  const cols = [
    { label:'ì‹œë‚˜ë¦¬ì˜¤',   key:null,        type:null        },
    { label:'ABS Gap ì‹¤ì¸¡ â‘¢', key:'absGap',    type:'absGap'   },
    { label:'ABS Gap ì´ë¡  â‘£', key:'absGapTh',  type:'absGap'   },
    { label:'SM Margin ì‹¤ì¸¡ â‘ ', key:'smMargin',  type:'smMargin' },
    { label:'SM Margin ì´ë¡  â‘¡', key:'smMarginTh',type:'smMargin' },
    { label:'í¬ë˜ì»¤ë§ˆì§„', key:'crackerSim', type:'cracker'  },
    { label:'BD íƒ€ì´íŠ¸',  key:'bdTight',   type:'bdTight'  },
    { label:'ABS ì›ê°€',   key:'absCost',   type:'absCost'  },
    { label:'êµ¬ë§¤ì‹ í˜¸',   key:null,        type:'signal'   },
  ];

  const headerRow = `<tr>${cols.map(c =>
    `<th class="px-3 py-2 text-center font-bold text-slate-700 bg-slate-700 text-white border border-slate-600 whitespace-nowrap">${c.label}</th>`
  ).join('')}</tr>`;

  const bodyRows = SCENARIOS.map(s => {
    const r = calcAll(s.wti, s.risk);
    const signal = r.absGap >= 150 ? 'âœ… ë§¤ìˆ˜' : r.absGap >= 0 ? 'âš  ê´€ë§' : 'ğŸ”´ ìœ„í—˜';
    const sigBg  = r.absGap >= 150 ? '#bbf7d0' : r.absGap >= 0 ? '#fef9c3' : '#fecaca';
    const sigTx  = r.absGap >= 150 ? '#065f46' : r.absGap >= 0 ? '#713f12' : '#7f1d1d';
    return `<tr>${cols.map(c => {
      if (!c.key && c.type !== 'signal') {
        return `<td class="px-3 py-2 font-black text-center border border-slate-200 whitespace-nowrap" style="background:${s.color}22;color:${s.color}">${s.label}</td>`;
      }
      if (c.type === 'signal') {
        return `<td class="px-3 py-2 font-black text-center border border-slate-200 whitespace-nowrap" style="background:${sigBg};color:${sigTx}">${signal}</td>`;
      }
      const v  = Math.round(r[c.key]);
      const bg = heatColor(v, c.type);
      const tx = heatText(v, c.type);
      const prefix = c.type === 'absCost' || c.type === 'bdTight' ? '' : (v >= 0 ? '+' : '');
      return `<td class="px-3 py-2 font-black text-center border border-slate-200 whitespace-nowrap" style="background:${bg};color:${tx}">${prefix}$${v}</td>`;
    }).join('')}</tr>`;
  }).join('');

  el.innerHTML = `<thead>${headerRow}</thead><tbody>${bodyRows}</tbody>`;
}

function renderScenarioChart() {
  const canvas = document.getElementById('scenario-chart');
  if (!canvas) return;
  const newCanvas = canvas.cloneNode(true);
  canvas.parentNode.replaceChild(newCanvas, canvas);

  const labels  = SCENARIOS.map(s => s.label);
  const wtiVals = SCENARIOS.map(s => s.wti);
  const data    = SCENARIOS.map(s => calcAll(s.wti, s.risk));
  const colors  = SCENARIOS.map(s => s.color);

  if (scChartMode === 'gap') {
    // ABS Gap ë¼ì¸ + êµ¬ë§¤ì¡´ ë°°ê²½
    const activeItems = Object.values(SC_ITEMS).filter(v => v.on);
    const datasets = activeItems.map(item => ({
      label: item.label,
      data: data.map(r => Math.round(r[item.key])),
      borderColor: item.color + '1)',
      backgroundColor: item.color + '0.15)',
      fill: false,
      tension: 0.4,
      borderWidth: 2.5,
      pointRadius: 6,
      pointBackgroundColor: data.map(r => {
        const v = r[item.key];
        return v >= 150 ? '#10b981' : v >= 0 ? '#f59e0b' : '#ef4444';
      }),
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      datalabels: {
        display: true,
        anchor: 'end', align: 'top',
        color: '#1e293b',
        font: { size: 10, weight: 'bold' },
        formatter: v => (v >= 0 ? '+' : '') + '$' + v,
      }
    }));

    scChart = new Chart(newCanvas, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { font:{size:11}, color:'#334155' } },
          datalabels: { display: true },
          annotation: {
            annotations: {
              buyZone:   { type:'box', yMin:150,  yMax:600,  backgroundColor:'rgba(16,185,129,0.07)',  borderWidth:0, label:{display:true,content:'âœ… ë§¤ìˆ˜ì¡´',  position:{x:'start',y:'start'}, color:'#059669', font:{size:10}} },
              watchZone: { type:'box', yMin:0,    yMax:150,  backgroundColor:'rgba(245,158,11,0.07)', borderWidth:0, label:{display:true,content:'âš  ê´€ë§ì¡´',   position:{x:'start',y:'start'}, color:'#d97706', font:{size:10}} },
              riskZone:  { type:'box', yMin:-400, yMax:0,    backgroundColor:'rgba(239,68,68,0.07)',  borderWidth:0, label:{display:true,content:'ğŸ”´ ìœ„í—˜ì¡´',  position:{x:'start',y:'start'}, color:'#dc2626', font:{size:10}} },
              zeroLine:  { type:'line', yMin:0, yMax:0, borderColor:'rgba(239,68,68,0.5)', borderWidth:1.5, borderDash:[4,3] },
              buyLine:   { type:'line', yMin:150, yMax:150, borderColor:'rgba(16,185,129,0.5)', borderWidth:1.5, borderDash:[4,3] },
            }
          },
          tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y >= 0 ? '+' : ''}$${ctx.parsed.y}` } }
        },
        scales: {
          x: { ticks:{ color:'#334155', font:{size:11} }, grid:{ color:'rgba(148,163,184,0.15)' } },
          y: { ticks:{ color:'#334155', callback: v => (v>=0?'+':'')+'$'+v }, grid:{ color:'rgba(148,163,184,0.2)' } }
        }
      }
    });

  } else if (scChartMode === 'cost') {
    // ì›ê°€ êµ¬ì¡° ìŠ¤íƒ ì˜ì—­ + ABS ì‹œì¥ê°€ ë¼ì¸
    const smCosts = data.map(r => Math.round(r.sm  * ABS_R.sm));
    const anCosts = data.map(r => Math.round(r.an  * ABS_R.an));
    const bdCosts = data.map(r => Math.round(r.bd  * ABS_R.bd));
    const absMkts = data.map(r => Math.round(r.absMkt));

    scChart = new Chart(newCanvas, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label:'SM ì›ê°€', data:smCosts, borderColor:'rgba(59,130,246,1)', backgroundColor:'rgba(59,130,246,0.4)', fill:true, stack:'cost', tension:0.4, borderWidth:2, pointRadius:4, datalabels:{display:false} },
          { label:'AN ì›ê°€', data:anCosts, borderColor:'rgba(217,119,6,1)',  backgroundColor:'rgba(217,119,6,0.4)',  fill:true, stack:'cost', tension:0.4, borderWidth:2, pointRadius:4, datalabels:{display:false} },
          { label:'BD ì›ê°€', data:bdCosts, borderColor:'rgba(249,115,22,1)', backgroundColor:'rgba(249,115,22,0.4)', fill:true, stack:'cost', tension:0.4, borderWidth:2, pointRadius:4, datalabels:{display:false} },
          { label:'ABS ì‹œì¥ê°€', data:absMkts, borderColor:'#1e293b', backgroundColor:'transparent', fill:false, tension:0.4, borderWidth:2.5, borderDash:[5,4], pointRadius:6, pointBackgroundColor:'#1e293b', datalabels:{ display:true, anchor:'end', align:'top', color:'#1e293b', font:{size:10,weight:'bold'}, formatter:v=>'$'+v } },
        ]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins: {
          legend:{ display:true, position:'top', labels:{font:{size:11},color:'#334155'} },
          datalabels:{ display:false },
          tooltip:{ callbacks:{ label: ctx => ` ${ctx.dataset.label}: $${ctx.parsed.y}` } }
        },
        scales: {
          x:{ stacked:true, ticks:{color:'#334155',font:{size:11}}, grid:{color:'rgba(148,163,184,0.15)'} },
          y:{ stacked:true, ticks:{color:'#334155',callback:v=>'$'+v}, grid:{color:'rgba(148,163,184,0.2)'} }
        }
      }
    });

  } else if (scChartMode === 'margin') {
    // SM/ABS ì‹¤ì¸¡Â·ì´ë¡  ë§ˆì§„ 4ê°œ ë¼ì¸
    const activeItems = Object.values(SC_ITEMS).filter(v => v.on);
    scChart = new Chart(newCanvas, {
      type: 'bar',
      data: {
        labels,
        datasets: activeItems.map(item => ({
          label: item.label,
          data: data.map(r => Math.round(r[item.key])),
          backgroundColor: data.map(r => {
            const v = r[item.key];
            return item.color + (v >= 0 ? '0.75)' : '0.4)');
          }),
          borderColor: item.color + '1)',
          borderWidth: 2,
          borderRadius: 6,
          datalabels: {
            display: true,
            anchor: d => data[d.dataIndex][item.key] >= 0 ? 'end' : 'start',
            align:  d => data[d.dataIndex][item.key] >= 0 ? 'top' : 'bottom',
            color: '#1e293b',
            font: { size: 9, weight: 'bold' },
            formatter: v => (v>=0?'+':'')+'$'+v,
          }
        }))
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins: {
          legend:{ display:true, position:'top', labels:{font:{size:11},color:'#334155'} },
          datalabels:{ display:true },
          tooltip:{ callbacks:{ label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y>=0?'+':''}$${ctx.parsed.y}` } }
        },
        scales: {
          x:{ ticks:{color:'#334155',font:{size:11}}, grid:{color:'rgba(148,163,184,0.15)'} },
          y:{ ticks:{color:'#334155',callback:v=>(v>=0?'+':'')+'$'+v}, grid:{color:'rgba(148,163,184,0.2)'} }
        }
      }
    });

  } else if (scChartMode === 'cracker') {
    // í¬ë˜ì»¤ë§ˆì§„ + BD íƒ€ì´íŠ¸ ì½¤ë³´
    const crackerVals = data.map(r => Math.round(r.crackerSim));
    const bdTightVals = data.map(r => Math.round(r.bdTight));

    scChart = new Chart(newCanvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'í¬ë˜ì»¤ë§ˆì§„',
            data: crackerVals,
            backgroundColor: crackerVals.map(v => v >= 50 ? 'rgba(16,185,129,0.75)' : v >= 0 ? 'rgba(245,158,11,0.75)' : 'rgba(239,68,68,0.75)'),
            borderColor: crackerVals.map(v => v >= 50 ? '#059669' : v >= 0 ? '#d97706' : '#dc2626'),
            borderWidth: 2, borderRadius: 6,
            datalabels: { display:true, anchor:'end', align:'top', color:'#1e293b', font:{size:10,weight:'bold'}, formatter:v=>(v>=0?'+':'')+'$'+v }
          },
          {
            label: 'BD íƒ€ì´íŠ¸ í”„ë¦¬ë¯¸ì—„',
            data: bdTightVals,
            type: 'line',
            borderColor: 'rgba(239,68,68,0.9)',
            backgroundColor: 'rgba(239,68,68,0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 2.5,
            pointRadius: 5,
            pointBackgroundColor: '#ef4444',
            datalabels: { display:true, anchor:'end', align:'top', color:'#ef4444', font:{size:10,weight:'bold'}, formatter:v=>'+$'+v }
          }
        ]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins: {
          legend:{ display:true, position:'top', labels:{font:{size:11},color:'#334155'} },
          datalabels:{ display:false },
          tooltip:{ callbacks:{ label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y>=0?'+':''}$${ctx.parsed.y}` } }
        },
        scales: {
          x:{ ticks:{color:'#334155',font:{size:11}}, grid:{color:'rgba(148,163,184,0.15)'} },
          y:{ ticks:{color:'#334155',callback:v=>(v>=0?'+':'')+'$'+v}, grid:{color:'rgba(148,163,184,0.2)'} }
        }
      }
    });
  }
}

function renderScenarios() {
  // ê¸°ì¡´ í…ìŠ¤íŠ¸ í…Œì´ë¸”
  document.getElementById('scenario-table').innerHTML = SCENARIOS.map(s => {
    const r  = calcAll(s.wti, s.risk);
    const gc = r.absGap < 0 ? '#ef4444' : r.absGap < 150 ? '#f59e0b' : '#10b981';
    const cc = r.crackerSim < 0 ? '#ef4444' : r.crackerSim < 50 ? '#f59e0b' : '#10b981';
    return `<div class="scenario-row" style="border-left-color:${s.color}">
      <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs md:text-sm">
        <span class="font-black w-24" style="color:${s.color}">${s.label}</span>
        <span class="text-slate-700 w-20">Risk <b class="text-orange-700">+$${s.risk}</b></span>
        <span class="text-slate-700 w-28">BD <b class="text-orange-700">${fmt(r.bd)}</b></span>
        <span class="text-slate-700 w-28">BDíƒ€ì´íŠ¸ <b class="text-orange-700">+$${Math.round(r.bdTight)}</b></span>
        <span class="w-36">í¬ë˜ì»¤ <b style="color:${cc}">${fmt(r.crackerSim,true)}</b></span>
        <span class="text-slate-700 w-32">SMì‹¤ì¸¡ <b class="${r.smMargin>=0?'text-emerald-700':'text-red-700'}">${fmt(r.smMargin,true)}</b></span>
        <span class="text-slate-700 w-32">SMì´ë¡  <b class="${r.smMarginTh>=0?'text-blue-700':'text-purple-700'}">${fmt(r.smMarginTh,true)}</b></span>
        <span class="w-32">ABSì‹¤ì¸¡ <b style="color:${gc}" class="font-black">${fmt(r.absGap,true)}</b></span>
        <span class="w-32">ABSì´ë¡  <b class="text-amber-700">${fmt(r.absGapTh,true)}</b></span>
      </div>
    </div>`;
  }).join('');

  // íˆíŠ¸ë§µ + ì°¨íŠ¸
  setTimeout(() => {
    renderScenarioHeatmap();
    setScChartMode('gap');
  }, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV ë¡œë“œ & ë©”ì¸ ëŒ€ì‹œë³´ë“œ ê°±ì‹ 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSensCard(id, v, r2v) {
  const el = document.getElementById('sens-'+id);
  const r2el = document.getElementById('r2-'+id);
  if (!el) return;
  const n = parseFloat(v);
  if (!isNaN(n)) { el.textContent=(n>=0?'+':'')+n.toFixed(2); el.className='text-lg font-black '+(n<0?'text-green-700':'text-amber-700'); }
  if (r2el) { const r=parseFloat(r2v); if(!isNaN(r)){r2el.textContent='RÂ²='+r.toFixed(2); r2el.className='text-xs mt-1 '+(r>=0.5?'text-emerald-700':r>=0.3?'text-amber-800':'text-red-700');} }
}

function updateDashboard() {
  const rt = calcAll(G.wti_rt, 0);

  // í—¤ë” KPI
  document.getElementById('hdr-wti').textContent    = `$${G.wti_rt.toFixed(2)}`;
  // Flat ë²„íŠ¼ ë ˆì´ë¸” ì‹¤ì‹œê°„ WTI ë°˜ì˜
  const flatLabel = document.getElementById('fc-flat-wti-label');
  if (flatLabel) flatLabel.textContent = `$${G.wti_rt.toFixed(1)}`;
  const cmEl = document.getElementById('hdr-cracker');
  cmEl.textContent = fmt(rt.crackerSim, true);
  cmEl.className   = 'text-2xl font-black ' + (rt.crackerSim >= 0 ? 'text-emerald-700' : 'text-red-700');
  document.getElementById('hdr-bd-tight').textContent = `+$${Math.round(rt.bdTight)}`;
  const smMHdr = document.getElementById('hdr-sm-margin');
  smMHdr.textContent = fmt(rt.smMargin, true);
  smMHdr.className   = 'text-2xl font-black ' + (rt.smMargin >= 0 ? 'text-emerald-700' : 'text-red-700');
  const agHdr = document.getElementById('hdr-abs-gap');
  agHdr.textContent = fmt(rt.absGap, true);
  agHdr.className   = 'text-2xl font-black ' + (rt.absGap < 0 ? 'text-red-500 alert-blink' : rt.absGap < 150 ? 'text-amber-700' : 'text-emerald-700');
  document.getElementById('hdr-abs-gap-theory').textContent = `ì´ë¡  ${fmt(rt.absGapTh,true)}`;
  document.getElementById('alert-badge').innerHTML = alertBadge(rt.absGap, rt.bdTight);

  // ì›ë£Œ ì¹´ë“œ
  document.getElementById('c-wti').textContent       = `$${G.wti_rt.toFixed(2)}`;
  document.getElementById('c-nap').textContent       = `$${Math.round(rt.nap)}`;
  document.getElementById('c-bz').textContent        = fmt(rt.bz);
  document.getElementById('c-bz-act').textContent    = `ì‹¤ì¸¡ $${Math.round(G.bz)}`;
  document.getElementById('c-et').textContent        = fmt(rt.et);
  document.getElementById('c-et-act').textContent    = `ì‹¤ì¸¡ $${Math.round(G.et)}`;
  document.getElementById('c-bd').textContent        = fmt(rt.bd);
  document.getElementById('c-bd-tight').textContent  = `+$${Math.round(rt.bdTight)} í”„ë¦¬ë¯¸ì—„`;
  document.getElementById('c-an').textContent        = fmt(rt.an);
  document.getElementById('c-an-act').textContent    = `ì‹¤ì¸¡ $${Math.round(G.an)}`;
  document.getElementById('c-pr').textContent        = fmt(rt.pr);
  document.getElementById('c-pr-act').textContent    = `ì‹¤ì¸¡ $${Math.round(G.pr_act)}`;
  document.getElementById('c-sm-mkt').textContent    = fmt(rt.sm);
  document.getElementById('c-sm-act').textContent    = `ì‹¤ì¸¡ $${Math.round(G.sm_act)}`;
  document.getElementById('c-abs-mkt').textContent   = fmt(rt.absMkt);
  document.getElementById('c-abs-mkt-act').textContent = `ì‹¤ì¸¡ $${Math.round(G.abs_mkt_act)}`;
  document.getElementById('c-bz-spread').textContent = fmt(rt.bzSpreadAra, true);

  // í¬ë˜ì»¤ ë§ˆì§„ íŒ¨ë„
  const panel = document.getElementById('cracker-panel');
  panel.className = 'rounded-xl p-4 mb-3 ' + crackerColor(rt.crackerSim);
  document.getElementById('cracker-margin-val').textContent = fmt(rt.crackerSim, true);
  document.getElementById('cr-et-contrib').textContent  = `$${Math.round(rt.et*CR_Y.et)}`;
  document.getElementById('cr-pr-contrib').textContent  = `$${Math.round(rt.pr*CR_Y.pr)}`;
  document.getElementById('cr-bd-contrib').textContent  = `$${Math.round(rt.bd*CR_Y.bd + rt.bz*CR_Y.bz)}`;
  document.getElementById('cr-nap-cost').textContent    = `-$${Math.round(rt.nap)}`;
  document.getElementById('cr-bd-tight-big').textContent = `+$${Math.round(rt.bdTight)}`;
  // 4ì£¼ í‰ê·  ê¸°ì¤€ë§ˆì§„ í‘œì‹œ
  const recent4   = CRACKER_HISTORY.slice(-4).map(d => d.margin);
  const baseMgn4w = Math.round(recent4.reduce((a, b) => a + b, 0) / recent4.length);
  const crBaseEl  = document.getElementById('cr-base-margin');
  if (crBaseEl) crBaseEl.textContent = `$${baseMgn4w}`;
  const ci = document.getElementById('cracker-insight');
  if (rt.crackerSim < 0)
    ci.innerHTML = `ğŸ”´ í¬ë˜ì»¤ ì ì ${fmt(rt.crackerSim,true)}/t â€” ET ì•½ì„¸ë¡œ í¬ë˜ì»¤ ê°€ë™ ìˆ˜ìµì„± ì•…í™”. BD ê³µê¸‰ ì¶•ì†Œ ì••ë ¥ ë°œìƒ. ABS Costì— +$${Math.round(rt.bdTight)}/t íƒ€ì´íŠ¸ í”„ë¦¬ë¯¸ì—„ ìë™ ë°˜ì˜ë¨.`;
  else if (rt.crackerSim < 50)
    ci.innerHTML = `âš  í¬ë˜ì»¤ ì†ìµë¶„ê¸° ê·¼ì ‘ ${fmt(rt.crackerSim,true)}/t â€” ET ì¶”ê°€ í•˜ë½ ì‹œ ì ì ì „í™˜. BD ìˆ˜ê¸‰ ëª¨ë‹ˆí„°ë§ ê°•í™” í•„ìš”.`;
  else
    ci.innerHTML = `âœ… í¬ë˜ì»¤ ì •ìƒ ìˆ˜ìµ ${fmt(rt.crackerSim,true)}/t â€” BD ê³µê¸‰ ì•ˆì •. íƒ€ì´íŠ¸ í”„ë¦¬ë¯¸ì—„ ì—†ìŒ.`;

  // ìˆ˜ê¸‰ì‹ í˜¸ 4ì¢…
  function setSig(id, v, sub) {
    const el = document.getElementById(id);
    el.textContent = fmt(v, true);
    el.className   = 'text-2xl font-black ' + (v >= 0 ? 'text-emerald-700' : 'text-red-700');
    if (sub) document.getElementById(id+'-sub').textContent = sub;
  }
  setSig('sig-sm-act',  rt.smMargin,   rt.smMargin>=0  ? 'â–² SM í‘ì' : 'â–¼ SM ì ì');
  setSig('sig-sm-th',   rt.smMarginTh, rt.smMarginTh>=0? 'â–² ì´ë¡  í‘ì':'â–¼ ê°ì‚° íŠ¸ë¦¬ê±° ê°€ëŠ¥');
  setSig('sig-abs-act', rt.absGap,     rt.absGap>=150  ? 'âœ… ëª©í‘œ ë‹¬ì„±':rt.absGap>=0?'âš  Gap ë¶€ì¡±':'ğŸ”´ ì—­ë§ˆì§„');
  setSig('sig-abs-th',  rt.absGapTh,   rt.absGapTh>=0  ? 'â–² ì´ë¡  í‘ì':'â–¼ ì´ë¡ ë„ ì—­ë§ˆì§„');

  // BZ ìŠ¤í”„ë ˆë“œ
  document.getElementById('sp-bz-k').textContent  = fmt(rt.bz);
  document.getElementById('sp-bz-ara').textContent = fmt(rt.bzAra);
  document.getElementById('sp-bz-spread-ara').textContent = fmt(rt.bzSpreadAra, true);
  document.getElementById('sp-bz-k2').textContent  = fmt(rt.bz);
  document.getElementById('sp-bz-usg').textContent  = fmt(rt.bzUsgMt);
  document.getElementById('sp-bz-spread-usg').textContent = fmt(rt.bzSpreadUsg, true);
  const ins = rt.bzSpreadAra > 50 ? `âœ… Korea-ARA ${fmt(rt.bzSpreadAra,true)} â€” ì•„ì‹œì•„ ê°•ì„¸.` :
              rt.bzSpreadAra > 0  ? `âš  Korea-ARA ${fmt(rt.bzSpreadAra,true)} â€” ì†Œí­ í”„ë¦¬ë¯¸ì—„.` :
              `ğŸ”´ Korea-ARA ${fmt(rt.bzSpreadAra,true)} â€” ARA ì—­ì „.`;
  document.getElementById('bz-insight').textContent = ins;



  // ìŠ¬ë¼ì´ë” ë™ê¸°í™”
  document.getElementById('slider-wti').value = G.wti_rt.toFixed(2);
  onWtiSlider();
  resetCrackerSliders();
}

function alertBadge(absGap, bdTight) {
  if (absGap < 0)      return `<span class="badge-danger alert-blink">ğŸ”´ CRITICAL ì—­ë§ˆì§„</span>`;
  if (bdTight > 80)    return `<span class="badge-danger">ğŸ”´ BD ì‹¬ê° íƒ€ì´íŠ¸</span>`;
  if (absGap < 150)    return `<span class="badge-warn">ğŸŸ¡ Gap ê²½ë³´</span>`;
  if (bdTight > 30)    return `<span class="badge-warn">ğŸŸ¡ BD íƒ€ì´íŠ¸ ì£¼ì˜</span>`;
  return `<span class="badge-ok">ğŸŸ¢ NORMAL</span>`;
}

function loadCSV() {
  Papa.parse('simulation_result.csv?t='+Date.now(), {
    download:true, header:true, skipEmptyLines:true,
    complete(res) {
      if (!res.data?.length) return;
      const d = res.data[0];

      G.wti_rt        = parseFloat(d.WTI)              || G.wti_rt;
      G.wti_gs        = parseFloat(d.WTI_GSheet)       || G.wti_gs;
      G.bz            = parseFloat(d.BZ_Actual)        || G.bz;
      G.et            = parseFloat(d.ET_Actual)        || G.et;
      G.bd            = parseFloat(d.BD_Actual)        || G.bd;
      G.an            = parseFloat(d.AN_Actual)        || G.an;
      G.nap           = parseFloat(d.NAP)              || G.nap;
      G.sm_act        = parseFloat(d.SM_Actual)        || G.sm_act;
      G.abs_mkt_act   = parseFloat(d.ABS_Mkt_Actual)   || G.abs_mkt_act;
      G.pr_act        = parseFloat(d.PR_Actual)        || G.pr_act;
      G.bz_ara_act    = parseFloat(d.BZ_ARA_Actual)    || G.bz_ara_act;
      G.bz_usg_mt_act = parseFloat(d.BZ_USG_Actual)   || G.bz_usg_mt_act;
      G.sm_margin_act = parseFloat(d.SM_Margin_Actual) || G.sm_margin_act;
      G.cracker_act   = parseFloat(d.Cracker_Margin_Act)|| G.cracker_act;

      if (d.NAP_Sens_Equiv_Basis) NAP_EQUIV = parseFloat(d.NAP_Sens_Equiv_Basis) || NAP_EQUIV;

      if (d.Sens_BZ)       { SENS.bz       = parseFloat(d.Sens_BZ);       setSensCard('bz',       d.Sens_BZ,       d.R2_BZ);       }
      if (d.Sens_ET)       { SENS.et       = parseFloat(d.Sens_ET);       setSensCard('et',       d.Sens_ET,       d.R2_ET);       }
      if (d.Sens_SM)       { SENS.sm       = parseFloat(d.Sens_SM);       setSensCard('sm',       d.Sens_SM,       d.R2_SM);       }
      if (d.Sens_BD)       { SENS.bd       = parseFloat(d.Sens_BD);       setSensCard('bd',       d.Sens_BD,       d.R2_BD);       }
      if (d.Sens_AN)       { SENS.an       = parseFloat(d.Sens_AN);       setSensCard('an',       d.Sens_AN,       d.R2_AN);       }
      if (d.Sens_NAP)      { SENS.nap      = parseFloat(d.Sens_NAP);      setSensCard('nap',      d.Sens_NAP,      d.R2_NAP);      }
      if (d.Sens_PR)       { SENS.pr       = parseFloat(d.Sens_PR);       setSensCard('pr',       d.Sens_PR,       d.R2_PR);       }
      if (d.Sens_ABS_MKT)  { SENS.abs_mkt  = parseFloat(d.Sens_ABS_MKT);  setSensCard('abs_mkt',  d.Sens_ABS_MKT,  d.R2_ABS_MKT);  }
      if (d.Sens_ABS_GAP)  { SENS.abs_gap  = parseFloat(d.Sens_ABS_GAP);  setSensCard('abs_gap',  d.Sens_ABS_GAP,  d.R2_ABS_GAP);  }
      if (d.Sens_SM_COST)  { SENS.sm_cost  = parseFloat(d.Sens_SM_COST);  setSensCard('sm_cost',  d.Sens_SM_COST);                 }
      // ë¯¼ê°ë„ íƒ­ì´ í™œì„±í™” ìƒíƒœë©´ ì°¨íŠ¸ ê°±ì‹ 
      if (!document.getElementById('tab-sens').classList.contains('hidden')) renderSensCharts();
      if (d.Sens_SM_MARGIN){ SENS.sm_margin= parseFloat(d.Sens_SM_MARGIN);}

      document.getElementById('update-time').textContent = 'ê°±ì‹ : '+(d.UpdateTime||'');
      document.getElementById('gs-date').textContent     = 'êµ¬ê¸€ì‹œíŠ¸: '+(d.GSheet_Date||'');
      document.getElementById('wti-source').textContent  = d.WTI_Source||'';
      if (d.Reg_N) document.getElementById('reg-meta').textContent = d.Reg_N+'ì£¼ ë°ì´í„°';

      // í¬ë˜ì»¤ ìŠ¬ë¼ì´ë” ì‹¤ì¸¡ê°’ ë¼ë²¨ ê°±ì‹ 
      document.getElementById('cr-et-actual').textContent  = `$${Math.round(G.et)}`;
      document.getElementById('cr-nap-actual').textContent = `$${Math.round(G.nap)}`;

      updateDashboard();
    },
    error() { document.getElementById('update-time').textContent = 'CSV ë¡œë“œ ì‹¤íŒ¨'; }
  });
}

function refreshImg() {
  document.getElementById('report-img').src = 'risk_simulation_report.png?t='+Date.now();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 13ì£¼ ê°€ê²© ì˜ˆì¸¡ ëª¨ë“ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ ê³„ì ˆì„± ë°ì´í„° (2024~2026 ì‹¤ê°€ê²© WTIì”ì°¨ ì£¼ì°¨ë³„ í‰ê· ) â”€â”€â”€
const SEASONAL = {
  SM: {1:-15.22,2:-13.12,3:-12.89,4:12.45,5:28.09,6:41.22,7:18.56,8:15.82,9:10.77,10:19.94,11:18.69,12:-15.37,13:-33.99,14:-46.03,15:-22.05,16:-4.39,17:-18.21,18:4.38,19:13.63,20:12.29,21:40.92,22:41.89,23:32.71,24:-8.0,25:-77.01,26:-23.06,27:-41.27,28:-41.97,29:-47.3,30:-15.68,31:-12.26,32:12.21,33:1.96,34:25.24,35:8.88,36:36.31,37:39.1,38:13.53,39:-4.84,40:19.59,41:-12.82,42:-4.34,43:-9.33,44:-0.09,45:-29.92,46:-10.32,47:-13.59,48:-6.7,49:9.19,50:8.98,51:9.15,52:-6.4},
  AN: {1:14.62,2:19.19,3:-8.56,4:-11.02,5:-4.73,6:5.87,7:-3.67,8:-8.39,9:2.48,10:65.69,11:52.19,12:32.16,13:27.89,14:16.76,15:49.97,16:40.73,17:48.13,18:40.68,19:52.24,20:40.01,21:45.65,22:42.81,23:43.64,24:5.63,25:-53.76,26:-18.46,27:-23.88,28:-37.87,29:-45.28,30:-33.19,31:-39.11,32:-24.14,33:-31.55,34:-17.91,35:-37.46,36:-37.97,37:-17.24,38:-34.91,39:-34.0,40:-43.3,41:-55.37,42:-16.34,43:-16.86,44:-12.78,45:-21.39,46:-13.52,47:-17.27,48:-4.25,49:9.49,50:15.64,51:28.63,52:24.44},
  BD: {1:-105.91,2:-78.98,3:-46.48,4:-29.25,5:27.16,6:59.98,7:42.72,8:39.28,9:25.17,10:26.07,11:39.18,12:24.29,13:27.95,14:-5.56,15:44.01,16:-57.77,17:-96.27,18:-42.54,19:-26.07,20:-17.19,21:31.49,22:11.61,23:27.37,24:-53.69,25:-102.24,26:10.99,27:-22.81,28:-44.99,29:-33.45,30:28.89,31:20.5,32:49.24,33:16.26,34:52.63,35:34.69,36:112.97,37:158.28,38:123.93,39:129.11,40:135.88,41:94.48,42:141.34,43:83.31,44:35.83,45:-74.52,46:-116.47,47:-195.46,48:-166.23,49:-153.53,50:-124.38,51:-60.27,52:-27.12}
};

// WTI ë¯¼ê°ë„ (íšŒê·€ ë¶„ì„ê°’)
const FC_SENS = {SM: 14.747, AN: 7.873, BD: 20.476};
// ì”ì°¨ í‘œì¤€í¸ì°¨
const FC_STD  = {SM: 52.62,  AN: 52.58,  BD: 149.25};

// ì˜ˆì¸¡ ê¸°ì¤€ ì£¼ì°¨ (W09 = 2/27 ê¸°ì¤€)
const FC_BASE_WEEK = 9;
// ì˜ˆì¸¡ 13ì£¼ ì •ë³´
const FC_WEEKS = [
  {n:1,  date:'2026-03-06', wn:10},
  {n:2,  date:'2026-03-13', wn:11},
  {n:3,  date:'2026-03-20', wn:12},
  {n:4,  date:'2026-03-27', wn:13},
  {n:5,  date:'2026-04-03', wn:14},
  {n:6,  date:'2026-04-10', wn:15},
  {n:7,  date:'2026-04-17', wn:16},
  {n:8,  date:'2026-04-24', wn:17},
  {n:9,  date:'2026-05-01', wn:18},
  {n:10, date:'2026-05-08', wn:19},
  {n:11, date:'2026-05-15', wn:20},
  {n:12, date:'2026-05-22', wn:21},
  {n:13, date:'2026-05-29', wn:22},
];

// í˜„ì¬ WTI ì‹œë‚˜ë¦¬ì˜¤ ëª¨ë“œ
let fcMode = 'flat';
let fcCustomWti = {mar:67, apr:67, may:67};

// WTI ê²½ë¡œ ë°˜í™˜ (n=1~13)
function getFcWti(n) {
  const base = G.wti_rt;
  if (fcMode === 'flat')   return base;
  if (fcMode === 'up')     return base + n * 1.0;
  if (fcMode === 'down')   return base - n * 1.0;
  // custom: ì›”ë³„ êµ¬ê°„
  if (n <= 4)  return fcCustomWti.mar;
  if (n <= 8)  return fcCustomWti.apr;
  return fcCustomWti.may;
}

function setFcScenario(mode) {
  fcMode = mode;
  document.querySelectorAll('.fc-btn').forEach(b => {
    b.className = 'fc-btn text-xs border rounded-lg px-3 py-1.5 transition bg-sky-50 text-slate-700 border-slate-300';
  });
  const activeMap = {flat:'bg-emerald-900/60 text-emerald-700 border-emerald-700', up:'bg-red-900/60 text-red-700 border-red-700', down:'bg-blue-900/60 text-blue-700 border-blue-700', custom:'bg-yellow-900/60 text-amber-700 border-yellow-700'};
  const btn = document.getElementById(`fc-btn-${mode}`);
  if (btn) btn.className = `fc-btn text-xs border rounded-lg px-3 py-1.5 transition ${activeMap[mode]}`;
  const cp = document.getElementById('fc-custom-panel');
  if (cp) cp.classList.toggle('hidden', mode !== 'custom');
  renderForecast();
}

function onFcCustom() {
  fcCustomWti.mar = parseFloat(document.getElementById('fc-slider-mar').value);
  fcCustomWti.apr = parseFloat(document.getElementById('fc-slider-apr').value);
  fcCustomWti.may = parseFloat(document.getElementById('fc-slider-may').value);
  document.getElementById('fc-wti-mar').textContent = `$${fcCustomWti.mar.toFixed(1)}`;
  document.getElementById('fc-wti-apr').textContent = `$${fcCustomWti.apr.toFixed(1)}`;
  document.getElementById('fc-wti-may').textContent = `$${fcCustomWti.may.toFixed(1)}`;
  renderForecast();
}

function renderForecast() {
  const curSM = G.sm_act;
  const curAN = G.abs_mkt_act;  // AN ì‹¤ì¸¡ (CSV ë¡œë“œ í›„ ê°±ì‹ )
  const curBD = G.bd;
  const curWTI= G.wti_rt;

  // í˜„ì¬ ì£¼ì°¨ ê³„ì ˆì„±
  const s0_SM = SEASONAL.SM[FC_BASE_WEEK] || 0;
  const s0_AN = SEASONAL.AN[FC_BASE_WEEK] || 0;
  const s0_BD = SEASONAL.BD[FC_BASE_WEEK] || 0;

  // í˜„ì¬ê°€ í‘œì‹œ ê°±ì‹ 
  document.getElementById('fc-cur-sm').textContent = `$${Math.round(curSM)}`;
  document.getElementById('fc-cur-an').textContent = `$${Math.round(G.an)}`;
  document.getElementById('fc-cur-bd').textContent = `$${Math.round(curBD)}`;

  // â”€â”€â”€ SM í…Œì´ë¸” â”€â”€â”€
  let smRows = ''; let prevSM = curSM;
  FC_WEEKS.forEach(w => {
    const wti    = getFcWti(w.n);
    const dWti   = wti - curWTI;
    const seas   = (SEASONAL.SM[w.wn] || 0) - s0_SM;
    const pred   = Math.round(curSM + dWti * FC_SENS.SM + seas);
    const ci     = Math.round(FC_STD.SM * Math.sqrt(w.n) * 1.96);
    const lo     = pred - ci;
    const hi     = pred + ci;
    const delta  = pred - prevSM;
    const dStr   = `<span class="${delta>=0?'text-red-700':'text-blue-700'}">${delta>=0?'+':''}${Math.round(delta)}</span>`;
    const sig    = pred > curSM + 30 ? '<span class="text-red-700 font-bold">â†‘ê°•ì„¸</span>' :
                   pred < curSM - 30 ? '<span class="text-blue-700 font-bold">â†“ì•½ì„¸</span>' :
                   '<span class="text-slate-700">â†’ë³´í•©</span>';
    const rowBg  = w.n % 4 === 0 ? 'bg-sky-50/90' : '';
    const mnLabel = w.n<=4?'<span class="text-indigo-600 text-xs">3ì›”</span>':w.n<=8?'<span class="text-violet-600 text-xs">4ì›”</span>':'<span class="text-pink-700 text-xs">5ì›”</span>';
    smRows += `<tr class="border-b border-slate-200 hover:bg-sky-50/60 ${rowBg}">
      <td class="px-3 py-1.5 font-black text-blue-700">W+${w.n} ${mnLabel}</td>
      <td class="px-3 py-1.5 text-slate-700">${w.date}</td>
      <td class="px-3 py-1.5 text-right text-amber-700">$${wti.toFixed(1)}</td>
      <td class="px-3 py-1.5 text-right ${seas>=0?'text-orange-700':'text-cyan-700'}">${seas>=0?'+':''}${Math.round(seas)}</td>
      <td class="px-3 py-1.5 text-right font-black text-blue-700">$${pred}</td>
      <td class="px-3 py-1.5 text-right text-slate-700">$${lo}</td>
      <td class="px-3 py-1.5 text-right text-slate-700">$${hi}</td>
      <td class="px-3 py-1.5 text-right">${dStr}</td>
      <td class="px-3 py-1.5">${sig}</td>
    </tr>`;
    prevSM = pred;
  });
  document.getElementById('fc-table-sm').innerHTML = smRows;

  // â”€â”€â”€ AN í…Œì´ë¸” â”€â”€â”€
  let anRows = ''; let prevAN = G.an;
  FC_WEEKS.forEach(w => {
    const wti    = getFcWti(w.n);
    const dWti   = wti - curWTI;
    const seas   = (SEASONAL.AN[w.wn] || 0) - s0_AN;
    const pred   = Math.round(G.an + dWti * FC_SENS.AN + seas);
    const ci     = Math.round(FC_STD.AN * Math.sqrt(w.n) * 1.96);
    const lo     = pred - ci;
    const hi     = pred + ci;
    const delta  = pred - prevAN;
    const dStr   = `<span class="${delta>=0?'text-red-700':'text-blue-700'}">${delta>=0?'+':''}${Math.round(delta)}</span>`;
    const sig    = pred > G.an + 30 ? '<span class="text-red-700 font-bold">â†‘ê°•ì„¸</span>' :
                   pred < G.an - 30 ? '<span class="text-blue-700 font-bold">â†“ì•½ì„¸</span>' :
                   '<span class="text-slate-700">â†’ë³´í•©</span>';
    const rowBg  = w.n % 4 === 0 ? 'bg-sky-50/90' : '';
    anRows += `<tr class="border-b border-slate-200 hover:bg-sky-50/60 ${rowBg}">
      <td class="px-3 py-1.5 font-black text-amber-700">W+${w.n}</td>
      <td class="px-3 py-1.5 text-slate-700">${w.date}</td>
      <td class="px-3 py-1.5 text-right text-amber-700">$${wti.toFixed(1)}</td>
      <td class="px-3 py-1.5 text-right ${seas>=0?'text-orange-700':'text-cyan-700'}">${seas>=0?'+':''}${Math.round(seas)}</td>
      <td class="px-3 py-1.5 text-right font-black text-amber-700">$${pred}</td>
      <td class="px-3 py-1.5 text-right text-slate-700">$${lo}</td>
      <td class="px-3 py-1.5 text-right text-slate-700">$${hi}</td>
      <td class="px-3 py-1.5 text-right">${dStr}</td>
      <td class="px-3 py-1.5">${sig}</td>
    </tr>`;
    prevAN = pred;
  });
  document.getElementById('fc-table-an').innerHTML = anRows;

  // â”€â”€â”€ BD í…Œì´ë¸” (í¬ë˜ì»¤ íƒ€ì´íŠ¸ ë³‘ê¸°) â”€â”€â”€
  let bdRows = ''; let prevBD = curBD;
  FC_WEEKS.forEach(w => {
    const wti      = getFcWti(w.n);
    const dWti     = wti - curWTI;
    const seas     = (SEASONAL.BD[w.wn] || 0) - s0_BD;
    const predBase = Math.round(curBD + dWti * FC_SENS.BD + seas);
    // í¬ë˜ì»¤ íƒ€ì´íŠ¸: ETëŠ” WTIì™€ í•¨ê»˜ ì´ë™ (sens 6.13)
    const etSim    = G.et + dWti * SENS.et;
    const prSim    = G.pr_act + dWti * SENS.pr;
    const bzSim    = G.bz + dWti * SENS.bz;
    const napSim   = G.nap + dWti * SENS.nap;
    const crackerSim  = calcCrackerMargin(etSim, prSim, predBase, bzSim, napSim);
    const bdTight     = calcBdTight(crackerSim);
    const predFinal   = Math.round(predBase + bdTight);
    const ci          = Math.round(FC_STD.BD * Math.sqrt(w.n) * 1.96);
    const lo          = predFinal - ci;
    const hi          = predFinal + ci;
    const rowBg  = w.n % 4 === 0 ? 'bg-sky-50/90' : '';
    const tightStr = bdTight > 0 ? `<span class="text-orange-700 font-bold">+$${Math.round(bdTight)}</span>` : '<span class="text-slate-700">â€”</span>';
    bdRows += `<tr class="border-b border-slate-200 hover:bg-sky-50/60 ${rowBg}">
      <td class="px-3 py-1.5 font-black text-orange-700">W+${w.n}</td>
      <td class="px-3 py-1.5 text-slate-700">${w.date}</td>
      <td class="px-3 py-1.5 text-right text-amber-700">$${wti.toFixed(1)}</td>
      <td class="px-3 py-1.5 text-right ${seas>=0?'text-orange-700':'text-cyan-700'}">${seas>=0?'+':''}${Math.round(seas)}</td>
      <td class="px-3 py-1.5 text-right text-orange-700">$${predBase}</td>
      <td class="px-3 py-1.5 text-right">${tightStr}</td>
      <td class="px-3 py-1.5 text-right font-black text-orange-700">$${predFinal}</td>
      <td class="px-3 py-1.5 text-right text-slate-700">$${lo}</td>
      <td class="px-3 py-1.5 text-right text-slate-700">$${hi}</td>
    </tr>`;
    prevBD = predFinal;
  });
  document.getElementById('fc-table-bd').innerHTML = bdRows;

  // â”€â”€â”€ ì¸ì‚¬ì´íŠ¸ ìš”ì•½ â”€â”€â”€
  renderFcInsight(curSM, curWTI);
}

function renderFcInsight(curSM, curWTI) {
  // W+1, W+4(3ì›”ë§), W+8(4ì›”ë§), W+13(5ì›”ë§) ì˜ˆì¸¡ê°’ ìš”ì•½
  const s0_SM = SEASONAL.SM[FC_BASE_WEEK]||0;
  const s0_AN = SEASONAL.AN[FC_BASE_WEEK]||0;
  const s0_BD = SEASONAL.BD[FC_BASE_WEEK]||0;

  const summary = [1,4,8,13].map(n => {
    const w    = FC_WEEKS[n-1];
    const wti  = getFcWti(n);
    const dWti = wti - curWTI;
    return {
      n, date: w.date,
      sm: Math.round(curSM  + dWti*FC_SENS.SM + (SEASONAL.SM[w.wn]||0) - s0_SM),
      an: Math.round(G.an   + dWti*FC_SENS.AN + (SEASONAL.AN[w.wn]||0) - s0_AN),
      bd: Math.round(G.bd   + dWti*FC_SENS.BD + (SEASONAL.BD[w.wn]||0) - s0_BD),
    };
  });

  const modeLabel = {flat:'ìœ ê°€ Flat', up:'ìœ ê°€ ìƒìŠ¹(+$1/w)', down:'ìœ ê°€ í•˜ë½(-$1/w)', custom:'Custom WTI'}[fcMode];
  let html = `<div class="text-indigo-700 font-black mb-2">ğŸ“Œ ì˜ˆì¸¡ ìš”ì•½ (${modeLabel})</div>`;
  html += `<div class="grid grid-cols-2 md:grid-cols-4 gap-3">`;
  const labels = ['W+1 (3ì›”1ì£¼)','W+4 (3ì›”ë§)','W+8 (4ì›”ë§)','W+13 (5ì›”ë§)'];
  summary.forEach((s,i) => {
    const smC = s.sm > curSM+30?'text-red-700':s.sm<curSM-30?'text-blue-700':'text-slate-700';
    html += `<div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
      <div class="text-slate-700 font-bold mb-1">${labels[i]}</div>
      <div class="text-xs">SM <span class="${smC} font-black">$${s.sm}</span></div>
      <div class="text-xs">AN <span class="text-violet-700 font-black">$${s.an}</span></div>
      <div class="text-xs">BD <span class="text-orange-700 font-black">$${s.bd}</span></div>
    </div>`;
  });
  html += `</div>`;

  // ê³„ì ˆì„± ì½”ë©˜íŠ¸
  const an3 = Math.round((SEASONAL.AN[10]||0)+(SEASONAL.AN[11]||0)+(SEASONAL.AN[12]||0)+(SEASONAL.AN[13]||0))/4;
  const bd4 = Math.round((SEASONAL.BD[16]||0)+(SEASONAL.BD[17]||0))/2;
  html += `<div class="mt-3 text-slate-700 space-y-1">`;
  html += `<div>ğŸ”µ <b class="text-blue-700">SM</b>: 3ì›”ì´ˆ ê³„ì ˆì  ì•½ë³´í•© í›„ 5ì›”ë§ ë°˜ë“±. ê³„ì ˆì„± ë²”ìœ„ ì•½ <b>-$46~+$42</b>.</div>`;
  html += `<div>ğŸŸ£ <b class="text-violet-700">AN</b>: 3~5ì›” ì „ë°˜ì  ê°•ì„¸(ë´„ ì•„í¬ë¦´ ì‹œì¦Œ +${Math.round(an3)}í‰ê· ). 7~10ì›” ì•½ì„¸ ì „í™˜ ì£¼ì˜.</div>`;
  html += `<div>ğŸŸ  <b class="text-orange-700">BD</b>: 4ì›” ê³„ì ˆ ì•½ì„¸ í›„ 5ì›” íšŒë³µ. ë‹¨ í¬ë˜ì»¤ ê°€ë™ë¥  ì´ìŠˆê°€ ê³„ì ˆì„±ë³´ë‹¤ ì§€ë°°ì  â€” ë°©í–¥ì„±ë§Œ ì°¸ê³ .</div>`;
  html += `</div>`;

  document.getElementById('fc-insight-box').innerHTML = html;
  setTimeout(renderFcChart, 150);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì˜ˆì¸¡ ì°¨íŠ¸ (Chart.js)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fcChart = null;
let fcChartType = 'line';
let fcLineVis = {SM: true, AN: true, BD: true};

function toggleFcLine(label) {
  fcLineVis[label] = !fcLineVis[label];
  const btn = document.getElementById(`fc-toggle-${label.toLowerCase()}`);
  const colorMap = {
    SM: {on:'bg-blue-100 text-blue-700 border-blue-300',   off:'bg-sky-50 text-slate-600 border-slate-200'},
    AN: {on:'bg-violet-100 text-violet-700 border-violet-300', off:'bg-sky-50 text-slate-600 border-slate-200'},
    BD: {on:'bg-orange-100 text-orange-700 border-orange-300', off:'bg-sky-50 text-slate-600 border-slate-200'},
  };
  btn.className = `fc-toggle text-xs px-2 py-1 rounded border font-bold transition ${colorMap[label][fcLineVis[label]?'on':'off']}`;
  renderFcChart();
}

function setChartType(type) {
  fcChartType = type;
  document.querySelectorAll('.ct-btn').forEach(b => {
    b.className = 'ct-btn text-xs px-2 py-1 rounded border font-bold transition bg-sky-50 text-slate-600 border-slate-300';
  });
  const active = document.getElementById(`ct-${type}`);
  if (active) active.className = 'ct-btn text-xs px-2 py-1 rounded border font-bold transition bg-slate-700 text-white border-slate-600';
  renderFcChart();
}

function renderFcChart() {
  const canvas = document.getElementById('fc-chart');
  if (!canvas) return;
  const showCI      = document.getElementById('fc-show-ci')?.checked ?? true;
  const showSeasonal= document.getElementById('fc-show-seasonal')?.checked ?? true;
  const showPrice   = document.getElementById('fc-show-price')?.checked ?? true;
  const showFlat    = document.getElementById('fc-show-flat')?.checked ?? true;

  const curWTI = G.wti_rt;
  const s0 = {
    SM: SEASONAL.SM[FC_BASE_WEEK]||0,
    AN: SEASONAL.AN[FC_BASE_WEEK]||0,
    BD: SEASONAL.BD[FC_BASE_WEEK]||0,
  };
  const curPrices = {SM: G.sm_act, AN: G.an, BD: G.bd};
  const colors = {
    SM: {line:'#2563eb', ci:'rgba(37,99,235,0.12)', seas:'rgba(37,99,235,0.5)', flat:'rgba(37,99,235,0.35)'},
    AN: {line:'#7c3aed', ci:'rgba(124,58,237,0.12)',  seas:'rgba(124,58,237,0.5)',  flat:'rgba(124,58,237,0.35)'},
    BD: {line:'#ea580c', ci:'rgba(234,88,12,0.12)',  seas:'rgba(234,88,12,0.5)',  flat:'rgba(234,88,12,0.35)'},
  };

  // ë¼ë²¨: W(í˜„ì¬) + W+1~W+13
  const labels = ['W(í˜„ì¬)', ...FC_WEEKS.map(w => `W+${w.n}\n${w.date.slice(5)}`)];

  const datasets = [];

  ['SM','AN','BD'].forEach(label => {
    if (!fcLineVis[label]) return;
    const c = colors[label];
    const sens = FC_SENS[label];
    const std  = FC_STD[label];

    // ì˜ˆì¸¡ê°’ (í˜„ì¬ í¬í•¨)
    const preds = [curPrices[label]];
    const lo    = [null];
    const hi    = [null];
    const seas  = [curPrices[label]];
    const flat  = [curPrices[label]];  // Flat ê¸°ì¤€ì„  (WTI ê³ ì •)

    FC_WEEKS.forEach(w => {
      const wti   = getFcWti(w.n);
      const dWti  = wti - curWTI;
      let seasDelta = (SEASONAL[label][w.wn]||0) - s0[label];
      let pred    = curPrices[label] + dWti * sens + seasDelta;

      // Flat ê¸°ì¤€ì„ : WTI ë³€ë™ ì—†ì´ ê³„ì ˆì„±ë§Œ ë°˜ì˜
      const flatDWti = 0;  // WTI ê³ ì •
      let flatPred = curPrices[label] + flatDWti * sens + seasDelta;

      // BD: í¬ë˜ì»¤ íƒ€ì´íŠ¸ ì¶”ê°€
      if (label === 'BD') {
        const etSim  = G.et    + dWti * SENS.et;
        const prSim  = G.pr_act + dWti * SENS.pr;
        const bzSim  = G.bz    + dWti * SENS.bz;
        const napSim = G.nap   + dWti * SENS.nap;
        const crSim  = calcCrackerMargin(etSim, prSim, pred, bzSim, napSim);
        pred += calcBdTight(crSim);

        // Flat BD: í¬ë˜ì»¤ë„ flat ê¸°ì¤€
        const crFlat = calcCrackerMargin(G.et, G.pr_act, flatPred, G.bz, G.nap);
        flatPred += calcBdTight(crFlat);
      }

      const ci = std * Math.sqrt(w.n) * 1.96;
      preds.push(Math.round(pred));
      lo.push(Math.round(pred - ci));
      hi.push(Math.round(pred + ci));
      seas.push(Math.round(curPrices[label] + (SEASONAL[label][w.wn]||0) - s0[label]));
      flat.push(Math.round(flatPred));
    });

    const chartT = fcChartType === 'bar' ? 'bar' : 'line';
    const tension = fcChartType === 'smooth' ? 0.4 : 0;

    // ì‹ ë¢°êµ¬ê°„ ìƒí•œ
    if (showCI && chartT !== 'bar') {
      datasets.push({
        label: `${label} ìƒí•œ(95%)`,
        data: hi, borderColor: 'transparent',
        backgroundColor: c.ci, fill: '+1',
        pointRadius: 0, tension, order: 3,
        type: 'line',
        datalabels: { display: false },
      });
    }

    // ì˜ˆì¸¡ ì¤‘ì‹¬ê°’
    datasets.push({
      label: `${label} ì˜ˆì¸¡`,
      data: preds,
      borderColor: c.line,
      backgroundColor: chartT === 'bar' ? c.line + 'cc' : c.ci,
      fill: false,
      pointRadius: 4,
      pointHoverRadius: 7,
      borderWidth: 2.5,
      tension,
      order: 1,
      type: chartT,
      datalabels: {
        display: showPrice,
        anchor: 'end',
        align: 'top',
        offset: 2,
        color: c.line,
        font: { size: 9, weight: 'bold' },
        formatter: v => v != null ? '$' + v.toLocaleString() : '',
      },
    });

    // ì‹ ë¢°êµ¬ê°„ í•˜í•œ
    if (showCI && chartT !== 'bar') {
      datasets.push({
        label: `${label} í•˜í•œ(95%)`,
        data: lo, borderColor: 'transparent',
        backgroundColor: c.ci, fill: false,
        pointRadius: 0, tension, order: 3,
        type: 'line',
        datalabels: { display: false },
      });
    }

    // ê³„ì ˆì„± ë¼ì¸
    if (showSeasonal && chartT !== 'bar') {
      datasets.push({
        label: `${label} ê³„ì ˆì„±`,
        data: seas,
        borderColor: c.seas,
        backgroundColor: 'transparent',
        borderDash: [5, 4],
        borderWidth: 1.5,
        pointRadius: 2,
        tension, order: 2,
        type: 'line',
        fill: false,
        datalabels: { display: false },
      });
    }

    // Flat ê¸°ì¤€ì„  (í˜„ì¬ WTI ê³ ì • + ê³„ì ˆì„±ë§Œ ë°˜ì˜) â€” í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤ì™€ ë¹„êµìš©
    if (showFlat && fcMode !== 'flat' && chartT !== 'bar') {
      datasets.push({
        label: `${label} Flatê¸°ì¤€`,
        data: flat,
        borderColor: c.flat,
        backgroundColor: 'transparent',
        borderDash: [3, 5],
        borderWidth: 1.8,
        pointRadius: 2,
        pointStyle: 'rect',
        tension, order: 2,
        type: 'line',
        fill: false,
        datalabels: { display: false },
      });
    }
  });

  if (fcChart) {
    fcChart.destroy();
    fcChart = null;
  }
  // canvas ì™„ì „ ì´ˆê¸°í™” (Chart.js ë‚´ë¶€ ìºì‹œ ì œê±°)
  const newCanvas = canvas.cloneNode(true);
  canvas.parentNode.replaceChild(newCanvas, canvas);
  const ctx = newCanvas.getContext('2d');

  fcChart = new Chart(newCanvas, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode:'index', intersect:false },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: { font:{size:11}, color:'#1e293b', usePointStyle:true, pointStyleWidth:10,
            filter: item => item.label && !item.label.includes('ìƒí•œ') && !item.label.includes('í•˜í•œ')
          }
        },
        tooltip: {
          backgroundColor:'#1e293b',
          titleColor:'#e2e8f0',
          bodyColor:'#cbd5e1',
          callbacks: {
            label: ctx => {
              if (ctx.dataset.label.includes('í•˜í•œ')||ctx.dataset.label.includes('ìƒí•œ')) return null;
              return ` ${ctx.dataset.label}: $${ctx.parsed.y?.toLocaleString() ?? '--'}`;
            }
          }
        },
      },
      scales: {
        x: {
          ticks: { color:'#334155', font:{size:10}, maxRotation:45 },
          grid:  { color:'rgba(148,163,184,0.15)' },
        },
        y: {
          grace: '3%',  // ê°€ê²© ë ˆì´ë¸” í…ìŠ¤íŠ¸ ë†’ì´ë§Œí¼ë§Œ ì—¬ìœ  â€” ì—­ë™ì„± ìœ ì§€
          ticks: { color:'#334155', font:{size:10}, callback: v => `$${v.toLocaleString()}` },
          grid:  { color:'rgba(148,163,184,0.2)' },
        }
      }
    }
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¯¼ê°ë„ íƒ­ 4ê°œ ì°¨íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// OLS ê¸°ë³¸ SENS ê°’ (ë¹„êµ ê¸°ì¤€)
const DEFAULT_SENS = { bz:16.81, et:6.13, bd:20.48, an:7.87, sm:14.75, nap:6.52, pr:4.18 };

// í’ˆëª©ë³„ RÂ² (íšŒê·€ëª¨ë¸ ì í•©ë„)
const SENS_R2 = { NAP:0.89, BZ:0.74, ET:0.62, SM:0.71, BD:0.58, AN:0.53, PR:0.61, ABS_Mkt:0.67, ABS_Gap:0.21, SM_Cost:0.78 };

// í’ˆëª© ìƒ‰ìƒ
const SENS_COLORS = { NAP:'#64748b', BZ:'#a855f7', ET:'#10b981', SM:'#3b82f6', BD:'#f97316', AN:'#7c3aed', PR:'#06b6d4' };

function renderSensCharts() {
  renderSensHeatmap();
  renderSensContrib();
  renderSensR2Gauges();
  renderSensBeforeAfter();
}

// â‘  íˆíŠ¸ë§µ
function renderSensHeatmap() {
  const el = document.getElementById('sens-heatmap');
  if (!el) return;

  const items = [
    { key:'nap', label:'NAP', color:SENS_COLORS.NAP },
    { key:'bz',  label:'BZ',  color:SENS_COLORS.BZ  },
    { key:'et',  label:'ET',  color:SENS_COLORS.ET  },
    { key:'sm',  label:'SM',  color:SENS_COLORS.SM  },
    { key:'bd',  label:'BD',  color:SENS_COLORS.BD  },
    { key:'an',  label:'AN',  color:SENS_COLORS.AN  },
    { key:'pr',  label:'PR',  color:SENS_COLORS.PR  },
  ];
  // WTI êµ¬ê°„ $50~$100 $5 ë‹¨ìœ„
  const wtiRange = [50,55,60,65,70,75,80,85,90,95,100];

  // í—¤ë”
  const header = `<tr><th class="px-3 py-2 bg-slate-700 text-white border border-slate-600 text-center font-bold">ì›ë£Œ</th><th class="px-3 py-2 bg-slate-700 text-white border border-slate-600 text-center font-bold">ë¯¼ê°ë„<br>($/mt per $1)</th>${wtiRange.map(w=>`<th class="px-2 py-2 bg-slate-700 text-white border border-slate-600 text-center font-bold">$${w}</th>`).join('')}</tr>`;

  const maxSens = Math.max(...items.map(i => SENS[i.key]||0));

  const bodyRows = items.map(item => {
    const s   = SENS[item.key] || 0;
    const pct = (s / maxSens * 100).toFixed(0);
    const sensCell = `<td class="px-3 py-2 text-center font-black border border-slate-200" style="color:${item.color}">${s >= 0 ? '+' : ''}$${s.toFixed(2)}</td>`;
    // í˜„ì¬ WTI ê¸°ì¤€ ê° êµ¬ê°„ ê°€ê²©
    const priceCells = wtiRange.map(w => {
      const dWti = w - G.wti_rt;
      const price = Math.round((G[item.key] || 0) + dWti * s);
      // ìƒ‰ìƒ ê°•ë„: ë¯¼ê°ë„ ë†’ì„ìˆ˜ë¡ ì§„í•˜ê²Œ
      const intensity = Math.min(1, s / maxSens);
      const r = Math.round(255 - intensity * 120);
      const g = Math.round(255 - intensity * 60);
      const b = Math.round(255 - intensity * 20);
      const bg = `rgb(${r},${g},${b})`;
      const tx = intensity > 0.6 ? '#7f1d1d' : '#334155';
      return `<td class="px-2 py-2 text-center font-bold border border-slate-200 whitespace-nowrap" style="background:${bg};color:${tx}">$${price}</td>`;
    }).join('');
    return `<tr><td class="px-3 py-2 font-black border border-slate-200 text-center" style="color:${item.color}">${item.label}</td>${sensCell}${priceCells}</tr>`;
  }).join('');

  el.innerHTML = `<thead>${header}</thead><tbody>${bodyRows}</tbody>`;
}

// â‘¡ ABS ì›ê°€ ê¸°ì—¬ ë¶„í•´
function renderSensContrib() {
  const canvas = document.getElementById('sens-contrib-chart');
  if (!canvas) return;
  const newCanvas = canvas.cloneNode(true);
  canvas.parentNode.replaceChild(newCanvas, canvas);

  // WTI $1 ìƒìŠ¹ ì‹œ ABS ì›ê°€ ê¸°ì—¬: SMÃ—ABS_R.smÃ—(SM_COST.bzÃ—SENS.bz + SM_COST.etÃ—SENS.et) ë“±
  const smContrib = (SM_COST.bz * SENS.bz + SM_COST.et * SENS.et + SM_COST.nap * SENS.nap) * ABS_R.sm;
  const anContrib = SENS.an * ABS_R.an;
  const bdContrib = SENS.bd * ABS_R.bd;
  const total     = smContrib + anContrib + bdContrib;

  sensContribChart = new Chart(newCanvas, {
    type: 'bar',
    data: {
      labels: ['SM ê¸°ì—¬', 'AN ê¸°ì—¬', 'BD ê¸°ì—¬', 'í•©ê³„ (ABS ì›ê°€ ìƒìŠ¹)'],
      datasets: [{
        data: [
          parseFloat(smContrib.toFixed(2)),
          parseFloat(anContrib.toFixed(2)),
          parseFloat(bdContrib.toFixed(2)),
          parseFloat(total.toFixed(2)),
        ],
        backgroundColor: ['rgba(59,130,246,0.8)','rgba(124,58,237,0.8)','rgba(249,115,22,0.8)','rgba(16,185,129,0.85)'],
        borderColor:     ['#2563eb','#7c3aed','#ea580c','#059669'],
        borderWidth: 2,
        borderRadius: 8,
        datalabels: {
          display: true,
          anchor: 'end', align: 'top',
          color: '#1e293b',
          font: { size: 12, weight: 'bold' },
          formatter: v => '+$' + v,
        }
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: { display: true },
        tooltip: { callbacks: { label: ctx => ` WTI +$1 â†’ ABS ì›ê°€ +$${ctx.parsed.y}` } }
      },
      scales: {
        x: { ticks:{ color:'#334155', font:{size:11} }, grid:{ color:'rgba(148,163,184,0.15)' } },
        y: { beginAtZero:true, ticks:{ color:'#334155', callback: v => '+$'+v }, grid:{ color:'rgba(148,163,184,0.2)' },
             title:{ display:true, text:'ABS ì›ê°€ ë³€í™” ($/mt)', color:'#64748b', font:{size:11} } }
      }
    }
  });
}

// â‘¢ RÂ² ê²Œì´ì§€
function renderSensR2Gauges() {
  const el = document.getElementById('sens-r2-gauges');
  if (!el) return;

  const items = [
    { label:'NAP', r2:SENS_R2.NAP, color:SENS_COLORS.NAP },
    { label:'BZ',  r2:SENS_R2.BZ,  color:SENS_COLORS.BZ  },
    { label:'ET',  r2:SENS_R2.ET,  color:SENS_COLORS.ET  },
    { label:'SM',  r2:SENS_R2.SM,  color:SENS_COLORS.SM  },
    { label:'BD',  r2:SENS_R2.BD,  color:SENS_COLORS.BD  },
    { label:'AN',  r2:SENS_R2.AN,  color:SENS_COLORS.AN  },
    { label:'ABS Mkt', r2:SENS_R2.ABS_Mkt, color:'#10b981' },
    { label:'ABS Gap', r2:SENS_R2.ABS_Gap, color:'#ef4444' },
  ];

  el.innerHTML = items.map(item => {
    const pct  = (item.r2 * 100).toFixed(0);
    const tier = item.r2 >= 0.7 ? { label:'ë†’ìŒ', bg:'#bbf7d0', tx:'#065f46' }
               : item.r2 >= 0.5 ? { label:'ë³´í†µ', bg:'#fef9c3', tx:'#713f12' }
               :                  { label:'ë‚®ìŒ', bg:'#fecaca', tx:'#7f1d1d' };
    return `<div class="bg-white rounded-xl border border-slate-200 p-3 text-center">
      <div class="font-black text-sm mb-1" style="color:${item.color}">${item.label}</div>
      <div class="text-2xl font-black mb-1" style="color:${item.color}">RÂ²=${item.r2}</div>
      <div class="w-full h-3 rounded-full bg-slate-200 overflow-hidden mb-2">
        <div class="h-full rounded-full transition-all duration-700" style="width:${pct}%;background:${item.color}"></div>
      </div>
      <div class="text-xs font-bold rounded px-2 py-0.5 inline-block" style="background:${tier.bg};color:${tier.tx}">${tier.label} â€” WTI ì„¤ëª…ë ¥ ${pct}%</div>
    </div>`;
  }).join('');
}

// ABS ì›ê°€ ê³„ì‚° í—¬í¼ (ë¯¼ê°ë„ Before/After ê³µìš©)
function calcAbsCost(sens, w) {
  const dWti = w - G.wti_rt;
  const smC  = (G.sm_act + dWti * sens.sm) * ABS_R.sm;
  const anC  = (G.an     + dWti * sens.an) * ABS_R.an;
  const bdC  = (G.bd     + dWti * sens.bd) * ABS_R.bd;
  return Math.round(smC + anC + bdC);
}

// â‘£ Before/After ì‹œë®¬
function renderSensBeforeAfter() {
  const wti    = parseFloat(document.getElementById('sens-ba-slider')?.value || 67);
  const wtiEl  = document.getElementById('sens-ba-wti');
  if (wtiEl) wtiEl.textContent = '$' + wti;

  // KPI ì¹´ë“œ ì—…ë°ì´íŠ¸
  const beforeCost = calcAbsCost(DEFAULT_SENS, wti);
  const afterCost  = calcAbsCost(SENS, wti);
  const diff       = afterCost - beforeCost;
  const diffPct    = ((diff / beforeCost) * 100).toFixed(1);

  const baBeforeEl = document.getElementById('ba-before');
  const baAfterEl  = document.getElementById('ba-after');
  const baDiffEl   = document.getElementById('ba-diff');
  const baDiffPctEl= document.getElementById('ba-diff-pct');
  if (baBeforeEl) baBeforeEl.textContent = '$' + beforeCost;
  if (baAfterEl)  baAfterEl.textContent  = '$' + afterCost;
  if (baDiffEl) {
    baDiffEl.textContent = (diff >= 0 ? '+' : '') + '$' + diff;
    baDiffEl.className   = 'text-2xl font-black ' + (diff > 0 ? 'text-red-600' : diff < 0 ? 'text-emerald-600' : 'text-slate-700');
  }
  if (baDiffPctEl) baDiffPctEl.textContent = (diff >= 0 ? '+' : '') + diffPct + '%';

  const canvas = document.getElementById('sens-ba-chart');
  if (!canvas) return;
  const newCanvas = canvas.cloneNode(true);
  canvas.parentNode.replaceChild(newCanvas, canvas);

  // WTI êµ¬ê°„ $50~$100 $5 ë‹¨ìœ„
  const wtiRange = [50,55,60,65,70,75,80,85,90,95,100];

  const currentCosts = wtiRange.map(w => calcAbsCost(SENS, w));
  const defaultCosts = wtiRange.map(w => calcAbsCost(DEFAULT_SENS, w));
  const currentWtiIdx = wtiRange.findIndex(w => w >= wti);

  sensBaChart = new Chart(newCanvas, {
    type: 'line',
    data: {
      labels: wtiRange.map(w => '$'+w),
      datasets: [
        {
          label: 'í˜„ì¬ ë¯¼ê°ë„ ì„¤ì •',
          data: currentCosts,
          borderColor: 'rgba(239,68,68,0.9)',
          backgroundColor: 'rgba(239,68,68,0.1)',
          fill: false,
          tension: 0.4,
          borderWidth: 2.5,
          pointRadius: wtiRange.map((w,i) => Math.abs(w-wti)<3 ? 8 : 4),
          pointBackgroundColor: wtiRange.map(w => Math.abs(w-wti)<3 ? '#ef4444' : 'rgba(239,68,68,0.6)'),
          pointBorderColor: '#fff', pointBorderWidth: 2,
          datalabels: {
            display: (ctx) => Math.abs(wtiRange[ctx.dataIndex]-wti)<3,
            anchor:'end', align:'top',
            color:'#ef4444', font:{size:11,weight:'bold'},
            formatter: v => 'í˜„ì¬ $'+v,
          }
        },
        {
          label: 'OLS ê¸°ë³¸ê°’',
          data: defaultCosts,
          borderColor: 'rgba(59,130,246,0.9)',
          backgroundColor: 'rgba(59,130,246,0.1)',
          fill: false,
          tension: 0.4,
          borderWidth: 2.5,
          borderDash: [5,4],
          pointRadius: wtiRange.map(w => Math.abs(w-wti)<3 ? 8 : 4),
          pointBackgroundColor: wtiRange.map(w => Math.abs(w-wti)<3 ? '#3b82f6' : 'rgba(59,130,246,0.6)'),
          pointBorderColor: '#fff', pointBorderWidth: 2,
          datalabels: {
            display: (ctx) => Math.abs(wtiRange[ctx.dataIndex]-wti)<3,
            anchor:'end', align:'bottom',
            color:'#3b82f6', font:{size:11,weight:'bold'},
            formatter: v => 'OLS $'+v,
          }
        },
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: {
        legend:{ display:true, position:'top', labels:{font:{size:11},color:'#334155'} },
        datalabels:{ display:false },
        tooltip:{ callbacks:{ label: ctx => ` ${ctx.dataset.label}: $${ctx.parsed.y}` } }
      },
      scales: {
        x:{ ticks:{color:'#334155',font:{size:11}}, grid:{color:'rgba(148,163,184,0.15)'} },
        y:{ ticks:{color:'#334155',callback:v=>'$'+v}, grid:{color:'rgba(148,163,184,0.2)'},
            title:{display:true,text:'ABS ì›ê°€ ($/mt)',color:'#64748b',font:{size:11}} }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í¬ë˜ì»¤ë§ˆì§„ 9ì£¼ íˆìŠ¤í† ë¦¬ ì°¨íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// xlsxì—ì„œ ì¶”ì¶œí•œ ì£¼ì°¨ë³„ í¬ë˜ì»¤ë§ˆì§„ ê¸°ì—¬ë„ (ETÃ—0.30, PRÃ—0.15, BDÃ—0.045, BZÃ—0.06)
const CRACKER_HISTORY = [
  { week:'12/29', et:224, pr:111, bd:43, bz:40, nap:530, margin:-162 },
  { week:'01/05', et:223, pr:112, bd:46, bz:40, nap:536, margin:-167 },
  { week:'01/12', et:218, pr:116, bd:52, bz:42, nap:557, margin:-180 },
  { week:'01/19', et:213, pr:119, bd:54, bz:45, nap:560, margin:-179 },
  { week:'01/26', et:210, pr:123, bd:57, bz:46, nap:584, margin:-197 },
  { week:'02/02', et:209, pr:124, bd:57, bz:46, nap:594, margin:-208 },
  { week:'02/09', et:210, pr:124, bd:57, bz:46, nap:607, margin:-219 },
  { week:'02/16', et:212, pr:125, bd:57, bz:46, nap:600, margin:-211 },
  { week:'02/23', et:212, pr:125, bd:57, bz:47, nap:623, margin:-232 },
];

let crackerHistChart = null;

function renderCrackerHistoryChart() {
  const canvas = document.getElementById('cracker-history-chart');
  if (!canvas) return;

  // canvas ì¬ìƒì„±
  const newCanvas = canvas.cloneNode(true);
  canvas.parentNode.replaceChild(newCanvas, canvas);

  const labels = CRACKER_HISTORY.map(d => d.week);

  const datasets = [
    {
      label: 'ET ê¸°ì—¬',
      data: CRACKER_HISTORY.map(d => d.et),
      borderColor: 'rgba(16,185,129,1)',
      backgroundColor: 'rgba(16,185,129,0.4)',
      fill: true,
      stack: 'contrib',
      tension: 0.35,
      pointRadius: 3,
      borderWidth: 2,
      order: 2,
      datalabels: { display: false },
    },
    {
      label: 'PR ê¸°ì—¬',
      data: CRACKER_HISTORY.map(d => d.pr),
      borderColor: 'rgba(59,130,246,1)',
      backgroundColor: 'rgba(59,130,246,0.4)',
      fill: true,
      stack: 'contrib',
      tension: 0.35,
      pointRadius: 3,
      borderWidth: 2,
      order: 2,
      datalabels: { display: false },
    },
    {
      label: 'BD ê¸°ì—¬',
      data: CRACKER_HISTORY.map(d => d.bd),
      borderColor: 'rgba(249,115,22,1)',
      backgroundColor: 'rgba(249,115,22,0.4)',
      fill: true,
      stack: 'contrib',
      tension: 0.35,
      pointRadius: 3,
      borderWidth: 2,
      order: 2,
      datalabels: { display: false },
    },
    {
      label: 'BZ ê¸°ì—¬',
      data: CRACKER_HISTORY.map(d => d.bz),
      borderColor: 'rgba(168,85,247,1)',
      backgroundColor: 'rgba(168,85,247,0.4)',
      fill: true,
      stack: 'contrib',
      tension: 0.35,
      pointRadius: 3,
      borderWidth: 2,
      order: 2,
      datalabels: { display: false },
    },
    {
      label: 'ìˆœë§ˆì§„',
      data: CRACKER_HISTORY.map(d => d.margin),
      borderColor: '#1e293b',
      backgroundColor: 'transparent',
      fill: false,
      borderWidth: 2.5,
      borderDash: [5, 4],
      pointRadius: 5,
      pointBackgroundColor: CRACKER_HISTORY.map(d => d.margin >= 0 ? '#10b981' : '#ef4444'),
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.3,
      order: 1,
      datalabels: {
        display: true,
        anchor: 'end',
        align: d => CRACKER_HISTORY[d.dataIndex].margin >= 0 ? 'top' : 'bottom',
        color: d => CRACKER_HISTORY[d.dataIndex].margin >= 0 ? '#10b981' : '#ef4444',
        font: { size: 10, weight: 'bold' },
        formatter: v => v != null ? (v >= 0 ? '+' : '') + '$' + Math.round(v) : '',
      },
    },
  ];

  crackerHistChart = new Chart(newCanvas, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode:'index', intersect:false },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: { font:{size:11}, color:'#1e293b', usePointStyle:true, pointStyleWidth:10 }
        },
        tooltip: {
          backgroundColor: '#1e293b',
          titleColor: '#e2e8f0',
          bodyColor: '#cbd5e1',
          callbacks: {
            label: ctx => {
              const v = ctx.parsed.y;
              return ` ${ctx.dataset.label}: ${v >= 0 ? '+' : ''}$${Math.round(v)}`;
            }
          }
        },
        datalabels: { display: false },
      },
      scales: {
        x: {
          stacked: true,
          ticks: { color:'#334155', font:{size:11} },
          grid: { color:'rgba(148,163,184,0.15)' },
        },
        y: {
          stacked: true,
          ticks: { color:'#334155', font:{size:10}, callback: v => '$'+v },
          grid: { color:'rgba(148,163,184,0.2)' },
          title: { display:true, text:'$/mt', color:'#64748b', font:{size:11} }
        }
      }
    }
  });

  // ì£¼ì°¨ë³„ ìš”ì•½ ì¹´ë“œ ë Œë”ë§
  const summaryEl = document.getElementById('cracker-history-summary');
  if (summaryEl) {
    summaryEl.innerHTML = CRACKER_HISTORY.map(d => {
      const color = d.margin >= 0 ? 'text-emerald-700' : d.margin > -100 ? 'text-amber-700' : 'text-red-700';
      const bg    = d.margin >= 0 ? 'bg-emerald-50 border-emerald-200' : d.margin > -100 ? 'bg-amber-50 border-amber-200' : 'bg-red-50 border-red-200';
      return `<div class="rounded-lg border ${bg} p-2 text-center">
        <div class="text-slate-600 font-bold">${d.week}</div>
        <div class="font-black ${color} text-sm">${d.margin >= 0 ? '+' : ''}$${d.margin}</div>
        <div class="text-slate-500 text-xs mt-0.5">NAP $${d.nap}</div>
      </div>`;
    }).join('');
  }
}

// ì´ˆê¸°í™”
updateDashboard();
loadCSV();
setInterval(loadCSV, 30000);
setInterval(refreshImg, 300000);
</script>
</body>
</html>
